<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="fanlychie,范忠云,範宗雲,java,技术,博客"><meta name="baidu-site-verification" content="bQjF64X3Ym"><meta name="keywords" content="fanlychie,范忠云,java,技术,博客,spring,mvc,cloud"><title>Spring Cloud Eureka — 服务发现 | 範宗雲</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Cloud Eureka — 服务发现</h1><a id="logo" href="/.">範宗雲</a><p class="description">面朝大海，望眼欲穿</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入搜索关键字 ..."></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Spring Cloud Eureka — 服务发现</h1><div class="post-meta"><span class="date">2017-06-21</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i> Hits</i></i></span><a href="/post/spring-cloud-netflix-eureka.html#comments" class="comment-count"><i id="changyan_parti_unit" data-xid="post/spring-cloud-netflix-eureka.html"></i>留言</a></div><div class="post-content"><p>Spring Cloud 是一套基于 Spring Boot 实现的微服务开发工具。微服务（也称微服务架构），简单的说，就是将一个系统按照一定的规则有效的拆分成多个不同的服务，每个服务都能够独立的进行开发、部署、扩展和维护。服务与服务之间可以通过 RESTful API 等方式进行相互调用。</p>
<p>Spring Cloud 没有重复制造轮子，它只是将业界内多个开源的微服务框架集成起来，再通过 Spring Boot 进行包装屏蔽掉了复杂的配置和实现原理，目的是给开发者予一套简单易懂、易部署和易维护的分布式系统开发工具包。它提供了微服务开发所需的配置管理、服务发现、断路器、智能路由、微代理、控制总线等组件。</p>
<a id="more"></a>
<h2 id="1-Eureka"><a href="#1-Eureka" class="headerlink" title="1. Eureka"></a>1. Eureka</h2><p>Eureka 是一种基于 REST 的服务，主要用于定位服务，以实现中间层服务器的负载均衡和故障转移。它是由 Spring Cloud Netflix（Spring Cloud 的子项目） 项目提供的。</p>
<h3 id="1-1-Spring-Cloud-Netflix"><a href="#1-1-Spring-Cloud-Netflix" class="headerlink" title="1.1 Spring Cloud Netflix"></a>1.1 Spring Cloud Netflix</h3><p>它主要是对 Netflix 开源的一系列产品进行包装，为 Spring Boot 应用程序提供自动配置的 Netflix OSS 集成。通过一些简单的注解，就能快速启用并构建大型的分布式系统。它提供的模块有：<br>服务发现（Eureka）、断路器（Hystrix）、智能路由（Zuul）、客户端负载均衡（Ribbon）。</p>
<h3 id="1-2-样例项目结构"><a href="#1-2-样例项目结构" class="headerlink" title="1.2 样例项目结构"></a>1.2 样例项目结构</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-sample-structure.png" alt=""></p>
<h3 id="1-3-服务注册中心"><a href="#1-3-服务注册中心" class="headerlink" title="1.3 服务注册中心"></a>1.3 服务注册中心</h3><p>在 pom.xml 中声明使用<code>spring-cloud-starter-eureka-server</code>启动器（本示例对应的项目是<code>eureka-server</code>）：</p>
<p></p><p class="code-title">pom.xml</p><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<p>使用<code>@EnableEurekaServer</code>注解将应用声明为 Eureka 服务器端（Eureka Server），从而启动 Eureka 服务注册中心的组件，对外提供服务注册和发现的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableEurekaServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在默认的模式中，Eureka 服务器端也充当客户端并向给定的 serviceUrl 注册自己。在生产环境中，我们通常会有多台服务器端应用，但是为了简单起见，本示例使用单台服务器，因此需要禁掉 Eureka 服务器端应用的客户端行为：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8761</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></div></pre></td></tr></table></figure><p></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th style="text-align:center">默认值</th>
<th>简述</th>
</tr>
</thead>
<tbody>
<tr>
<td>eureka.instance.hostname</td>
<td style="text-align:center">-</td>
<td>实例的主机名。</td>
</tr>
<tr>
<td>eureka.client.register-with-eureka</td>
<td style="text-align:center">true</td>
<td>该实例是否向 Eureka 服务器注册自己，以供外部应用发现自己。在某些情况下，你可能不希望当前的应用被外部的其他应用发现，而只是想从服务器发现其他服务的实例，此时你可以将此值设为 false。</td>
</tr>
<tr>
<td>eureka.client.fetch-registry</td>
<td style="text-align:center">true</td>
<td>该实例是否向 Eureka 服务器获取所有的注册信息表。</td>
</tr>
<tr>
<td>eureka.client.service-url.defaultZone</td>
<td style="text-align:center">-</td>
<td>该实例与 Eureka 服务器通讯的 URL 地址列表。如果 Eureka 服务器地址不止一个，则使用英文的逗号分隔。</td>
</tr>
</tbody>
</table>
<p>Eureka 服务器默认监听 8761 端口来接收服务注册，除此之外它还提供一个可视化的直观页面，可以方便的查看注册的服务。启动<code>EurekaServerApplication</code>，访问：<code>http://localhost:8761/</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-1.png" alt=""></p>
<p>从上图可以看到，此时还没有任何服务注册到 Eureka 服务器。</p>
<h3 id="1-4-客户端（服务提供者）"><a href="#1-4-客户端（服务提供者）" class="headerlink" title="1.4 客户端（服务提供者）"></a>1.4 客户端（服务提供者）</h3><p>在 pom.xml 中声明使用<code>spring-cloud-starter-eureka</code>启动器（本示例对应的项目是<code>order-service</code>）：</p>
<p></p><p class="code-title">pom.xml</p><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<p>使用<code>@EnableEurekaClient</code>或<code>@EnableDiscoveryClient</code>注解可以将应用声明为 Eureka 客户端（Eureka Client）。当客户端向 Eureka 服务器注册时，它会提供关于自身的一些元数据，例如主机和端口，健康指示符 URL，主页等信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableEurekaClient</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceApplication</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除此之外，还需要配置才能找到 Eureka 服务器：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8881</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order-service</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></div></pre></td></tr></table></figure><p></p>
<p><code>spring.application.name</code>是 Eureka 客户端向服务器注册的服务ID和虚拟主机的名称。在 Eureka 服务器中，服务ID相同的实例将集群在一起。<br>启动<code>OrderServiceApplication</code>，再次访问：<code>http://localhost:8761/</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-2.png" alt=""></p>
<p>从上图可以看到，客户端应用程序已经成功被注册了。</p>
<h3 id="1-5-高可用"><a href="#1-5-高可用" class="headerlink" title="1.5 高可用"></a>1.5 高可用</h3><p>以上示例都是单点运行的，不适合于生产环境。<a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance#high-level-architecture" target="_blank" rel="external">Eureka</a> 官方给出的应用部署架构图是这样的：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/eureka-architecture.png" alt=""></p>
<p>下面对这个架构图来作一些解读，希望能帮助你更好的理解。</p>
<p><strong>1．Region 和 Zone</strong><br>在 Eureka 中有 Region（区域）和 Zone（Availability Zone，可用区）的区分。<br>这是由于 Netflix 开源的 Eureka 旨在 AWS（Amazon Web Services，现在通常称为云计算）中运行，因此使用了一些 AWS 特有的概念术语。<br>在非 AWS 的环境下，我们可以简单的将 Region 理解成大区或地域（如阿里云服务器的华南、华北地区），Zone 可以简单的理解成机房。如需了解更多相关信息，可参考：<a href="http://blog.csdn.net/awschina/article/details/17639191" target="_blank" rel="external">AWS的区域和可用区概念解释</a>。<br>上图是一个 Eureka 集群的部署架构图，它面有 3 个 Zone（us-east-1c、us-east-1d、us-east-1e），它们都属于 us-east-1 这个 Region。</p>
<p><strong> 2．Eureka Server </strong><br>每个 Zone 至少有一个 Eureka Server，能够对外提供服务发现和处理区域故障。<br>在 Eureka Server 集群中（<code>eureka.client.register-with-eureka</code>不能设置为 false），没有 Master/Slave 的区分，每个 Eureka Server 都是对等（Peer）的。它们除了可以作为服务注册中心外还可以充当客户端向其他 Eureka Server 注册自己，并且会从它的对等的节点（由<code>eureka.client.service-url.defaultZone</code>配置指定）中 Replicate（复制）所有的服务注册表信息以达到同步的目的，如果因为某种原因导致同步失败，默认等待 5 分钟（可以通过<code>eureka.server.wait-time-in-ms-when-sync-empt</code>配置），在这期间，它不向客户端提供服务注册信息。并且默认失败重试 5 次（可以通过<code>eureka.server.number-of-replication-retries</code>配置）。</p>
<p><strong> 3．Eureka Client </strong><br>Eureka 客户端应用分两种，Applicaton Service（服务提供者）和 Application Client（服务消费者）。<br>Applicaton Service（服务提供者）通常需要向给定的 serviceUrl 对应的 Eureka Server 来 Register（注册）自己，以供外部应用可以发现自己。其注册信息包含主机名和端口信息等元数据。然后默认以每隔 30 秒的频率向注册的 Eureka Server 发送一次心跳（可以通过<code>eureka.instance.lease-renewal-interval-in-seconds</code>配置）来 Renew（续约）服务。<br>Eureka Server 默认为 90 秒内如果没有收到客户端的心跳，则它会将该客户端实例从它的注册表中剔除，以禁止该实例的流量（可以通过<code>eureka.instance.lease-expiration-duration-in-seconds</code>配置。注意，如果该值设置的太大，即使实例已经不存在了，流量也可以路由到该实例；如果设置的太小，很可能因为网络问题导致实例被服务器剔除；该值至少应该比发送心跳频率的间隔值要大）。<br>Eureka 客户端默认会从注册的 Eureka Server 中获取所有的服务注册表信息（可以通过<code>eureka.client.fetch-registry</code>配置），默认是以每隔 30 秒的频率去 Get Registry（获取注册表） 一次（可以通过<code>eureka.client.registry-fetch-interval-seconds</code>配置）。<br>Application Client（服务消费者）可以不向任何 Eureka Server 注册自己，它可以只从 Eureka Server 获取注册过的服务列表，通过 RESTful API 的方式远程调用 Applicaton Service（服务提供者）。</p>
<h4 id="1-5-1-Eureka-Server-高可用样例"><a href="#1-5-1-Eureka-Server-高可用样例" class="headerlink" title="1.5.1 Eureka Server 高可用样例"></a>1.5.1 Eureka Server 高可用样例</h4><p>本示例是在同一主机运行多个 Eureka Server 实例，由于 Eureka 会过滤同一主机的相同主机名（详见<code>com.netflix.eureka.cluster.PeerEurekaNodes#isThisMyUrl</code>），但是它不检查端口，因此需要先行定义至少两个不同的主机名，并使它们映射到<code>127.0.0.1</code>。<br>这里采用修改 hosts 文件的方式。Windows 操作系统的 hosts 文件路径是<code>C:\Windows\System32\drivers\etc\hosts</code>。找到并打开系统的 hosts 文件，在最后添加如下行：</p>
<p></p><p class="code-title">hosts</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">peer1</span> <span class="string">peer2</span> <span class="string">peer3</span></div></pre></td></tr></table></figure><p></p>
<p>修改<code>eureka-server</code>项目的配置文件：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">eureka-server</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">peer1</span></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    <span class="string">com.netflix.eureka:</span> <span class="string">'off'</span></div><div class="line">    <span class="string">com.netflix.discovery:</span> <span class="string">'off'</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">peer1</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8761</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">peer1</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer2:8762/eureka/,http://peer3:8763/eureka/</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">peer2</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8762</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">peer2</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer3:8763/eureka/</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">peer3</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8763</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">peer3</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer2:8762/eureka/</span></div></pre></td></tr></table></figure><p></p>
<p>这里配置了 3 个 Eureka Server 实例，每个实例与其他两个实例分别进行两两的相互注册，关系如图示：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/ES-2.png" alt=""></p>
<p>需要注意的是，Eureka Server 的服务注册信息不能进行二次传播。如下图的实例关系配置是不可取的：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/ES-1.png" alt=""></p>
<p>此图的每个 Eureka Server 实例是单向的向另外一个实例注册，假如现有一个新的客户端实例 C 向 1 注册，那么，1 和 2 中都会有 C 的注册信息，但是 3 中是没有 C 的注册信息的（详见<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#replicateToPeers</code>）。</p>
<p>启动 3 个 Eureka Server 实例：</p>
<p></p><p class="code-title">cmd</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动 peer1 实例</span></div><div class="line"><span class="string">&gt; java -jar eureka-server-0.0.1-SNAPSHOT.jar</span></div><div class="line"># 启动 peer2 实例</div><div class="line">&gt; java -jar -Dspring.profiles.active=peer2 eureka-server-0.0.1-SNAPSHOT.jar</div><div class="line"># 启动 peer3 实例</div><div class="line">&gt; java -jar -Dspring.profiles.active=peer3 eureka-server-0.0.1-SNAPSHOT.jar</div></pre></td></tr></table></figure><p></p>
<h4 id="1-5-2-Eureka-Client-高可用样例"><a href="#1-5-2-Eureka-Client-高可用样例" class="headerlink" title="1.5.2 Eureka Client 高可用样例"></a>1.5.2 Eureka Client 高可用样例</h4><p>修改<code>order-service</code>项目的配置文件：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order-service</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">client1</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">client1</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8881</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">client2</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8882</span></div></pre></td></tr></table></figure><p></p>
<p>客户端的<code>eureka.client.service-url.defaultZone</code>指定为当前 Zone 中任意一台服务注册中心的地址就可以，因为上例中配置的每台服务注册中心的服务注册表是两两相互进行复制的。</p>
<p>启动 2 个 Eureka Client 实例：</p>
<p></p><p class="code-title">cmd</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动 client1 实例</span></div><div class="line"><span class="string">&gt; java -jar order-service-0.0.1-SNAPSHOT.jar</span></div><div class="line"># 启动 client2 实例</div><div class="line">&gt; java -jar -Dspring.profiles.active=client2 order-service-0.0.1-SNAPSHOT.jar</div></pre></td></tr></table></figure><p></p>
<p>重新刷新<code>http://localhost:8761/</code>：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-3.png" alt=""></p>
<h3 id="1-6-自我保护模式"><a href="#1-6-自我保护模式" class="headerlink" title="1.6 自我保护模式"></a>1.6 自我保护模式</h3><p>Eureka 默认开启了自我保护模式（可以通过<code>eureka.server.enable-self-preservation</code>配置）。该模式被激活的条件是：在 1 分钟后，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>。你可以在 Eureka Server 首页的右上侧可以看到：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-part.png" alt=""></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>简述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Renews threshold</td>
<td>Eureka Server 期望每分钟收到客户端实例续约的总数</td>
</tr>
<tr>
<td>Renews (last min)</td>
<td>Eureka Server 最后 1 分钟收到客户端实例续约的总数</td>
</tr>
</tbody>
</table>
<p><strong> 1．服务器端续约阀值的计算源码（Renews threshold） </strong></p>
<p></p><p class="code-title">com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#openForTraffic</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.expectedNumberOfRenewsPerMin = count * <span class="number">2</span>;</div><div class="line"><span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div></pre></td></tr></table></figure><p></p>
<p>其中，count 为 服务器的数量。数值 2 表示每 30 秒 1 个心跳，每分钟 2 个心跳的固定频率因子。</p>
<p>归纳公式：<code>2M * renewalPercentThreshold</code>。其中，M 为服务器的个数，计算结果只保留整数位。</p>
<p>renewalPercentThreshold 默认是 0.85（可以通过<code>eureka.server.renewal-percent-threshold</code>配置）。</p>
<p>其实这就是个固定值，因为对于每个 Eureka Server 来说，M 只能取 1。这段代码达到的效果是：</p>
<p>1．expectedNumberOfRenewsPerMin 重置为固定值 2；<br>2．numberOfRenewsPerMinThreshold 的值被设置为 1；</p>
<p><strong> 2．客户端续约阀值的计算源码（Renews threshold） </strong></p>
<p></p><p class="code-title">com.netflix.eureka.registry.AbstractInstanceRegistry#register</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</div><div class="line">    <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p>注：上面贴出的 PeerAwareInstanceRegistryImpl 继承自 AbstractInstanceRegistry。<br>它们共享 expectedNumberOfRenewsPerMin 和 numberOfRenewsPerMinThreshold 属性，具体可自行翻阅源码。</p>
<p>设有 N 个客户端，服务器端先启动，expectedNumberOfRenewsPerMin 被重置为固定值 2。接着客户端依次启动：</p>
<p><code>N = 1</code>–&gt;<code>(2 + 2) * renewalPercentThreshold</code><br><code>N = 2</code>–&gt;<code>(2 + 2 + 2) * renewalPercentThreshold</code><br><code>N = 3</code>–&gt;<code>(2 + 2 + 2 + 2) * renewalPercentThreshold</code></p>
<p>归纳公式：<code>2(N + 1) * renewalPercentThreshold</code>，计算结果只保留整数位。</p>
<p>即，如果只有 1 个 Eureka Server 或者有多个 Eureka Server 但它们之间没有相互注册：</p>
<p>当 N = 0 时，只计算服务器端。<code>Renews threshold</code>= 1。由于没有客户端向服务器发送心跳，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>，Eureka 自我保护模式被激活；</p>
<p>当 N ≠ 0 时，服务器端的计算结果被客户端覆盖，即只计算客户端；</p>
<p>当 N = 2 时，<code>Renews threshold</code>= 2(N + 1) * renewalPercentThreshold = 2 * 3 * 0.85 = 5。2 个客户端以每 30 秒发送 1 个心跳，1 分钟后总共向服务器发送 4 个心跳，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>，Eureka 自我保护模式被激活；</p>
<p>所以如果 N &lt; 3，在 1 分钟后，服务器端收到的客户端实例续约的总数总是小于期望的阀值，因此 Eureka 的自我保护模式自动被激活。首页会出现警告信息：</p>
<font color="#da5985" style="margin:-12px 0 6px 0;display:block;">EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY’RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</font>

<p>这种情况下，由于 Eureka Server 没有对等的节点，同步不到服务注册信息，默认需等待 5 分钟（可以通过<code>eureka.server.wait-time-in-ms-when-sync-empty</code>配置）。即 5 分钟后你应该看到此信息。</p>
<p>为避免这种情况发生，你可以：</p>
<ul>
<li>关闭自我保护模式（<code>eureka.server.enable-self-preservation</code>设为 false）</li>
<li>降低 renewalPercentThreshold 的比例（<code>eureka.server.renewal-percent-threshold</code>设置为 0.5 以下，比如 0.49）</li>
<li>部署多个 Eureka Server 并开启其客户端行为（<code>eureka.client.register-with-eureka</code>不要设为 false，默认为 true）</li>
</ul>
<p><div style="margin-top:18px"></div>如果是采取部署多个 Eureka Server 并开启其客户端行为使其相互注册。假设有 M 个 Eureka Server，那么，每个 Eureka Server 每分钟可以额外收到 2 * (M - 1) 个心跳。例如：</p>
<p>当 M = 1，N = 2 时，<code>Renews threshold</code>= 2(N + 1) * renewalPercentThreshold = 2 * 3 * 0.85 = 5，2 个客户端以每 30 秒发送 1 个心跳，1 分钟后总共向服务器发送 4 个心跳，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>；</p>
<p>当 M = 2，N = 2 时，<code>Renews threshold</code>= 2(N + 1) * renewalPercentThreshold = 2 * 3 * 0.85 = 5，2 个客户端以每 30 秒发送 1 个心跳，1 分钟后总共向服务器发送 4 个心跳，另外还有 1 个 M 发来的 2 个心跳，总共是 6 个心跳，<code>Renews (last min)</code>&gt;<code>Renews threshold</code>；</p>
<p>Eureka 的自我保护模式是有意义的，该模式被激活后，它不会从注册列表中剔除因长时间没收到心跳导致租期过期的服务，而是等待修复，直到心跳恢复正常之后，它自动退出自我保护模式。这种模式旨在避免因网络分区故障导致服务不可用的问题。例如，两个客户端实例 C1 和 C2 的连通性是良好的，但是由于网络故障，C2 未能及时向 Eureka 发送心跳续约，这时候 Eureka 不能简单的将 C2 从注册表中剔除。因为如果剔除了，C1 就无法从 Eureka 服务器中获取 C2 注册的服务，但是这时候 C2 服务是可用的。所以，Eureka 的自我保护模式最好还是开启它。</p>
<h3 id="1-7-Eureka-与-Zookeeper-的区别"><a href="#1-7-Eureka-与-Zookeeper-的区别" class="headerlink" title="1.7 Eureka 与 Zookeeper 的区别"></a>1.7 Eureka 与 Zookeeper 的区别</h3><p>Eureka 最大程度上保证 AP（Availability，可用性；Partition-tolerance，分区容错性），而 Zookeeper 保证的是 CP（Consistency，一致性；Partition-tolerance，分区容错性）。<br>如果因为网络分区故障导致服务器（master 节点）无法与其它节点联系，对于 Zookeeper 来说，这是不能容忍的。它会对剩下的节点重新进行 leader 选举，在这期间，整个 Zookeeper 集群是不可用的，这就直接导致了所有注册服务瘫痪的现象。<br>而对于 Eureka 来说，每个节点都是对等的，失去了一个节点，就自动切换到其它节点，只要还有一个 Eureka 节点存在，就能正常对外提供注册服务。Eureka 可以很好的应对因网络分区故障而导致的部分节点失去联系的状况。</p>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring Cloud-Dalston.SR1<br>完整示例项目链接：<a href="https://github.com/fanlychie/spring-cloud-samples/tree/master/spring-cloud-netflix-eureka-sample" target="_blank" rel="external">spring-cloud-netflix-eureka-sample</a><br>参考文档文献链接：<a href="http://cloud.spring.io/spring-cloud-static/Dalston.SR1/#_spring_cloud_netflix" target="_blank" rel="external">http://cloud.spring.io/spring-cloud-static/Dalston.SR1/#_spring_cloud_netflix</a></p>
</blockquote>
</div><div class="tags"><a href="/tags/Spring-Cloud/">Spring Cloud</a></div><div class="post-share"></div><div class="post-nav"><a href="/post/spring-cloud-netflix-ribbon.html" class="pre">Spring Cloud Ribbon — 客户端负载均衡器</a><a href="/post/spring-boot-testing.html" class="next">Spring Boot Test</a></div><div id="comments"><div id="SOHUCS" sid="post/spring-cloud-netflix-eureka.html"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Eureka"><span class="toc-text">1. Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Spring-Cloud-Netflix"><span class="toc-text">1.1 Spring Cloud Netflix</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-样例项目结构"><span class="toc-text">1.2 样例项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-服务注册中心"><span class="toc-text">1.3 服务注册中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-客户端（服务提供者）"><span class="toc-text">1.4 客户端（服务提供者）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-高可用"><span class="toc-text">1.5 高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-Eureka-Server-高可用样例"><span class="toc-text">1.5.1 Eureka Server 高可用样例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-Eureka-Client-高可用样例"><span class="toc-text">1.5.2 Eureka Client 高可用样例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-自我保护模式"><span class="toc-text">1.6 自我保护模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-Eureka-与-Zookeeper-的区别"><span class="toc-text">1.7 Eureka 与 Zookeeper 的区别</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/post/resolve-dubbo-services-call-situation.html">解决 dubbo 服务之间调用的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/post/dubbo-annotation-with-springmvc.html">dubbo 注解方式整合 springmvc</a></li><li class="post-list-item"><a class="post-list-link" href="/post/dubbo-configurations.html">dubbo 配置方式</a></li><li class="post-list-item"><a class="post-list-link" href="/post/dubbo-quickstart.html">dubbo 快速入门</a></li><li class="post-list-item"><a class="post-list-link" href="/post/dubbo-admin-setup.html">dubbo-admin 管理控制台应用安装</a></li><li class="post-list-item"><a class="post-list-link" href="/post/zookeeper-setup.html">Zookeeper 安装和配置</a></li><li class="post-list-item"><a class="post-list-link" href="/post/spring-cloud-netflix-ribbon.html">Spring Cloud Ribbon — 客户端负载均衡器</a></li><li class="post-list-item"><a class="post-list-link" href="/post/spring-cloud-netflix-eureka.html">Spring Cloud Eureka — 服务发现</a></li><li class="post-list-item"><a class="post-list-link" href="/post/spring-boot-testing.html">Spring Boot Test</a></li><li class="post-list-item"><a class="post-list-link" href="/post/spring-boot-servlet-filter-listener-usage.html">Spring Boot 使用 Servlet、Filter、Listener</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/JPA/" style="font-size: 15px;">JPA</a> <a href="/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/tags/开发工具包/" style="font-size: 15px;">开发工具包</a> <a href="/tags/Dubbo/" style="font-size: 15px;">Dubbo</a> <a href="/tags/Eclipse/" style="font-size: 15px;">Eclipse</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Java8/" style="font-size: 15px;">Java8</a> <a href="/tags/CAS/" style="font-size: 15px;">CAS</a> <a href="/tags/工具类/" style="font-size: 15px;">工具类</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/Jenkins/" style="font-size: 15px;">Jenkins</a> <a href="/tags/ActiveMQ/" style="font-size: 15px;">ActiveMQ</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/Memcached/" style="font-size: 15px;">Memcached</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/网络爬虫/" style="font-size: 15px;">网络爬虫</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Solr/" style="font-size: 15px;">Solr</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/Spring-Cloud/" style="font-size: 15px;">Spring Cloud</a> <a href="/tags/MyBatis/" style="font-size: 15px;">MyBatis</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/Thymeleaf/" style="font-size: 15px;">Thymeleaf</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">07月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">06月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">05月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">04月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">02月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">01月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">10月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">09月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">01月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">12月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">11月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">10月 2015</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> | <a href="/atom.xml">订阅</a> |<span>主题<a rel="nofollow" target="_blank" href="https://hexo.io/zh-cn/"> Hexo</a><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake</a> |</span><span>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?4e375539c063ce29112e53dea9f27aae";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._config = { showScore: true };
(function(){ 
  var appid = 'cyt5nPNL8'; 
  var conf = '5fe2e421f26b9cd1b7c459f7417c85b6'; 
  var width = window.innerWidth || document.documentElement.clientWidth; 
  var nodes =document.getElementsByTagName("head")[0]||document.head||document.documentElement;
  if (width < 960) { 
    window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } 
  else { 
    var loadJs=function(d,a){
      var b=document.createElement("script");b.setAttribute("type","text/javascript");
      b.setAttribute("charset","UTF-8");
      b.setAttribute("src",d);
      if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}
      nodes.appendChild(b)
    };
    loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); 
  } 
  var loadCss = function(cssString){  
    var style=document.createElement("style");  
    style.setAttribute("type", "text/css");  
    if(style.styleSheet){// IE  
        style.styleSheet.cssText = cssString;  
    } else {// w3c  
        var cssText = document.createTextNode(cssString);  
        style.appendChild(cssText);  
    }
    nodes.appendChild(style);
  }
  window.onload=function(){loadCss('.module-hot-topic, .module-cmt-float-bar { display: none !important; } #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .cbox-prompt-w span.prompt-empty-w, #SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w .form-text-w span.text-null, #SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w a.comment-link-w, #SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w span.comment-text-w, #SOHUCS #SOHU_MAIN .module-cmt-footer .section-service-w div.service-wrap-w a:hover, #SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login, #SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w span.wrap-name-w, #SOHUCS #SOHU_MAIN .module-cmt-list .action-click-gw span.click-disable-eg a em.icon-name-bg, #SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li div.title-name-gw, #SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number .comment-number span.cy-number, #SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number span.comment-number, #SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active, #SOHUCS #SOHU_MAIN .module-cmt-list .msg-wrap-gw .wrap-action-gw .action-click-gw span a:hover, #SOHUCS #SOHU_MAIN .module-cmt-list .picture-box-gw div.box-action-gw a:hover, #SOHUCS #SOHU_MAIN .module-cmt-list .wrap-action-gw .action-click-gw span a:hover em.icon-name-bg, #SOHUCS #SOHU_MAIN .module-cmt-list .wrap-user-gw span.user-name-gw a { color: #40759b !important; } #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-r, #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-l, #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-r { display: none !important; } #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-l { background: #FFF !important; top: -2px !important; } #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-function-w .uploading-wrapper-dw div.wrapper-image-dw, #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-main, #SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w div.form-text-w, #SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login, #SOHUCS #SOHU_MAIN .module-cmt-list .module-cmt-box .post-wrap-w div.post-wrap-main { border: 1px solid #e6e6e6 !important; border-radius: 20px 20px 20px 20px; margin: 0 !important; } #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw { width: 130px !important; height: 34px !important; line-height: 33px !important; font-size: 17px !important; background: transparent !important; } #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw:before { content: "发表评论"; display: block; border-radius: 20px; width: 100%; height: 100%; color: #FFF; background: #5483b1; -webkit-box-shadow: 0 -1px 4px #5483b1 inset; box-shadow: 0 -1px 10px #5483b1 inset; } #SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a:hover .btn-fw:before { color: #40759b; background: #FFF; } #SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li{ background: none !important; border-bottom: 1px solid #e6e6e6; } #SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active { border: 1px solid #e6e6e6; border-radius: 10px 10px 0 0; border-bottom: none; } #SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li .title-name-gw div.title-name-gw-tag { background: #5483b1 !important; border-radius: 3px; } #SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type div.cmt-list-border { background-color: #e6e6e6 !important; } #SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item{ border: 1px solid #e6e6e6 !important; } #SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo { text-align: center; line-height: 40px; border-radius: 50% !important; background: #e6e6e6 !important; } #SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo:before { content: "畅"; font-size: 22px; color: #FFF; } #SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text, #SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text i { color: #5483b1 !important; }#SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w{background:#FFF !important;}');};
})();</script><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script></body></html>