<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>範宗雲</title>
  <subtitle>一路走，一路学。面朝大海，望眼欲穿！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-08-06T03:34:24.266Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>範宗雲</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>springmvc+dubbo+mybatis 接入大众点评 CAT 监控平台</title>
    <link href="http://yoursite.com/post/springmvc-dubbo-mybatis-with-cat.html"/>
    <id>http://yoursite.com/post/springmvc-dubbo-mybatis-with-cat.html</id>
    <published>2018-08-04T23:38:36.000Z</published>
    <updated>2018-08-06T03:34:24.266Z</updated>
    
    <content type="html"><![CDATA[<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>CAT（Central Application Tracking）是基于Java开发的实时应用监控平台，包括实时应用监控，业务监控。关于CAT的具体介绍可移步到<a href="https://github.com/dianping/cat" target="_blank" rel="external">CAT官网</a>进行查阅。<br>CAT平台的搭建可移步到<a href="https://fanlychie.github.io/post/cat-setup.html" target="_blank" rel="external">「搭建大众点评CAT监控平台」</a>。</p></td></tr></table>

<a id="more"></a>
<h4 id="1-开发环境"><a href="#1-开发环境" class="headerlink" title="1. 开发环境"></a>1. 开发环境</h4><p><code>Windows</code> <code>Java 8</code> <code>Maven 3.5</code> <code>MySQL 5.7</code> <code>CAT 2.0.0</code> <code>Dubbo 2.6</code> <code>Spring 4.3</code></p>
<h4 id="2-客户端配置"><a href="#2-客户端配置" class="headerlink" title="2. 客户端配置"></a>2. 客户端配置</h4><p>客户端应用程序接入<code>CAT</code>需要在系统的特定路径中部署<code>client.xml</code>配置文件。<code>Windows</code>系统和<code>Linux</code>系统的部署路径不一样，但其内容是一样的。</p>
<h5 id="2-1-Windows-客户端配置"><a href="#2-1-Windows-客户端配置" class="headerlink" title="2.1 Windows 客户端配置"></a>2.1 Windows 客户端配置</h5><p>如果你的客户端程序是运行在<code>Windows</code>系统中，例如你的应用程序项目所在的目录路径是<code>D:\application\workspace\idea\springmvc-dubbo-mybatis-with-cat-sample</code>。那么，你需要在此项目所在的盘符（即这里的<code>D</code>盘）创建<code>data\appdatas\cat</code>目录，并将<code>client.xml</code>配置文件存放在这个路径中。如作者的客户端配置文件<code>D:\data\appdatas\cat\client.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"config.xsd"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.10.10.121"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.10.10.122"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.10.10.123"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="2-1-Linux-客户端配置"><a href="#2-1-Linux-客户端配置" class="headerlink" title="2.1 Linux 客户端配置"></a>2.1 Linux 客户端配置</h5><p>如果你的客户端程序是运行在<code>Linux</code>系统中，那么你需要创建<code>/data/appdatas/cat</code>目录，并确保运行程序的用户对此目录有读写权限。然后将<code>client.xml</code>配置文件存放在这个路径中。配置文件的内容与上同。</p>
<h4 id="3-配置监控的项目名"><a href="#3-配置监控的项目名" class="headerlink" title="3. 配置监控的项目名"></a>3. 配置监控的项目名</h4><p>在需要接入<code>CAT</code>监控平台的项目中新建属性配置文件<code>src/main/resources/META-INF/app.properties</code>。其内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">################## CAT会自动加载此文件 ##################</div><div class="line"># 应用的名称（可以根据此名称在CAT的管理控制台查找对应的信息）</div><div class="line">app.name=service-article</div></pre></td></tr></table></figure>
<h4 id="4-URL-监控埋点"><a href="#4-URL-监控埋点" class="headerlink" title="4. URL 监控埋点"></a>4. URL 监控埋点</h4><p>客户端程序接入<code>CAT</code>需要依赖<code>cat-client</code>包。由于<code>cat-client</code>没有加入<code>maven</code>远程中央仓库，因此需要指定<code>CAT</code>专用的远程仓库。在需要接入<code>CAT</code>监控平台的<code>web</code>项目的<code>pom.xml</code>中加入如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- CAT client 仓库 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>unidal-nexus-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://unidal.org/nexus/content/repositories/releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 客户端接入CAT的依赖 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;cat-client.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>然后在<code>web</code>项目的<code>web.xml</code>配置文件中加入如下配置即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cat-filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.dianping.cat.servlet.CatFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cat-filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>FORWARD<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接入后，在<code>Transaction</code>中会生成<code>URL</code>信息。效果图（缩略图，可右键在新标签页打开图片查看）：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/cat-sample-url.png" alt=""></p>
<h4 id="5-mybatis-接入"><a href="#5-mybatis-接入" class="headerlink" title="5. mybatis 接入"></a>5. mybatis 接入</h4><p>项目地址：<a href="https://github.com/fanlychie/cat-client-mybatis" target="_blank" rel="external">https://github.com/fanlychie/cat-client-mybatis</a></p>
<p>你可以检出项目手工执行安装到本地的<code>maven</code>仓库。或者使用博主托管在<code>github</code>的<code>maven</code>仓库：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- CAT mybatis和dubbo 仓库 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>fanlychie-maven-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://raw.github.com/fanlychie/maven-repo/releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- mybatis接入CAT的依赖 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-client-mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接入方式（这里仅给出 spring 的 xml 配置参考方式）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"typeAliasesPackage"</span> <span class="attr">value</span>=<span class="string">"org.fanlychie.entity"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:mybatis-config.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapperLocations"</span> <span class="attr">value</span>=<span class="string">"classpath*:mapper/*.xml"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- MyBatis 接入 CAT --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plugins"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.wanda.cat.sample.plugins.CatMybatisPlugin"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接入后，在<code>Transaction</code>中会生成<code>SQL</code>信息。效果图（缩略图，可右键在新标签页打开图片查看）：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/cat-client-mybatis.png" alt=""></p>
<h4 id="6-dubbo-接入-生产者端"><a href="#6-dubbo-接入-生产者端" class="headerlink" title="6. dubbo 接入 (生产者端)"></a>6. dubbo 接入 (生产者端)</h4><p>项目地址：<a href="https://github.com/fanlychie/cat-dubbo-monitor" target="_blank" rel="external">https://github.com/fanlychie/cat-dubbo-monitor</a></p>
<p>你可以检出项目手工执行安装到本地的<code>maven</code>仓库。或者使用博主托管在<code>github</code>的<code>maven</code>仓库：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- CAT mybatis和dubbo 仓库 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>fanlychie-maven-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://raw.github.com/fanlychie/maven-repo/releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- dubbo接入CAT的依赖 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.dubboclub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-dubbo-monitor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接入方式：只需要声明依赖包，不需要做任何配置。接入后，在cat中会出现cross报表，dependency，服务端的matrix以及调用链路的trace信息。</p>
<p>效果图（缩略图，可右键在新标签页打开图片查看）：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/dubbo-monitor-cat.png" alt=""></p>
<h4 id="7-dubbo-接入-web消费者端"><a href="#7-dubbo-接入-web消费者端" class="headerlink" title="7. dubbo 接入 (web消费者端)"></a>7. dubbo 接入 (web消费者端)</h4><p>项目地址：<a href="https://github.com/fanlychie/cat-client-dubbo" target="_blank" rel="external">https://github.com/fanlychie/cat-client-dubbo</a></p>
<p>你可以检出项目手工执行安装到本地的<code>maven</code>仓库。或者使用博主托管在<code>github</code>的<code>maven</code>仓库：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- CAT mybatis和dubbo 仓库 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>fanlychie-maven-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://raw.github.com/fanlychie/maven-repo/releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 客户端dubbo接入CAT --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-client-dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接入方式为，在<code>web</code>项目的消费者端<code>dubbo</code>配置文件中加入如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:consumer</span> <span class="attr">filter</span>=<span class="string">"CatClientFilter"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>接入后，在<code>Transaction</code>的<code>URL</code>中会生成<code>dubbo</code>调用链路的<code>trace</code>信息。</p>
<p>接入前的效果图（缩略图，可右键在新标签页打开图片查看）：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/cat-client-dubbo-pre.png" alt=""></p>
<p>接入后的效果图（缩略图，可右键在新标签页打开图片查看）：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/cat-client-dubbo-post.png" alt=""></p>
<h4 id="8-log4j-接入"><a href="#8-log4j-接入" class="headerlink" title="8. log4j 接入"></a>8. log4j 接入</h4><p>异常日志信息接入将异常日志上报到<code>CAT</code>服务器，方便查看异常日志。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory = INFO, ...xxx... , CAT</div><div class="line"># 异常日志上报到CAT</div><div class="line">log4j.appender.CAT = com.dianping.cat.log4j.CatAppender</div><div class="line">log4j.appender.CAT.Threshold = ERROR</div></pre></td></tr></table></figure>
<h4 id="9-项目启动报错问题"><a href="#9-项目启动报错问题" class="headerlink" title="9. 项目启动报错问题"></a>9. 项目启动报错问题</h4><p>当启动两个或以上依赖<code>cat-client</code>包的项目的时候，会报出如下错误，致使服务无法正常提供服务：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2018-08-05 23:14:01:326 [main] ERROR [Server:102] -  [DUBBO] qos-server can not bind localhost:22222, dubbo version: 2.6.0, current host: 127.0.0.1</div><div class="line">java.net.BindException: Address already in use: bind</div></pre></td></tr></table></figure>
<p>这是<code>dubbo</code>的<code>qos</code>服务端口冲突引起的，其默认使用<code>22222</code>端口。可以在项目的<code>dubbo.properties</code>属性配置文件中修改此端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 避免端口冲突, 默认端口22222</div><div class="line">dubbo.qos.port=20221</div></pre></td></tr></table></figure>
<blockquote>
<p>完整示例项目链接：<a href="https://github.com/fanlychie/springmvc-dubbo-mybatis-with-cat-sample" target="_blank" rel="external">springmvc-dubbo-mybatis-with-cat-sample</a><br>参考文档文献链接：<a href="https://github.com/dianping/cat" target="_blank" rel="external">https://github.com/dianping/cat</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;table class=&quot;cmtbl&quot;&gt;&lt;tr&gt;&lt;td style=&quot;border-right:1px solid #e2dfdf!important;width:5.2%&quot;&gt;&lt;img src=&quot;../img/info.png&quot; style=&quot;width:18px&quot;&gt;&lt;/td&gt;&lt;td style=&quot;padding-left:18px;width:94.8%;&quot;&gt;&lt;p&gt;CAT（Central Application Tracking）是基于Java开发的实时应用监控平台，包括实时应用监控，业务监控。关于CAT的具体介绍可移步到&lt;a href=&quot;https://github.com/dianping/cat&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAT官网&lt;/a&gt;进行查阅。&lt;br&gt;CAT平台的搭建可移步到&lt;a href=&quot;https://fanlychie.github.io/post/cat-setup.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;「搭建大众点评CAT监控平台」&lt;/a&gt;。&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
    
    </summary>
    
    
      <category term="监控" scheme="http://yoursite.com/tags/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>搭建大众点评CAT监控平台</title>
    <link href="http://yoursite.com/post/cat-setup.html"/>
    <id>http://yoursite.com/post/cat-setup.html</id>
    <published>2018-07-27T23:38:36.000Z</published>
    <updated>2018-08-06T03:22:04.447Z</updated>
    
    <content type="html"><![CDATA[<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>CAT（Central Application Tracking）是基于Java开发的实时应用监控平台，包括实时应用监控，业务监控。关于CAT的具体介绍可移步到<a href="https://github.com/dianping/cat" target="_blank" rel="external">CAT官网</a>进行查阅。</p></td></tr></table>

<a id="more"></a>
<h4 id="1-环境清单"><a href="#1-环境清单" class="headerlink" title="1. 环境清单"></a>1. 环境清单</h4><p><code>CentOS 7</code> <code>Java 8</code> <code>Maven 3.5</code> <code>MySQL 5.7</code> <code>CAT 2.0.0</code> <code>Tomcat 7.0</code></p>
<h4 id="2-安装-CAT"><a href="#2-安装-CAT" class="headerlink" title="2. 安装 CAT"></a>2. 安装 CAT</h4><p>下载<code>CAT</code>安装包：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget -O cat-home-2.0.0.war http://unidal.org/nexus/service/local/repositories/releases/content/com/dianping/cat/cat-home/2.0.0/cat-home-2.0.0.war</span></div></pre></td></tr></table></figure>
<p>将<code>cat-home-2.0.0.war</code>部署到<code>tomcat</code>并重命名为<code>cat.war</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mv cat-home-2.0.0.war tomcat-7.0.90/webapps/cat.war</div></pre></td></tr></table></figure>
<h5 id="2-1-配置-CAT"><a href="#2-1-配置-CAT" class="headerlink" title="2.1 配置 CAT"></a>2.1 配置 CAT</h5><p>在Linux系统安装时，<code>CAT</code>应用要求对<code>/data/appdatas/cat</code>和<code>/data/applogs/cat</code>路径有读写权限。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p /data/appdatas/cat &amp;&amp; mkdir -p /data/applogs/cat</span></div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>CAT</code>服务端应用会对这两个目录进行读写操作，因此需要首先创建这两个目录。并且应确保启动<code>CAT</code>应用的用户对这两个目录有读写权限。</p></td></tr></table>

<p>下载<code>CAT</code>的源码包：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget -O cat-2.0.0.tar.gz https://codeload.github.com/dianping/cat/tar.gz/v2.0.0</div></pre></td></tr></table></figure>
<p>解压缩：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tar zxvf cat-2.0.0.tar.gz</span></div></pre></td></tr></table></figure>
<p>解压缩完成后得到<code>cat-2.0.0</code>目录。其中<code>cat-2.0.0/script</code>目录中存放的是<code>CAT</code>客户端和服务端安装所需的一些配置文件：</p>
<table>
<thead>
<tr>
<th style="text-align:left">文件</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">client.xml</td>
<td style="text-align:left">所有的CAT客户端都需要配置这个配置文件。它用于配置CAT部署的服务端信息。只有客户端配置了这个配置文件，客户端才能正确连接到CAT服务器端。该文件的部署路径是/data/appdatas/cat（该部署路径不能更改，并且启动客户端的程序的用户需要对此目录有读写权限）。<br>特殊的，部署CAT应用的服务端同时也是一个客户端，也需要配置该配置文件。</td>
</tr>
<tr>
<td style="text-align:left">server.xml</td>
<td style="text-align:left">CAT服务端的配置文件。即安装CAT应用的服务器才需要配置。该文件的部署路径是/data/appdatas/cat（该部署路径不能更改，并且启动CAT应用的用户需要对此目录有读写权限）。</td>
</tr>
<tr>
<td style="text-align:left">datasources.xml</td>
<td style="text-align:left">CAT服务端的配置文件。即安装CAT应用的服务器才需要配置。该配置文件用于配置CAT链接MySQL数据库的信息。该文件的部署路径是/data/appdatas/cat（该部署路径不能更改）。</td>
</tr>
<tr>
<td style="text-align:left">Cat.sql</td>
<td style="text-align:left">CAT应用所需的MySQL数据库脚本。需将此脚本导入MySQL数据库中。</td>
</tr>
</tbody>
</table>
<p>将<code>cat-2.0.0/script</code>目录中的<code>client.xml</code>、<code>datasources.xml</code>、<code>server.xml</code>配置文件复制到目录<code>/data/appdatas/cat</code>中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp client.xml server.xml datasources.xml /data/appdatas/cat/</div></pre></td></tr></table></figure>
<p>客户端<code>client.xml</code>的配置内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"config.xsd"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- ip：部署CAT应用的服务器IP</span></div><div class="line">             port：CAT服务端接收客户端数据的端口（不允许更改）</div><div class="line">             http-port：CAT应用部署到的容器的端口（tomcat的端口）</div><div class="line">        --&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.10.10.121"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></div></pre></td></tr></table></figure>
<p>服务端<code>server.xml</code>的配置内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="comment">&lt;!-- local-mode：是否为本地开发模式。建议在开发环境以及生产环境都设置为false</span></div><div class="line">     hdfs-machine：是否启用HDFS存储</div><div class="line">     job-machine：是否为报告工作机（开启生成汇总报告和统计报告，只需要一台服务机开启此功能）</div><div class="line">     alert-machine：是否为报警机（开启各类报警监听, 只需要一台服务机开启此功能）</div><div class="line">--&gt;</div><div class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"true"</span> <span class="attr">alert-machine</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- local-base-dir：本地数据存储目录, 建议不要修改</span></div><div class="line">         local-report-storage-time：本地报告文件存放时长, 单位为（天）</div><div class="line">         local-logivew-storage-time：本地日志文件存放时长, 单位为（天）</div><div class="line">    --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">storage</span> <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 远程服务端HTTP服务列表, 用于同步更新 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>10.10.10.121:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></div></pre></td></tr></table></figure>
<p>数据源<code>datasources.xml</code>的配置内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">data-sources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data-source</span> <span class="attr">id</span>=<span class="string">"cat"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maximum-pool-size</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maximum-pool-size</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">connection-timeout</span>&gt;</span>3s<span class="tag">&lt;/<span class="name">connection-timeout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">idle-timeout</span>&gt;</span>10m<span class="tag">&lt;/<span class="name">idle-timeout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">statement-cache-size</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">statement-cache-size</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 数据库 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>&lt;![CDATA[jdbc:mysql://10.10.10.121:3306/cat_schema]]&gt;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 用户名 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">user</span>&gt;</span>root<span class="tag">&lt;/<span class="name">user</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 密码 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span>123654<span class="tag">&lt;/<span class="name">password</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">connectionProperties</span>&gt;</span>&lt;![CDATA[useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;socketTimeout=120000]]&gt;<span class="tag">&lt;/<span class="name">connectionProperties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">data-source</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data-source</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">maximum-pool-size</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maximum-pool-size</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">connection-timeout</span>&gt;</span>3s<span class="tag">&lt;/<span class="name">connection-timeout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">idle-timeout</span>&gt;</span>10m<span class="tag">&lt;/<span class="name">idle-timeout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">statement-cache-size</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">statement-cache-size</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 数据库 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>&lt;![CDATA[jdbc:mysql://10.10.10.121:3306/cat_schema]]&gt;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 用户名 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">user</span>&gt;</span>root<span class="tag">&lt;/<span class="name">user</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 密码 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span>123654<span class="tag">&lt;/<span class="name">password</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">connectionProperties</span>&gt;</span>&lt;![CDATA[useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;socketTimeout=120000]]&gt;<span class="tag">&lt;/<span class="name">connectionProperties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">data-source</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">data-sources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>创建<code>cat_schema</code>数据库：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> cat_schema <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci</div></pre></td></tr></table></figure>
<p>选择数据库<code>cat_schema</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">USE</span> cat_schema</div></pre></td></tr></table></figure>
<p>导入<code>Cat.sql</code>到<code>cat_schema</code>数据库：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SOURCE /home/fanlychie/cat-2.0.0/script/Cat.sql</div></pre></td></tr></table></figure>
<p>编辑<code>tomcat</code>配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vim tomcat-7.0.90/conf/server.xml</div></pre></td></tr></table></figure>
<p>找到<code>Connector</code>的配置行，添加<code>URIEncoding=&quot;utf-8&quot;</code>。如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></div><div class="line">           <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></div><div class="line">           <span class="attr">redirectPort</span>=<span class="string">"8443"</span></div><div class="line">           <span class="attr">URIEncoding</span>=<span class="string">"utf-8"</span> /&gt;</div></pre></td></tr></table></figure>
<h5 id="2-2-启动-CAT"><a href="#2-2-启动-CAT" class="headerlink" title="2.2 启动 CAT"></a>2.2 启动 CAT</h5><p>启动<code>tomcat</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./tomcat-7.0.90/bin/startup.sh</div></pre></td></tr></table></figure>
<p>访问：<a href="http://10.10.10.121:8080/cat" target="_blank" rel="external">http://10.10.10.121:8080/cat</a></p>
<p><img src="../img/cat.png"></p>
<p>配置操作需要用户登入系统，每次的登录账户名和密码保持一致即可。如<code>catadmin/catadmin</code>。</p>
<h5 id="2-3-客户端路由设置"><a href="#2-3-客户端路由设置" class="headerlink" title="2.3 客户端路由设置"></a>2.3 客户端路由设置</h5><p>依次打开<code>配置 --&gt; 全局告警配置 --&gt; 客户端路由</code>修改<code>id</code>为<code>CAT</code>部署的服务器<code>ip</code>：</p>
<p><img src="../img/cat-router.png"></p>
<h4 id="3-集群搭建"><a href="#3-集群搭建" class="headerlink" title="3. 集群搭建"></a>3. 集群搭建</h4><p>上面介绍的是<code>CAT</code>应用的单点模式部署。接下来介绍<code>CAT</code>的集群模式搭建方式。</p>
<h5 id="3-1-部署概览"><a href="#3-1-部署概览" class="headerlink" title="3.1 部署概览"></a>3.1 部署概览</h5><table>
<thead>
<tr>
<th style="text-align:left">IP</th>
<th style="text-align:left">角色</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">10.10.10.121</td>
<td style="text-align:left">控制台、告警端、任务机</td>
</tr>
<tr>
<td style="text-align:left">10.10.10.122</td>
<td style="text-align:left">消费机</td>
</tr>
<tr>
<td style="text-align:left">10.10.10.123</td>
<td style="text-align:left">消费机</td>
</tr>
</tbody>
</table>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>10.10.10.121</code>作为前端控制台，如果使用了域名，只需将域名解析到此<code>IP</code>地址。</p></td></tr></table>

<p>按以上搭建单点模式的方式，分别在<code>10.10.10.121</code>、<code>10.10.10.122</code>、<code>10.10.10.123</code>部署<code>CAT</code>。部署完成后，先不要启动<code>tomcat</code>。接下来做集群配置。</p>
<h5 id="3-2-客户端client-xml配置"><a href="#3-2-客户端client-xml配置" class="headerlink" title="3.2 客户端client.xml配置"></a>3.2 客户端client.xml配置</h5><p><code>10.10.10.121</code>、<code>10.10.10.122</code>、<code>10.10.10.123</code>的<code>client.xml</code>配置一样，具体如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"config.xsd"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- ip：部署CAT应用的服务器IP</span></div><div class="line">             port：CAT服务端接收客户端数据的端口（不允许更改）</div><div class="line">             http-port：CAT应用部署到的容器的端口（tomcat的端口）</div><div class="line">        --&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.10.10.121"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.10.10.122"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.10.10.123"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="3-3-服务端server-xml配置"><a href="#3-3-服务端server-xml配置" class="headerlink" title="3.3 服务端server.xml配置"></a>3.3 服务端server.xml配置</h5><p><code>10.10.10.121</code>的<code>server.xml</code>配置，具体如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="comment">&lt;!-- local-mode：是否为本地开发模式。建议在开发环境以及生产环境都设置为false</span></div><div class="line">     hdfs-machine：是否启用HDFS存储</div><div class="line">     job-machine：是否为报告工作机（开启生成汇总报告和统计报告，只需要一台服务机开启此功能）</div><div class="line">     alert-machine：是否为报警机（开启各类报警监听, 只需要一台服务机开启此功能）</div><div class="line">--&gt;</div><div class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"true"</span> <span class="attr">alert-machine</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- local-base-dir：本地数据存储目录, 建议不要修改</span></div><div class="line">         local-report-storage-time：本地报告文件存放时长, 单位为（天）</div><div class="line">         local-logivew-storage-time：本地日志文件存放时长, 单位为（天）</div><div class="line">    --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">storage</span> <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 远程服务端HTTP服务列表, 用于同步更新 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>10.10.10.121:8080,10.10.10.122:8080,10.10.10.123:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>10.10.10.122</code>、<code>10.10.10.123</code>的<code>server.xml</code>配置一样，具体如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="comment">&lt;!-- local-mode：是否为本地开发模式。建议在开发环境以及生产环境都设置为false</span></div><div class="line">     hdfs-machine：是否启用HDFS存储</div><div class="line">     job-machine：是否为报告工作机（开启生成汇总报告和统计报告，只需要一台服务机开启此功能）</div><div class="line">     alert-machine：是否为报警机（开启各类报警监听, 只需要一台服务机开启此功能）</div><div class="line">--&gt;</div><div class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"false"</span> <span class="attr">alert-machine</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- local-base-dir：本地数据存储目录, 建议不要修改</span></div><div class="line">         local-report-storage-time：本地报告文件存放时长, 单位为（天）</div><div class="line">         local-logivew-storage-time：本地日志文件存放时长, 单位为（天）</div><div class="line">    --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">storage</span> <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 远程服务端HTTP服务列表, 用于同步更新 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>10.10.10.121:8080,10.10.10.122:8080,10.10.10.123:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>服务端<code>server.xml</code>的配置主要是<code>job-machine</code>和<code>alert-machine</code>属性值配置的不同。</p></td></tr></table>

<h5 id="3-4-启动-CAT"><a href="#3-4-启动-CAT" class="headerlink" title="3.4 启动 CAT"></a>3.4 启动 CAT</h5><p>分别启动<code>10.10.10.121</code>、<code>10.10.10.122</code>、<code>10.10.10.123</code>的<code>tomcat</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./tomcat-7.0.90/bin/startup.sh</div></pre></td></tr></table></figure>
<p><code>10.10.10.121</code>作为控制台服务，只需访问：<a href="http://10.10.10.121:8080/cat" target="_blank" rel="external">http://10.10.10.121:8080/cat</a></p>
<p><img src="../img/cat-cluster.png"></p>
<h5 id="3-5-客户端路由设置"><a href="#3-5-客户端路由设置" class="headerlink" title="3.5 客户端路由设置"></a>3.5 客户端路由设置</h5><p><code>10.10.10.121</code>作为控制台服务，只需配置这台即可。</p>
<p>依次打开<code>配置 --&gt; 全局告警配置 --&gt; 客户端路由</code>修改<code>id</code>为<code>CAT</code>部署的服务器<code>ip</code>：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/cat-alert-router-cluster.png" alt=""></p>
<p>其中<code>10.10.10.121</code>作为备份，正常情况下不作为消费机（即不起消费数据的作用），仅当<code>CAT</code>集群中的其它节点（如这里的<code>10.10.10.122</code>、<code>10.10.10.123</code>节点）都挂掉之后才会对数据进行消费。</p>
<p>该配置会自动同步到<code>CAT</code>集群中的其它节点（如这里的<code>10.10.10.122</code>、<code>10.10.10.123</code>节点）。</p>
<p>配置完成后，重启<code>10.10.10.121</code>服务器的<code>CAT</code>应用容器（即重启<code>tomcat</code>）。</p>
]]></content>
    
    <summary type="html">
    
      &lt;table class=&quot;cmtbl&quot;&gt;&lt;tr&gt;&lt;td style=&quot;border-right:1px solid #e2dfdf!important;width:5.2%&quot;&gt;&lt;img src=&quot;../img/info.png&quot; style=&quot;width:18px&quot;&gt;&lt;/td&gt;&lt;td style=&quot;padding-left:18px;width:94.8%;&quot;&gt;&lt;p&gt;CAT（Central Application Tracking）是基于Java开发的实时应用监控平台，包括实时应用监控，业务监控。关于CAT的具体介绍可移步到&lt;a href=&quot;https://github.com/dianping/cat&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAT官网&lt;/a&gt;进行查阅。&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
    
    </summary>
    
    
      <category term="监控" scheme="http://yoursite.com/tags/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 查询优化</title>
    <link href="http://yoursite.com/post/mysql-select-optimization.html"/>
    <id>http://yoursite.com/post/mysql-select-optimization.html</id>
    <published>2018-04-04T12:11:23.000Z</published>
    <updated>2018-08-05T15:37:24.297Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL版本：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">VERSION</span>();</div><div class="line">+<span class="comment">------------+</span></div><div class="line">| VERSION()  |</div><div class="line">+<span class="comment">------------+</span></div><div class="line">| 5.7.21-log |</div><div class="line">+<span class="comment">------------+</span></div></pre></td></tr></table></figure>
<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</div><div class="line">  <span class="string">`agent_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'代理商ID'</span>,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</div><div class="line">  <span class="string">`score`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'积分'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'用户表'</span>;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`agent`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'名称'</span>,</div><div class="line">  <span class="string">`level`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'级别'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`idx_level`</span> (<span class="string">`level`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'代理商'</span>;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>为用户表建立索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_agentid <span class="keyword">ON</span> <span class="keyword">user</span>(agent_id);</div></pre></td></tr></table></figure>
<p>为用户表建立索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_score_name <span class="keyword">ON</span> <span class="keyword">user</span>(score, <span class="keyword">name</span>);</div></pre></td></tr></table></figure>
<p>为代理商建立索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_level <span class="keyword">ON</span> <span class="keyword">agent</span>(<span class="keyword">level</span>);</div></pre></td></tr></table></figure>
<p>用户表索引列表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">INDEX</span> <span class="keyword">FROM</span> <span class="keyword">user</span>;</div><div class="line">+<span class="comment">-------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div><div class="line">| Table | Non_unique | Key_name       | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | <span class="keyword">Comment</span> | Index_comment |</div><div class="line">+<span class="comment">-------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div><div class="line">| <span class="keyword">user</span>  |          <span class="number">0</span> | PRIMARY        |            <span class="number">1</span> | <span class="keyword">id</span>          | A         |    <span class="number">19285676</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</div><div class="line">| <span class="keyword">user</span>  |          <span class="number">1</span> | idx_agentid    |            <span class="number">1</span> | agent_id    | A         |        <span class="number">5952</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   | YES  | BTREE      |         |               |</div><div class="line">| <span class="keyword">user</span>  |          <span class="number">1</span> | idx_score_name |            <span class="number">1</span> | score       | A         |       <span class="number">28654</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   | YES  | BTREE      |         |               |</div><div class="line">| <span class="keyword">user</span>  |          <span class="number">1</span> | idx_score_name |            <span class="number">2</span> | <span class="keyword">name</span>        | A         |    <span class="number">19970922</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   | YES  | BTREE      |         |               |</div><div class="line">+<span class="comment">-------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div></pre></td></tr></table></figure>
<p>代理商索引列表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">INDEX</span> <span class="keyword">FROM</span> <span class="keyword">agent</span>;</div><div class="line">+<span class="comment">-------+------------+-----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div><div class="line">| Table | Non_unique | Key_name  | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | <span class="keyword">Comment</span> | Index_comment |</div><div class="line">+<span class="comment">-------+------------+-----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div><div class="line">| <span class="keyword">agent</span> |          <span class="number">0</span> | PRIMARY   |            <span class="number">1</span> | <span class="keyword">id</span>          | A         |           <span class="number">5</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</div><div class="line">| <span class="keyword">agent</span> |          <span class="number">1</span> | idx_level |            <span class="number">1</span> | <span class="keyword">level</span>       | A         |           <span class="number">2</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   | YES  | BTREE      |         |               |</div><div class="line">+<span class="comment">-------+------------+-----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div></pre></td></tr></table></figure>
<h3 id="1-ORDER-BY-优化"><a href="#1-ORDER-BY-优化" class="headerlink" title="1. ORDER BY 优化"></a>1. ORDER BY 优化</h3><p><a href="https://dev.mysql.com/doc/refman/5.7/en/order-by-optimization.html" target="_blank" rel="external">MySLQ官方文档</a>给出了能够使用索引加速<code>ORDER BY</code>排序以及无法通过使用索引加速<code>ORDER BY</code>排序的场景案例，下面来一一列举。</p>
<h4 id="1-1-使用索引加速排序"><a href="#1-1-使用索引加速排序" class="headerlink" title="1.1 使用索引加速排序"></a>1.1 使用索引加速排序</h4><h5 id="1-1-1-案例1"><a href="#1-1-1-案例1" class="headerlink" title="1.1.1 案例1"></a>1.1.1 案例1</h5><p>使用复合索引（多列索引）中的一个或多个列进行排序。要遵循最左前缀匹配原则。如果是使用复合索引中的多个列进行排序，这些列排序的顺序要么都是升序，要么都是降序，否则无法使用索引加速排序操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part1, key_part2;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part1 <span class="keyword">DESC</span>, key_part2 <span class="keyword">DESC</span>;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> score, <span class="keyword">name</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+----------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra          |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+----------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 20434945 |   100.00 | Using filesort |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+----------------+</span></div></pre></td></tr></table></figure>
<p>从执行计划的结果来看，<code>Extra</code>出现了<code>Using filesort</code>，这就是通常说的<code>Filesort</code>排序。<br><code>Filesort</code>排序并不代表是通过磁盘文件进行的排序，而只是说数据库服务器需要对数据进行一次额外的排序。凡是不是通过索引直接返回排序结果的排序，都叫<code>Filesort</code>排序。<br><code>Filesort</code>排序算法首先是尝试将取出的数据一次性加载到内存中进行排序，排序最大能使用的内存空间大小是由系统变量<code>sort_buffer_size</code>决定的。如果内存空间无法容下所有取出的数据，那么排序就会分解成多个更小的排序，然后每次只排序其中一小部分的数据，并将每次排序的结果存储到磁盘临时文件中，最后再将临时文件中的数据进行一次排序和合并结果输出。<br>每将各个有序的小数据块合并成一个有序的结果集就会增加<code>Sort_merge_passes</code>的数值。因此，如果数据库服务器的<code>Sort_merge_passes</code>的数值过大，可以考虑适当增加<code>sort_buffer_size</code>的数值以加速<code>Filesort</code>排序的操作。但是需要注意，系统变量<code>sort_buffer_size</code>配置的内存空间是每个线程独占的，不宜设置过大，应该综合考虑数据库连接数量和服务器内存的总大小。</p>
<p></p><p class="code-title"># 查看系统 sort_merge_passes 状态的值</p><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'sort_merge_passes'</span>;</div><div class="line">+<span class="comment">-------------------+-------+</span></div><div class="line">| Variable_name     | Value |</div><div class="line">+<span class="comment">-------------------+-------+</span></div><div class="line">| Sort_merge_passes | 2461  |</div><div class="line">+<span class="comment">-------------------+-------+</span></div></pre></td></tr></table></figure><p></p>
<p></p><p class="code-title"># 查看系统 sort_buffer_size 变量的值</p><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'sort_buffer_size'</span>;</div><div class="line">+<span class="comment">------------------+--------+</span></div><div class="line">| Variable_name    | Value  |</div><div class="line">+<span class="comment">------------------+--------+</span></div><div class="line">| sort_buffer_size | 262144 |</div><div class="line">+<span class="comment">------------------+--------+</span></div></pre></td></tr></table></figure><p></p>
<p></p><p class="code-title"># 设置系统 sort_buffer_size 变量的值, 1M</p><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> sort_buffer_size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1</span>;</div></pre></td></tr></table></figure><p></p>
<p>使用覆盖索引的方式改写上面的查询语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> score, <span class="keyword">name</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key            | key_len | ref  | rows     | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | index | NULL          | idx_score_name | 56      | NULL | 20434945 |   100.00 | Using index |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>从执行计划的结果来看，<code>Extra</code>出现了<code>Using index</code>，已经没有<code>Using filesort</code>了。</p>
<h5 id="1-1-2-案例2"><a href="#1-1-2-案例2" class="headerlink" title="1.1.2 案例2"></a>1.1.2 案例2</h5><p>使用复合索引（多列索引）中的一部分列做等值查询，一部列做排序操作。要遵循最左前缀匹配原则。如果是使用复合索引中的多个列进行排序，这些列排序的顺序要么都是升序，要么都是降序，否则无法使用索引加速排序操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> key_part1 = <span class="keyword">constant</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part2;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> key_part1 = <span class="keyword">constant</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part1 <span class="keyword">DESC</span>, key_part2 <span class="keyword">DESC</span>;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> score = <span class="number">100</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+----------------+---------+-------+-------+----------+-----------------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys  | key            | key_len | ref   | rows  | filtered | Extra                 |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+----------------+---------+-------+-------+----------+-----------------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | ref  | idx_score_name | idx_score_name | 5       | const | 38268 |   100.00 | Using index condition |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+----------------+---------+-------+-------+----------+-----------------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-1-3-案例3"><a href="#1-1-3-案例3" class="headerlink" title="1.1.3 案例3"></a>1.1.3 案例3</h5><p>使用复合索引（多列索引）中的一部分列做比较值查询，一部列做排序操作。要遵循最左前缀匹配原则。如果是使用复合索引中的多个列进行排序，这些列排序的顺序要么都是升序，要么都是降序，否则无法使用索引加速排序操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> key_part1 &gt; <span class="keyword">constant</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part1 <span class="keyword">ASC</span>;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> key_part1 &lt; <span class="keyword">constant</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part1 <span class="keyword">DESC</span>;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> score &lt; <span class="number">10</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> score;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+--------+----------+-----------------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys  | key            | key_len | ref  | rows   | filtered | Extra                 |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+--------+----------+-----------------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | range | idx_score_name | idx_score_name | 5       | NULL | 417240 |   100.00 | Using index condition |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+--------+----------+-----------------------+</span></div></pre></td></tr></table></figure>
<p>比较值的场景下，优化器不一定会选择采用索引的方式，主要还得看表数据量的大小以及MySQL估算查询要扫描的行数来决定是否选择走索引。</p>
<h4 id="1-2-无法使用索引加速排序"><a href="#1-2-无法使用索引加速排序" class="headerlink" title="1.2 无法使用索引加速排序"></a>1.2 无法使用索引加速排序</h4><h5 id="1-2-1-案例1"><a href="#1-2-1-案例1" class="headerlink" title="1.2.1 案例1"></a>1.2.1 案例1</h5><p>使用多个不同的单列索引进行排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> key1, key2;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span>, agent_id;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+-------------+---------+------+----------+----------+-----------------------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key         | key_len | ref  | rows     | filtered | Extra                       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+-------------+---------+------+----------+----------+-----------------------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | index | NULL          | idx_agentid | 5       | NULL | 20434945 |   100.00 | Using index; Using filesort |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+-------------+---------+------+----------+----------+-----------------------------+</span></div></pre></td></tr></table></figure>
<p>为了确保查询走索引，这里采用了覆盖索引的方式。</p>
<h5 id="1-2-2-案例2"><a href="#1-2-2-案例2" class="headerlink" title="1.2.2 案例2"></a>1.2.2 案例2</h5><p>使用复合索引（多列索引）的多个列进行排序时，不遵循最左前缀匹配原则。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> key2=<span class="keyword">constant</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part1, key_part3;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span>, score;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-----------------------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key            | key_len | ref  | rows     | filtered | Extra                       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-----------------------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | index | NULL          | idx_score_name | 56      | NULL | 20434945 |   100.00 | Using index; Using filesort |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-----------------------------+</span></div></pre></td></tr></table></figure>
<p>本文没有建立三个列的复合索引，这里采用覆盖索引的方式来实现，达到的效果是一样的。</p>
<h5 id="1-2-3-案例3"><a href="#1-2-3-案例3" class="headerlink" title="1.2.3 案例3"></a>1.2.3 案例3</h5><p>使用复合索引（多列索引）的多个列进行排序时，同时存在升序和降序的混合排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> key_part1 <span class="keyword">DESC</span>, key_part2 <span class="keyword">ASC</span>;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> score, <span class="keyword">name</span> <span class="keyword">DESC</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-----------------------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key            | key_len | ref  | rows     | filtered | Extra                       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-----------------------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | index | NULL          | idx_score_name | 56      | NULL | 20434945 |   100.00 | Using index; Using filesort |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+----------+----------+-----------------------------+</span></div></pre></td></tr></table></figure>
<p>为了确保查询走索引，这里采用了覆盖索引的方式。</p>
<h3 id="2-LIMIT-优化"><a href="#2-LIMIT-优化" class="headerlink" title="2. LIMIT 优化"></a>2. LIMIT 优化</h3><h4 id="2-1-案例"><a href="#2-1-案例" class="headerlink" title="2.1 案例"></a>2.1 案例</h4><p>查询代理商ID为2下面的所有用户信息，每页展示20条数据，起始值从200万行开始。为保证优化前和优化后返回相同的数据列表，这里增加了根据主键排序的条件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> agent_id = <span class="number">2</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">LIMIT</span> <span class="number">2000000</span>, <span class="number">20</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-------------+---------+-------+---------+----------+-----------------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key         | key_len | ref   | rows    | filtered | Extra                 |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-------------+---------+-------+---------+----------+-----------------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | ref  | idx_agentid   | idx_agentid | 5       | const | 5221432 |   100.00 | Using index condition |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-------------+---------+-------+---------+----------+-----------------------+</span></div></pre></td></tr></table></figure>
<p>在一张数据量为2000万行的表中，真实的查询耗时为<code>3 min 0.54 sec</code>。</p>
<h4 id="2-2-优化"><a href="#2-2-优化" class="headerlink" title="2.2 优化"></a>2.2 优化</h4><p>思路：采用覆盖索引的方式先取出已经通过索引加速排序好的分页数据的行记录ID，然后再通过行记录ID关联回表查询所需的所有数据。这样可以减少全表扫描的行数，提升查询效率。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">EXPLAIN SELECT * FROM user INNER JOIN (SELECT id FROM user WHERE agent_id = 2 ORDER BY id LIMIT 2000000, 20) tmp USING(id);</div><div class="line">+----+-------------+------------+------------+--------+---------------+-------------+---------+--------+---------+----------+--------------------------+</div><div class="line">| id | select_type | table      | partitions | type   | possible_keys | key         | key_len | ref    | rows    | filtered | Extra                    |</div><div class="line">+----+-------------+------------+------------+--------+---------------+-------------+---------+--------+---------+----------+--------------------------+</div><div class="line">|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ALL    | NULL          | NULL        | NULL    | NULL   | 2000020 |   100.00 | NULL                     |</div><div class="line">|  1 | PRIMARY     | user       | NULL       | eq_ref | PRIMARY       | PRIMARY     | 4       | tmp.id |       1 |   100.00 | NULL                     |</div><div class="line">|  2 | DERIVED     | user       | NULL       | ref    | idx_agentid   | idx_agentid | 5       | const  | 5221432 |   100.00 | Using where; Using index |</div><div class="line">+----+-------------+------------+------------+--------+---------------+-------------+---------+--------+---------+----------+--------------------------+</div></pre></td></tr></table></figure>
<p>在一张数据量为2000万行的表中，真实的查询耗时为<code>0.42 sec</code>。优化后的查询时间是毫秒级别的，速度提升了约180倍。</p>
<h3 id="3-IN-优化"><a href="#3-IN-优化" class="headerlink" title="3. IN 优化"></a>3. IN 优化</h3><h4 id="3-1-案例"><a href="#3-1-案例" class="headerlink" title="3.1 案例"></a>3.1 案例</h4><p>查询二级代理商下的所有用户信息，因测试数据量过大，此处只查询前20条数据。为保证优化前和优化后返回相同的数据列表，这里增加了根据主键排序的条件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> agent_id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> <span class="keyword">agent</span> <span class="keyword">WHERE</span> <span class="keyword">level</span> = <span class="number">2</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">LIMIT</span> <span class="number">20</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+-------------------+-------------+---------+---------------+------+----------+----------------------------------------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys     | key         | key_len | ref           | rows | filtered | Extra                                        |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+-------------------+-------------+---------+---------------+------+----------+----------------------------------------------+</span></div><div class="line">|  1 | SIMPLE      | agent | NULL       | ref  | PRIMARY,idx_level | idx_level   | 5       | const         |    3 |   100.00 | Using index; Using temporary; Using filesort |</div><div class="line">|  1 | SIMPLE      | user  | NULL       | ref  | idx_agentid       | idx_agentid | 5       | test.agent.id | 3433 |   100.00 | NULL                                         |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+-------------------+-------------+---------+---------------+------+----------+----------------------------------------------+</span></div></pre></td></tr></table></figure>
<p>代理商表6行数据，用户表2000万行数据，真实的查询耗时为<code>13 min 14.73 sec</code>，极慢，无法忍受。</p>
<p>通过<a href="https://fanlychie.github.io/post/mysql-index.html#optimizer_trace" target="_blank" rel="external">trace分析优化器是如何选择执行计划</a>的：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql_in_nested_join.png" alt=""></p>
<p>可以看到，MySQL优化器认为使用<code>JOIN</code>的方式能够更高效率的查找到数据行，因此内部将查询语句改写成了<code>SEMI JOIN</code>（半连接）。也由此可见，在MySQL中，半连接优化的效率也未必高。</p>
<h4 id="3-2-优化"><a href="#3-2-优化" class="headerlink" title="3.2 优化"></a>3.2 优化</h4><p>思路：<code>IN</code>查询的性能很糟糕，建议使用<code>EXISTS</code>来等效的改写查询以获得更好的查询性能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> <span class="keyword">agent</span> <span class="keyword">WHERE</span> <span class="keyword">level</span> = <span class="number">2</span> <span class="keyword">AND</span> user.agent_id = agent.id) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">LIMIT</span> <span class="number">20</span>;</div><div class="line">+<span class="comment">----+--------------------+-------+------------+--------+-------------------+---------+---------+--------------------+------+----------+-------------+</span></div><div class="line">| id | select_type        | table | partitions | type   | possible_keys     | key     | key_len | ref                | rows | filtered | Extra       |</div><div class="line">+<span class="comment">----+--------------------+-------+------------+--------+-------------------+---------+---------+--------------------+------+----------+-------------+</span></div><div class="line">|  1 | PRIMARY            | user  | NULL       | index  | NULL              | PRIMARY | 4       | NULL               |   20 |   100.00 | Using where |</div><div class="line">|  2 | DEPENDENT SUBQUERY | agent | NULL       | eq_ref | PRIMARY,idx_level | PRIMARY | 4       | test.user.agent_id |    1 |    60.00 | Using where |</div><div class="line">+<span class="comment">----+--------------------+-------+------------+--------+-------------------+---------+---------+--------------------+------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>代理商表6行数据，用户表2000万行数据，真实的查询耗时为<code>0.02 sec</code>，提升效率是显而易见的。</p>
<h4 id="3-3-案例"><a href="#3-3-案例" class="headerlink" title="3.3 案例"></a>3.3 案例</h4><p>上面是涉及关联子查询的情况，如果<code>IN</code>后面是常量而非子查询的情况，效率是很客观的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> agent_id <span class="keyword">IN</span>(<span class="number">2</span>, <span class="number">3</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">LIMIT</span> <span class="number">20</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | user  | NULL       | index | idx_agentid   | PRIMARY | 4       | NULL |   41 |    48.58 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>在一张数据量为2000万行的表中，真实的查询耗时基本为<code>0.00 sec</code>（没有查询缓存）。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MySQL版本：&lt;/p&gt;
&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;VERSION&lt;/span&gt;();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| VERSION()  |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| 5.7.21-log |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------+&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;建表语句：&lt;/p&gt;
&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;`user`&lt;/span&gt; (&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;`id`&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt; AUTO_INCREMENT &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;主键&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;`agent_id`&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;代理商ID&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;`name`&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;姓名&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;`score`&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;0&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;积分&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  PRIMARY &lt;span class=&quot;keyword&quot;&gt;KEY&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;`id`&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;) &lt;span class=&quot;keyword&quot;&gt;ENGINE&lt;/span&gt;=&lt;span class=&quot;keyword&quot;&gt;InnoDB&lt;/span&gt; AUTO_INCREMENT=&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;CHARSET&lt;/span&gt;=utf8 &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&#39;用户表&#39;&lt;/span&gt;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;`agent`&lt;/span&gt; (&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;`id`&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt; AUTO_INCREMENT &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;主键&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;`name`&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;名称&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;`level`&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;级别&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  PRIMARY &lt;span class=&quot;keyword&quot;&gt;KEY&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;`id`&lt;/span&gt;),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;KEY&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;`idx_level`&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;`level`&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;) &lt;span class=&quot;keyword&quot;&gt;ENGINE&lt;/span&gt;=&lt;span class=&quot;keyword&quot;&gt;InnoDB&lt;/span&gt; AUTO_INCREMENT=&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;CHARSET&lt;/span&gt;=utf8 &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&#39;代理商&#39;&lt;/span&gt;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 索引</title>
    <link href="http://yoursite.com/post/mysql-index.html"/>
    <id>http://yoursite.com/post/mysql-index.html</id>
    <published>2018-03-25T04:01:42.000Z</published>
    <updated>2018-04-17T04:57:37.545Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-索引"><a href="#1-索引" class="headerlink" title="1. 索引"></a>1. 索引</h3><p>索引是数据库查询优化最常用的方式之一，合理的建立索引能够加速数据库数据的读取效率，但这不意味着索引越多越好。索引越多，更新（增删改）数据的速度越慢，如果索引建立的不合理可能会适得其反拖慢数据库的响应速度。常见的索引类型有：</p>
<table>
<thead>
<tr>
<th style="text-align:center">索引类型</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">普通索引</td>
<td style="text-align:left">它没有任何的限制条件，是最基础的索引类型。</td>
</tr>
<tr>
<td style="text-align:center">唯一索引</td>
<td style="text-align:left">它要求字段的值必须是唯一的。</td>
</tr>
<tr>
<td style="text-align:center">主键索引</td>
<td style="text-align:left">它是一种特殊的唯一索引，不允许为空，MySQL会自动的为表的主键创建主键索引。</td>
</tr>
<tr>
<td style="text-align:center">复合索引<br>（多列索引）</td>
<td style="text-align:left">它可以为表的多个列创建一个索引，一个复合索引最多可以包含16个列。</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h4 id="1-1-创建索引"><a href="#1-1-创建索引" class="headerlink" title="1.1 创建索引"></a>1.1 创建索引</h4><p>数据库版本：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">VERSION</span>();</div><div class="line">+<span class="comment">------------+</span></div><div class="line">| version()  |</div><div class="line">+<span class="comment">------------+</span></div><div class="line">| 5.7.21-log |</div><div class="line">+<span class="comment">------------+</span></div></pre></td></tr></table></figure>
<p>数据库建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`emp`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</div><div class="line">  <span class="string">`dept_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'部门ID'</span>,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</div><div class="line">  <span class="string">`tel`</span> <span class="built_in">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'电话'</span>,</div><div class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮件'</span>,</div><div class="line">  <span class="string">`salary`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'薪资'</span>,</div><div class="line">  <span class="string">`birthday`</span> <span class="built_in">date</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'生日'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=gbk <span class="keyword">COMMENT</span>=<span class="string">'员工表'</span>;</div></pre></td></tr></table></figure>
<h5 id="1-1-1-普通索引"><a href="#1-1-1-普通索引" class="headerlink" title="1.1.1 普通索引"></a>1.1.1 普通索引</h5><p>语法：<code>CREATE INDEX index_name ON tb_name(index_col_name)</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_deptid <span class="keyword">ON</span> emp(dept_id);</div></pre></td></tr></table></figure>
<h5 id="1-1-2-唯一索引"><a href="#1-1-2-唯一索引" class="headerlink" title="1.1.2 唯一索引"></a>1.1.2 唯一索引</h5><p>语法：<code>CREATE UNIQUE INDEX index_name ON tb_name(index_col_name)</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> idx_unique_tel <span class="keyword">ON</span> emp(tel);</div></pre></td></tr></table></figure>
<h5 id="1-1-2-复合索引"><a href="#1-1-2-复合索引" class="headerlink" title="1.1.2 复合索引"></a>1.1.2 复合索引</h5><p>语法：<code>CREATE INDEX index_name ON tb_name(index_col_name, ...)</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name_email <span class="keyword">ON</span> emp(<span class="keyword">name</span>, email);</div></pre></td></tr></table></figure>
<h4 id="1-2-删除索引"><a href="#1-2-删除索引" class="headerlink" title="1.2 删除索引"></a>1.2 删除索引</h4><p>语法：<code>DROP INDEX index_name ON tb_name</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> idx_deptid <span class="keyword">ON</span> emp;</div></pre></td></tr></table></figure>
<h4 id="1-3-查看索引"><a href="#1-3-查看索引" class="headerlink" title="1.3 查看索引"></a>1.3 查看索引</h4><p>语法：<code>SHOW INDEX FROM tb_name</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">INDEX</span> <span class="keyword">FROM</span> emp;</div><div class="line">+<span class="comment">-------+------------+--------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div><div class="line">| Table | Non_unique | Key_name                 | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | <span class="keyword">Comment</span> | Index_comment |</div><div class="line">+<span class="comment">-------+------------+--------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div><div class="line">| emp   |          <span class="number">0</span> | PRIMARY                  |            <span class="number">1</span> | <span class="keyword">id</span>          | A         |     <span class="number">1989769</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</div><div class="line">| emp   |          <span class="number">0</span> | idx_unique_tel           |            <span class="number">1</span> | tel         | A         |     <span class="number">1989769</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   | YES  | BTREE      |         |               |</div><div class="line">| emp   |          <span class="number">1</span> | idx_name_email           |            <span class="number">1</span> | <span class="keyword">name</span>        | A         |     <span class="number">1986892</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   | YES  | BTREE      |         |               |</div><div class="line">| emp   |          <span class="number">1</span> | idx_name_email           |            <span class="number">2</span> | email       | A         |     <span class="number">1989769</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   | YES  | BTREE      |         |               |</div><div class="line">+<span class="comment">-------+------------+--------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></div></pre></td></tr></table></figure>
<h4 id="1-4-使用索引"><a href="#1-4-使用索引" class="headerlink" title="1.4 使用索引"></a>1.4 使用索引</h4><p>下面列举几种MySQL查询优化器可以选择使用索引的常见场景。为排除其它索引项的干扰，下面每在分析一条查询语句的执行计划前都假设表还没有建立过索引，相应的建索引语句也将在分析前依次给出。</p>
<h5 id="1-4-1-最左前缀"><a href="#1-4-1-最左前缀" class="headerlink" title="1.4.1 最左前缀"></a>1.4.1 最左前缀</h5><p>最左前缀匹配原则是相对于复合索引（多列索引）而言的。假设现有查询SQL如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name <span class="keyword">WHERE</span> col1 = val1 <span class="keyword">AND</span> col2 = val2 <span class="keyword">AND</span> col3 = val3;</div></pre></td></tr></table></figure>
<p>如果在col1列和col2列和col3列分别建立单独的索引，由于MySQL在执行查询时通常只会使用到一个索引项，因此它会尝试使用索引合并或选择一个最严格的可以排除更多的行以得到更少结果的索引来优化查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name <span class="keyword">ON</span> emp(<span class="keyword">name</span>);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_deptid <span class="keyword">ON</span> emp(dept_id);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_birthday <span class="keyword">ON</span> emp(birthday);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'秋田函'</span> <span class="keyword">AND</span> dept_id = <span class="number">2</span> <span class="keyword">AND</span> birthday = <span class="string">'1994-09-02'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------------+-----------------------------------+-----------------------+---------+------+------+----------+-----------------------------------------------------+</span></div><div class="line">| id | select_type | table | partitions | type        | possible_keys                     | key                   | key_len | ref  | rows | filtered | Extra                                               |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------------+-----------------------------------+-----------------------+---------+------+------+----------+-----------------------------------------------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | index_merge | idx_name,idx_deptid,idx_birthday | idx_name,idx_birthday | 66,3    | NULL |    1 |    21.32 | Using intersect(idx_name,idx_birthday); Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------------+-----------------------------------+-----------------------+---------+------+------+----------+-----------------------------------------------------+</span></div></pre></td></tr></table></figure>
<p>如果在col1列和col2列和col3列上建立一个复合索引 (col1, col2, col3)，根据最左前缀匹配原则，过滤筛选条件只要是在 (col1)、(col1, col2)、(col1, col2, col3) 列上的都会具有索引检索的功能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name_deptid_birthday <span class="keyword">ON</span> emp(<span class="keyword">name</span>, dept_id, birthday);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'秋田函'</span> <span class="keyword">AND</span> dept_id = <span class="number">2</span> <span class="keyword">AND</span> birthday = <span class="string">'1994-09-02'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+--------------------------+--------------------------+---------+-------------------+------+----------+-------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys            | key                      | key_len | ref               | rows | filtered | Extra |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+--------------------------+--------------------------+---------+-------------------+------+----------+-------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ref  | idx_name_deptid_birthday | idx_name_deptid_birthday | 73      | const,const,const |    1 |   100.00 | NULL  |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+--------------------------+--------------------------+---------+-------------------+------+----------+-------+</span></div></pre></td></tr></table></figure>
<p>复合索引可以看成是一个有序的数组，最左前缀匹配原则是只有在匹配 (col1) 列的前提下，才可以继续匹配下一个有序项 (col2) 。它不能直接匹配 (col2) 或 (col2, col3)。如果条件检索的列不能满足最左前缀匹配原则，则不会使用索引进行结果查找。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> dept_id = <span class="number">2</span> <span class="keyword">AND</span> birthday = <span class="string">'1994-09-02'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 1952590 |     1.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-4-2-全值匹配"><a href="#1-4-2-全值匹配" class="headerlink" title="1.4.2 全值匹配"></a>1.4.2 全值匹配</h5><p>全值匹配原则是相对于复合索引（多列索引）而言的。即索引中的所有列在<code>WHERE</code>子句中都有对应的字段检索条件。在此前提下，即便没有满足复合索引的最左前缀匹配原则，MySQL的查询优化器也会自动的对<code>WHERE</code>子句中的字段检索条件顺序做出相应的调整以至于能够使用合适的索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name_deptid_birthday <span class="keyword">ON</span> emp(<span class="keyword">name</span>, dept_id, birthday);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> dept_id = <span class="number">2</span> <span class="keyword">AND</span> <span class="keyword">name</span> = <span class="string">'秋田函'</span> <span class="keyword">AND</span> birthday = <span class="string">'1994-09-02'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+--------------------------+--------------------------+---------+-------------------+------+----------+-------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys            | key                      | key_len | ref               | rows | filtered | Extra |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+--------------------------+--------------------------+---------+-------------------+------+----------+-------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ref  | idx_name_deptid_birthday | idx_name_deptid_birthday | 73      | const,const,const |    1 |   100.00 | NULL  |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+--------------------------+--------------------------+---------+-------------------+------+----------+-------+</span></div></pre></td></tr></table></figure>
<h5 id="1-4-3-范围查询"><a href="#1-4-3-范围查询" class="headerlink" title="1.4.3 范围查询"></a>1.4.3 范围查询</h5><p>对索引的值进行范围查找，常见于<code>&gt;</code>、<code>&gt;=</code>、<code>&lt;</code>、<code>&lt;=</code>、<code>!=</code>、<code>IN</code>、<code>BETWEEN</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">2</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL | 994884 |   100.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-4-4-覆盖索引"><a href="#1-4-4-覆盖索引" class="headerlink" title="1.4.4 覆盖索引"></a>1.4.4 覆盖索引</h5><p>如果查询的列正好都是索引列，这就意味着，查询所需的数据直接从索引树中就能够获得，而不需要再通过索引回表查询。这样可以减少I/O，提升效率。如果一个查询只需要访问索引树就能获得查询所需的所有数据，我们就称使用了覆盖索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name <span class="keyword">ON</span> emp(<span class="keyword">name</span>);</div></pre></td></tr></table></figure>
<p>以下查询语句中因使用了条件<code>!=</code>，导致MySQL进行全表扫描而放弃走索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> != <span class="string">'秋田函'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | idx_name      | NULL | NULL    | NULL | 1989769 |   100.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>将<code>SELECT *</code>改为<code>SELECT 索引列</code>后，MySQL走上了索引，其<code>Extra</code>中的<code>Using index</code>就是覆盖索引扫描，通过条件过滤检索出来的结果不需要再回表获取额外的数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> != <span class="string">'秋田函'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+---------+----------+--------------------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key      | key_len | ref  | rows    | filtered | Extra                    |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+---------+----------+--------------------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | index | idx_name      | idx_name | 67      | NULL | 1989769 |   100.00 | Using where; Using index |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+---------+----------+--------------------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-4-5-列前缀匹配"><a href="#1-4-5-列前缀匹配" class="headerlink" title="1.4.5 列前缀匹配"></a>1.4.5 列前缀匹配</h5><p>列前缀匹配是指检索条件中使用了索引的开始一部分内容进行查找，形式通常是<code>LIKE &#39;限定字符%&#39;</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name <span class="keyword">ON</span> emp(<span class="keyword">name</span>);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'秋田%'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key      | key_len | ref  | rows | filtered | Extra                 |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | range | idx_name      | idx_name | 67      | NULL |    6 |   100.00 | Using index condition |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span></div></pre></td></tr></table></figure>
<h4 id="1-5-索引失效"><a href="#1-5-索引失效" class="headerlink" title="1.5 索引失效"></a>1.5 索引失效</h4><p>下面列举几种索引存在但是不能被MySQL查询优化器选择使用的常见场景。</p>
<h5 id="1-5-1-以-开头的LIKE查询"><a href="#1-5-1-以-开头的LIKE查询" class="headerlink" title="1.5.1 以%开头的LIKE查询"></a>1.5.1 以%开头的LIKE查询</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name <span class="keyword">ON</span> emp(<span class="keyword">name</span>);</div></pre></td></tr></table></figure>
<p>以<code>%限定字符</code>或<code>%限定字符%</code>进行的<code>LIKE</code>查询都会导致查询无法使用索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%秋田'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 1989769 |    11.11 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>使用覆盖索引扫描进行优化：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">id</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%秋田'</span>);</div><div class="line">+<span class="comment">----+-------------+-------+------------+--------+---------------+----------+---------+-------------+---------+----------+--------------------------+</span></div><div class="line">| id | select_type | table | partitions | type   | possible_keys | key      | key_len | ref         | rows    | filtered | Extra                    |</div><div class="line">+<span class="comment">----+-------------+-------+------------+--------+---------------+----------+---------+-------------+---------+----------+--------------------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | index  | PRIMARY       | idx_name | 67      | NULL        | 1989769 |    11.11 | Using where; Using index |</div><div class="line">|  1 | SIMPLE      | emp   | NULL       | eq_ref | PRIMARY       | PRIMARY  | 4       | test.emp.id |       1 |   100.00 | NULL                     |</div><div class="line">+<span class="comment">----+-------------+-------+------------+--------+---------------+----------+---------+-------------+---------+----------+--------------------------+</span></div></pre></td></tr></table></figure>
<p>在一张200万条数据的表中，原查询耗时<code>5.21 sec</code>，优化后的查询耗时<code>2.23 sec</code>。</p>
<h5 id="1-5-2-数据类型出现隐式转换时"><a href="#1-5-2-数据类型出现隐式转换时" class="headerlink" title="1.5.2 数据类型出现隐式转换时"></a>1.5.2 数据类型出现隐式转换时</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> idx_unique_tel <span class="keyword">ON</span> emp(tel);</div></pre></td></tr></table></figure>
<p>特别是字符串类型，如果缺少引号就会导致查询出现数据类型的隐式转换，致使无法正常使用索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> tel = <span class="number">15873225085</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys  | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | idx_unique_tel | NULL | NULL    | NULL | 1989769 |    10.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>给字符串常量加上引号之后，就可以正确的使用索引了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> tel = <span class="string">'15873225085'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------+------+----------+-------+</span></div><div class="line">| id | select_type | table | partitions | type  | possible_keys  | key            | key_len | ref   | rows | filtered | Extra |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------+------+----------+-------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | const | idx_unique_tel | idx_unique_tel | 23      | const |    1 |   100.00 | NULL  |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------+------+----------+-------+</span></div></pre></td></tr></table></figure>
<h5 id="1-5-3-不满足最左前缀匹配原则"><a href="#1-5-3-不满足最左前缀匹配原则" class="headerlink" title="1.5.3 不满足最左前缀匹配原则"></a>1.5.3 不满足最左前缀匹配原则</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name_deptid_birthday <span class="keyword">ON</span> emp(<span class="keyword">name</span>, dept_id, birthday);</div></pre></td></tr></table></figure>
<p>在复合索引（多列索引）的场景下，如果检索的列不能满足最左前缀匹配原则，则不会使用复合索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> dept_id = <span class="number">2</span> <span class="keyword">AND</span> birthday = <span class="string">'1994-09-02'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 1952590 |     1.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-5-4-出现OR条件查询"><a href="#1-5-4-出现OR条件查询" class="headerlink" title="1.5.4 出现OR条件查询"></a>1.5.4 出现OR条件查询</h5><p>如果查询语句中出现OR，除非OR前后的列都是索引项，否则不能使用索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> idx_unique_tel <span class="keyword">ON</span> emp(tel);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> tel = <span class="string">'18993283686'</span> <span class="keyword">or</span> <span class="keyword">name</span> = <span class="string">'秋田函'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys  | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | idx_unique_tel | NULL | NULL    | NULL | 1989769 |    10.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+----------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>如果为<code>name</code>列也加上一个单独的索引（或使用复合索引），查询就可以正常使用索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name <span class="keyword">ON</span> emp(<span class="keyword">name</span>);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">XPLAIN <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> tel = <span class="string">'18993283686'</span> <span class="keyword">or</span> <span class="keyword">name</span> = <span class="string">'秋田函'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------------+-------------------------+-------------------------+---------+------+------+----------+---------------------------------------------------+</span></div><div class="line">| id | select_type | table | partitions | type        | possible_keys           | key                     | key_len | ref  | rows | filtered | Extra                                             |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------------+-------------------------+-------------------------+---------+------+------+----------+---------------------------------------------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | index_merge | idx_unique_tel,idx_name | idx_unique_tel,idx_name | 23,67   | NULL |    4 |   100.00 | Using union(idx_unique_tel,idx_name); Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+-------------+-------------------------+-------------------------+---------+------+------+----------+---------------------------------------------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-5-5-在索引列上做计算或函数操作"><a href="#1-5-5-在索引列上做计算或函数操作" class="headerlink" title="1.5.5 在索引列上做计算或函数操作"></a>1.5.5 在索引列上做计算或函数操作</h5><p>如果在索引列上进行运算或对索引列使用函数操作，也会导致索引失效：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_birthday <span class="keyword">ON</span> emp(birthday);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">DATE_FORMAT</span>(birthday, <span class="string">'%Y'</span>) - <span class="keyword">DATE_FORMAT</span>(<span class="keyword">NOW</span>(), <span class="string">'%Y'</span>) = <span class="number">18</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 1989769 |   100.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-5-6-使用-判断条件"><a href="#1-5-6-使用-判断条件" class="headerlink" title="1.5.6 使用!=判断条件"></a>1.5.6 使用!=判断条件</h5><p>如果在索引列上使用<code>!=</code>进行条件判断，也会导致索引失效：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_name <span class="keyword">ON</span> emp(<span class="keyword">name</span>);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> <span class="keyword">name</span> != <span class="string">'秋田函'</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | idx_name      | NULL | NULL    | NULL | 1989769 |   100.00 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<h5 id="1-5-7-如果MySQL估算全表扫描比索引快时"><a href="#1-5-7-如果MySQL估算全表扫描比索引快时" class="headerlink" title="1.5.7 如果MySQL估算全表扫描比索引快时"></a>1.5.7 如果MySQL估算全表扫描比索引快时</h5><p>当MySQL估算全表扫描比索引快时，则不会使用索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_deptid <span class="keyword">ON</span> emp(dept_id);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> dept_id &lt; <span class="number">2</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | idx_deptid    | NULL | NULL    | NULL | 1989769 |    23.21 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>通过开启<code>optimizer_trace</code>可以跟踪优化器在整个执行计划中是如何选择最优方案的。</p>
<p><span id="optimizer_trace">查看<code>optimizer_trace</code>相关参数配置：</span></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'%optimizer_trace%'</span>;</div><div class="line">+<span class="comment">------------------------------+----------------------------------------------------------------------------+</span></div><div class="line">| Variable_name                | Value                                                                      |</div><div class="line">+<span class="comment">------------------------------+----------------------------------------------------------------------------+</span></div><div class="line">| optimizer_trace              | enabled=off,one_line=off                                                    |</div><div class="line">| optimizer_trace_features     | greedy_search=on,range_optimizer=on,dynamic_range=on,repeated_subselect=on |</div><div class="line">| optimizer_trace_limit        | 1                                                                          |</div><div class="line">| optimizer_trace_max_mem_size | 16384                                                                      |</div><div class="line">| optimizer_trace_offset       | -1                                                                         |</div><div class="line">+<span class="comment">------------------------------+----------------------------------------------------------------------------+</span></div></pre></td></tr></table></figure>
<p>可以看到<code>optimizer_trace</code>选项的<code>enabled=off</code>，默认是关闭的。开启<code>optimizer_trace</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> optimizer_trace=<span class="string">"enabled=on"</span>;</div></pre></td></tr></table></figure>
<p>开启之后，首先先执行一个查询SQL的执行计划：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> dept_id &lt; <span class="number">2</span>;</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | idx_deptid    | NULL | NULL    | NULL | 1989769 |    23.21 | Using where |</div><div class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span></div></pre></td></tr></table></figure>
<p>然后查看优化器在整个执行计划中是如何选择最优方案的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> information_schema.optimizer_trace\G</div></pre></td></tr></table></figure>
<p>下面是全表扫描估计要访问的记录行数以及代价计算：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">"table_scan": &#123;</div><div class="line">    "rows": 1989769,</div><div class="line">    "cost": 410416</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是索引扫描估计要访问的记录行数以及代价计算：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">"range_scan_alternatives": [</div><div class="line">    &#123;</div><div class="line">        "index": "idx_deptid",</div><div class="line">        "ranges": [</div><div class="line">            "NULL &lt; dept_id &lt; 2"</div><div class="line">        ],</div><div class="line">        "index_dives_for_eq_ranges": true,</div><div class="line">        "rowid_ordered": false,</div><div class="line">        "using_mrr": false,</div><div class="line">        "index_only": false,</div><div class="line">        "rows": 461886,</div><div class="line">        "cost": 554264,</div><div class="line">        "chosen": false,</div><div class="line">        "cause": "cost"</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>索引的代价计算（cost）为<code>554264</code>，全表扫描的代价计算（cost）为<code>410416</code>。可见，索引的代价计算要高于全表扫描的代价。因此，优化器更倾向于选择全表扫描。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-索引&quot;&gt;&lt;a href=&quot;#1-索引&quot; class=&quot;headerlink&quot; title=&quot;1. 索引&quot;&gt;&lt;/a&gt;1. 索引&lt;/h3&gt;&lt;p&gt;索引是数据库查询优化最常用的方式之一，合理的建立索引能够加速数据库数据的读取效率，但这不意味着索引越多越好。索引越多，更新（增删改）数据的速度越慢，如果索引建立的不合理可能会适得其反拖慢数据库的响应速度。常见的索引类型有：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;索引类型&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;普通索引&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;它没有任何的限制条件，是最基础的索引类型。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;唯一索引&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;它要求字段的值必须是唯一的。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;主键索引&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;它是一种特殊的唯一索引，不允许为空，MySQL会自动的为表的主键创建主键索引。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;复合索引&lt;br&gt;（多列索引）&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;它可以为表的多个列创建一个索引，一个复合索引最多可以包含16个列。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>MySQL Explain 分析 SQL 的执行计划</title>
    <link href="http://yoursite.com/post/mysql-explain.html"/>
    <id>http://yoursite.com/post/mysql-explain.html</id>
    <published>2018-03-23T15:52:17.000Z</published>
    <updated>2018-04-08T10:00:24.321Z</updated>
    
    <content type="html"><![CDATA[<p><code>explain</code>提供了MySQL是如何执行语句的详细信息，开发人员可以根据这些信息对执行的语句进行性能方面的优化。<code>explain</code>可以与<code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code>语句一起使用。</p>
<h3 id="1-MySQL-版本"><a href="#1-MySQL-版本" class="headerlink" title="1. MySQL 版本"></a>1. MySQL 版本</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select version();</div><div class="line">+------------+</div><div class="line">| version()  |</div><div class="line">+------------+</div><div class="line">| 5.7.21-log |</div><div class="line">+------------+</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="2-explain-格式"><a href="#2-explain-格式" class="headerlink" title="2. explain 格式"></a>2. explain 格式</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select * from emp;</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------+</div><div class="line">|  1 | SIMPLE      | emp   | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 503106 |   100.00 | NULL  |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------+</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">查询语句标识符。数值越大优先级别越高，就越先执行。如果数值一样，则由上至下依次执行。NULL值表示这是一个结果集，不需要参与查询。</td>
</tr>
<tr>
<td style="text-align:left">select_type</td>
<td style="text-align:left">查询类型。常见的有：<br>1) <code>SIMPLE</code><br><span style="padding-left:14px">&nbsp;</span>简单的SELECT查询。没有UNION或子查询。<br>2) <code>PRIMARY</code><br><span style="padding-left:14px">&nbsp;</span>最外层的SELECT语句。<br>3) <code>UNION</code><br><span style="padding-left:14px">&nbsp;</span>UNION语句中的第二个或后面的查询。<br>4) <code>DEPENDENT UNION</code><br><span style="padding-left:14px">&nbsp;</span>UNION语句中的第二个或后面的查询。取决于外层的查询。<br>5) <code>UNION RESULT</code><br><span style="padding-left:14px">&nbsp;</span>UNION的结果集。<br>6) <code>SUBQUERY</code><br><span style="padding-left:14px">&nbsp;</span>子查询中的第一个SELECT。<br>7) <code>DEPENDENT SUBQUERY</code><br><span style="padding-left:14px">&nbsp;</span>子查询中的第一个SELECT。取决于外层的查询。<br>8) <code>DERIVED</code><br><span style="padding-left:14px">&nbsp;</span>FROM子句中出现的子查询。也叫派生表。</td>
</tr>
<tr>
<td style="text-align:left">table</td>
<td style="text-align:left">查询的表名。<br>1) 如果查询使用了别名，则显示该别名；<br>2) 如果不涉及对数据表的操作，则显示NULL；<br>3) <code>&lt;unionM,N&gt;</code> 表示引用id为M和N的执行计划UNION的结果；<br>4) <code>&lt;derivedN&gt;</code>  表示引用id为N的执行计划中派生的表（临时表）；<br>5) <code>&lt;subqueryN&gt;</code> 表示引用id为N的子查询的结果；</td>
</tr>
<tr>
<td style="text-align:left">partitions</td>
<td style="text-align:left">使用的表分区。如果没有分区，则显示NULL。</td>
</tr>
<tr>
<td style="text-align:left">type</td>
<td style="text-align:left">关联类型。MySQL会认为任何查询都是关联查询，其性能从最好到最差依次为：<br>1) <code>system</code><br><span style="padding-left:14px">&nbsp;</span>表中仅有一行数据。它是<code>const</code>的一个特列。<br>2) <code>const</code><br><span style="padding-left:14px">&nbsp;</span>表中最多只有一个与之匹配的行。常见于使用唯一索引和常量值进行比较时。<br>3) <code>eq_ref</code><br><span style="padding-left:14px">&nbsp;</span>当多表链接使用非空唯一索引作为关联条件的时候。 <br>4) <code>ref</code><br><span style="padding-left:14px">&nbsp;</span>当使用唯一索引的最左前缀或非唯一索引时。<br>5) <code>fulltext</code><br><span style="padding-left:14px">&nbsp;</span>使用全文索引进行关联。<br>6) <code>ref_or_null</code><br><span style="padding-left:14px">&nbsp;</span>和ref相似，另外MySQL还会检索值为NULL的行。<br>7) <code>index_merge</code><br><span style="padding-left:14px">&nbsp;</span>使用了索引合并优化。<br>8) <code>unique_subquery</code><br><span style="padding-left:14px">&nbsp;</span>发生在IN子查询中，且子查询使用唯一索引。其形式为：<br><span style="padding-left:14px">&nbsp;</span>value IN (SELECT primary_key FROM single_table WHERE some_expr)<br>9) <code>index_subquery</code><br><span style="padding-left:14px">&nbsp;</span>与unique_subquery关联类型相似，其子查询使用的是非唯一索引，其形式为：<br><span style="padding-left:14px">&nbsp;</span>value IN (SELECT key_column FROM single_table WHERE some_expr)<br>10) <code>rang</code><br><span style="padding-left:25px">&nbsp;</span>只检索给定范围的行。常见于：<br><span style="padding-left:25px">&nbsp;</span>=，&lt;&gt;，&gt;，&gt;=，&lt;，&lt;=，BETWEEN，IN<br>11) <code>index</code><br><span style="padding-left:25px">&nbsp;</span>该关联类型与ALL相同，它扫描整个索引树，但通常比ALL要快。<br>12) <code>ALL</code><br><span style="padding-left:25px">&nbsp;</span>全表扫描，这是最慢的一种关联类型。</td>
</tr>
<tr>
<td style="text-align:left">possible_keys</td>
<td style="text-align:left">查询中可能用到的索引。这些索引实际中可能并没有用到。如果值是NULL，则表明查询没有用到索引，此时可以检查WHERE子句中哪些列适合加索引以提高查询的性能。</td>
</tr>
<tr>
<td style="text-align:left">key</td>
<td style="text-align:left">查询中实际用到的索引。如果值是NULL，则表明MySQL找不到更有效的索引来执行查询。</td>
</tr>
<tr>
<td style="text-align:left">key_len</td>
<td style="text-align:left">使用到的索引的长度。</td>
</tr>
<tr>
<td style="text-align:left">ref</td>
<td style="text-align:left">使用哪些列或常量可以与索引列一起从表中选择行。</td>
</tr>
<tr>
<td style="text-align:left">rows</td>
<td style="text-align:left">MySQL认为执行此查询需要检查的行数。对于InnoDB表来说，这是一个估算值，并不准确。该值越小越好。</td>
</tr>
<tr>
<td style="text-align:left">filtered</td>
<td style="text-align:left">通过条件过滤出的行数的百分比估计值。</td>
</tr>
<tr>
<td style="text-align:left">Extra</td>
<td style="text-align:left">显示MySQL是如何解析查询语句的其它信息。</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;explain&lt;/code&gt;提供了MySQL是如何执行语句的详细信息，开发人员可以根据这些信息对执行的语句进行性能方面的优化。&lt;code&gt;explain&lt;/code&gt;可以与&lt;code&gt;SELECT&lt;/code&gt;、&lt;code&gt;INSERT&lt;/code&gt;、&lt;code&gt;UPDATE&lt;/code&gt;、&lt;code&gt;DELETE&lt;/code&gt;语句一起使用。&lt;/p&gt;
&lt;h3 id=&quot;1-MySQL-版本&quot;&gt;&lt;a href=&quot;#1-MySQL-版本&quot; class=&quot;headerlink&quot; title=&quot;1. MySQL 版本&quot;&gt;&lt;/a&gt;1. MySQL 版本&lt;/h3&gt;&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; select version();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+------------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| version()  |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+------------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| 5.7.21-log |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+------------+&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 查询缓存</title>
    <link href="http://yoursite.com/post/mysql-query-cache.html"/>
    <id>http://yoursite.com/post/mysql-query-cache.html</id>
    <published>2018-03-23T14:33:13.000Z</published>
    <updated>2018-04-17T07:09:44.424Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-版本信息"><a href="#1-版本信息" class="headerlink" title="1. 版本信息"></a>1. 版本信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">VERSION</span>();</div><div class="line">+<span class="comment">------------+</span></div><div class="line">| version()  |</div><div class="line">+<span class="comment">------------+</span></div><div class="line">| 5.7.21-log |</div><div class="line">+<span class="comment">------------+</span></div></pre></td></tr></table></figure>
<h3 id="2-查询缓存参数"><a href="#2-查询缓存参数" class="headerlink" title="2. 查询缓存参数"></a>2. 查询缓存参数</h3><p>可以使用以下命令来查看MySQL查询缓存相关的系统参数配置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'%query_cache%'</span>;</div><div class="line">+<span class="comment">------------------------------+---------+</span></div><div class="line">| Variable_name                | Value   |</div><div class="line">+<span class="comment">------------------------------+---------+</span></div><div class="line">| have_query_cache             | YES     |</div><div class="line">| query_cache_limit            | 1048576 |</div><div class="line">| query_cache_min_res_unit     | 4096    |</div><div class="line">| query_cache_size             | 1048576 |</div><div class="line">| query_cache_type             | OFF     |</div><div class="line">| query_cache_wlock_invalidate | OFF     |</div><div class="line">+<span class="comment">------------------------------+---------+</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">have_query_cache</td>
<td style="text-align:left">表明查询缓存是否可用。当使用标准的MySQL二进制文件时，该项的值始终会显示YES，即使查询缓存已经关闭。</td>
</tr>
<tr>
<td style="text-align:left">query_cache_limit</td>
<td style="text-align:left">缓存单条查询结果的最大空间容量值。超出则不会缓存此次查询的结果。默认是1M (1048576(B)/1024/1024=1M)。</td>
</tr>
<tr>
<td style="text-align:left">query_cache_min_res_unit</td>
<td style="text-align:left">分配缓存区大小的最小单位。当查询的结果被缓存时，MySQL不会一次性将结果缓存到一个大的块中，而是每次分配一块该值大小的空间，使用完之后再分配另外一块，以此类推。<br>默认是4KB (4096(B)/1024=4KB)。注意事项：<br>1) 该参数值如果设置的过大，可能会造成大量的空间未能被完全使用，而产生内存碎片。<br>2) 该参数值如果设置的太小，又可能会增加内存分配次数，进而产生时间上的消耗。</td>
</tr>
<tr>
<td style="text-align:left">query_cache_size</td>
<td style="text-align:left">查询缓存空间的大小。该值设置的如果不是1024的整数倍，MySQL自动调整降低最小量以达到1024的倍数。如果设置为0，则会禁用查询缓存。</td>
</tr>
<tr>
<td style="text-align:left">query_cache_type</td>
<td style="text-align:left">查询缓存的类型。可以用来控制查询缓存的开和关。<br> 1) 0或OFF表示关闭查询缓存；<br>2) 1或ON表示开启查询缓存；<br>3) 2或DEMAND时：<br><span style="padding-left:14px">&nbsp;</span>a) 当SELECT语句中出现SQL_NO_CACHE关键字时则不缓存；<br><span style="padding-left:34px">&nbsp;</span>select SQL_NO_CACHE id, name from tb;<br><span style="padding-left:14px">&nbsp;</span>b) 当出现SQL_CACHE关键字则缓存（默认是SQL_CACHE）。<br><span style="padding-left:34px">&nbsp;</span>select SQL_CACHE id, name from tb;</td>
</tr>
<tr>
<td style="text-align:left">query_cache_wlock_invalidate</td>
<td style="text-align:left">当写锁发生在表上的时，是否先失效该表相关的查询缓存。<br>1) 设置为true，失效该表相关的查询缓存；<br>2) 设置为false，仍然允许读取该表相关的查询缓存；</td>
</tr>
</tbody>
</table>
<h3 id="3-查询缓存性能参数"><a href="#3-查询缓存性能参数" class="headerlink" title="3. 查询缓存性能参数"></a>3. 查询缓存性能参数</h3><p>可以使用以下命令来查看查询缓存的性能参数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Qcache%'</span>;</div><div class="line">+<span class="comment">-------------------------+---------+</span></div><div class="line">| Variable_name           | Value   |</div><div class="line">+<span class="comment">-------------------------+---------+</span></div><div class="line">| Qcache_free_blocks      | 1       |</div><div class="line">| Qcache_free_memory      | 1029312 |</div><div class="line">| Qcache_hits             | 2       |</div><div class="line">| Qcache_inserts          | 2       |</div><div class="line">| Qcache_lowmem_prunes    | 0       |</div><div class="line">| Qcache_not_cached       | 1       |</div><div class="line">| Qcache_queries_in_cache | 2       |</div><div class="line">| Qcache_total_blocks     | 6       |</div><div class="line">+<span class="comment">-------------------------+---------+</span></div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Qcache_free_blocks</td>
<td style="text-align:left">查询缓存中的空闲内存块的数量。如果数值较大，说明有内存碎片产生。可以使用FLUSH QUERY CACHE命令对查询缓存中的内存块进行整理。</td>
</tr>
<tr>
<td style="text-align:left">Qcache_free_memory</td>
<td style="text-align:left">查询缓存中的空闲内存大小。</td>
</tr>
<tr>
<td style="text-align:left">Qcache_hits</td>
<td style="text-align:left">缓存命中的次数。每次命中，该数值+1。</td>
</tr>
<tr>
<td style="text-align:left">Qcache_inserts</td>
<td style="text-align:left">添加到查询缓存中的查询数量。每新缓存一个查询结果，该数值+1。</td>
</tr>
<tr>
<td style="text-align:left">Qcache_lowmem_prunes</td>
<td style="text-align:left">查询缓存可用空间不足时而删除的已缓存的查询的数量。如果数值较大，说明查询缓存的内存空间不足，或产生了大量的内存碎片。</td>
</tr>
<tr>
<td style="text-align:left">Qcache_not_cached</td>
<td style="text-align:left">非缓存查询的数量。每个查询的结果如果不能被缓存，该数值+1。</td>
</tr>
<tr>
<td style="text-align:left">Qcache_queries_in_cache</td>
<td style="text-align:left">查询缓存中的总的查询数量。</td>
</tr>
<tr>
<td style="text-align:left">Qcache_total_blocks</td>
<td style="text-align:left">查询缓存中的块的数量。</td>
</tr>
</tbody>
</table>
<h3 id="4-查询缓存的开启和关闭"><a href="#4-查询缓存的开启和关闭" class="headerlink" title="4. 查询缓存的开启和关闭"></a>4. 查询缓存的开启和关闭</h3><p>MySQL5.7 默认没有开启查询缓存。如果需要开启查询缓存，找到安装目录下的<code>my.ini</code>(Windows)配置文件，添加如下配置，然后重启 MySQL 服务。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">... ...</div><div class="line">... ...</div><div class="line">query_cache_type=1</div></pre></td></tr></table></figure>
<p>或者使用命令行方式，该方式需要退出客户端再登录，才看得见状态改变：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> query_cache_type=<span class="number">1</span>;</div></pre></td></tr></table></figure>
<p><code>set GLOBAL</code>的变更是全局的，如果只想将变更应用于当前的会话，可是使用<code>set SESSION</code>的方式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> query_cache_type=<span class="number">1</span>;</div></pre></td></tr></table></figure>
<h3 id="5-使用查询缓存"><a href="#5-使用查询缓存" class="headerlink" title="5. 使用查询缓存"></a>5. 使用查询缓存</h3><p>MySQL 的查询缓存对查询语句的大小写是敏感的，只有当两个查询语句完全一致时，才会命中缓存。</p>
<p>第一次查询一张100万条数据的表，耗时1.63秒：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SELECT COUNT(*) FROM emp;</div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|  1000000 |</div><div class="line">+----------+</div><div class="line">1 row in set (1.63 sec)</div></pre></td></tr></table></figure>
<p>第二次查询同一张表，耗时为0，可见是直接命中查询缓存：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SELECT COUNT(*) FROM emp;</div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|  1000000 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>第三次查询将<code>SELECT</code>改写成<code>select</code>，耗时1.57秒，可见并没有命中缓存：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">select COUNT(*) FROM emp;</div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|  1000000 |</div><div class="line">+----------+</div><div class="line">1 row in set (1.57 sec)</div></pre></td></tr></table></figure>
<h3 id="6-整理查询缓存"><a href="#6-整理查询缓存" class="headerlink" title="6. 整理查询缓存"></a>6. 整理查询缓存</h3><p>用于对查询缓存的内存块进行整理，减少内存碎片：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FLUSH</span> <span class="keyword">QUERY</span> <span class="keyword">CACHE</span>;</div></pre></td></tr></table></figure>
<h3 id="6-清除查询缓存"><a href="#6-清除查询缓存" class="headerlink" title="6. 清除查询缓存"></a>6. 清除查询缓存</h3><p>用于清除所有缓存的查询缓存结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">RESET</span> <span class="keyword">QUERY</span> <span class="keyword">CACHE</span>;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-版本信息&quot;&gt;&lt;a href=&quot;#1-版本信息&quot; class=&quot;headerlink&quot; title=&quot;1. 版本信息&quot;&gt;&lt;/a&gt;1. 版本信息&lt;/h3&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;VERSION&lt;/span&gt;();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| version()  |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| 5.7.21-log |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------+&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;2-查询缓存参数&quot;&gt;&lt;a href=&quot;#2-查询缓存参数&quot; class=&quot;headerlink&quot; title=&quot;2. 查询缓存参数&quot;&gt;&lt;/a&gt;2. 查询缓存参数&lt;/h3&gt;&lt;p&gt;可以使用以下命令来查看MySQL查询缓存相关的系统参数配置：&lt;/p&gt;
&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;SHOW&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;VARIABLES&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;LIKE&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;%query_cache%&#39;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------------------------+---------+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Variable_name                | Value   |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------------------------+---------+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| have_query_cache             | YES     |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| query_cache_limit            | 1048576 |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| query_cache_min_res_unit     | 4096    |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| query_cache_size             | 1048576 |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| query_cache_type             | OFF     |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| query_cache_wlock_invalidate | OFF     |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+&lt;span class=&quot;comment&quot;&gt;------------------------------+---------+&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>解决命令行无法关闭和启动MySQL服务的问题</title>
    <link href="http://yoursite.com/post/mysql57-resolve-cmd-net-command.html"/>
    <id>http://yoursite.com/post/mysql57-resolve-cmd-net-command.html</id>
    <published>2018-03-18T03:06:03.000Z</published>
    <updated>2018-03-31T03:52:19.557Z</updated>
    
    <content type="html"><![CDATA[<h3 id="命令行关闭和启动服务"><a href="#命令行关闭和启动服务" class="headerlink" title="命令行关闭和启动服务"></a>命令行关闭和启动服务</h3><p>以管理员身份运行<code>cmd</code>，关闭MySQL服务，提示<code>服务名无效</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; net stop mysql</div><div class="line">服务名无效。</div><div class="line"> </div><div class="line">请键入 NET HELPMSG 2185 以获得更多的帮助。</div></pre></td></tr></table></figure>
<p>以管理员身份运行<code>cmd</code>，启动MySQL服务，提示<code>服务名无效</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; net start mysql</div><div class="line">服务名无效。</div><div class="line"> </div><div class="line">请键入 NET HELPMSG 2185 以获得更多的帮助。</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>找到操作系统的服务列表：<code>win + r</code> –&gt; 输入<code>services.msc</code>回车。或：</p>
<p>Win10系统 –&gt; 计算机管理 –&gt; 服务和应用程序 –&gt; 服务。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/os-services.png" alt=""></p>
<p>按字母键<code>m</code>搜索MySQL相关的服务，然后确认服务的名称和服务的路径。</p>
<p>启动服务的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; net start 服务名称</div></pre></td></tr></table></figure>
<p>关闭服务的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; net stop 服务名称</div></pre></td></tr></table></figure>
<p>如启动MySQL57的服务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; net start MySQL57</div><div class="line">MySQL57 服务正在启动 ...</div><div class="line">MySQL57 服务已经启动成功。</div></pre></td></tr></table></figure>
<p>如果在系统的服务列表中没有找到相应的服务。可按如下步骤进行安装服务。</p>
<p>如果是同一台机器上安装了多个MySQL服务，首先，先检查系统的<code>PATH</code>环境变量中是否配置了MySQL路径，如果有，先将其删除。</p>
<p>以管理员身份运行<code>cmd</code>，进入相应的MySQL安装的bin目录，执行<code>mysqld --install 服务名称</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">D:\application\setup\MySQL55\bin&gt;mysqld --install MySQL55</div><div class="line">Service successfully installed</div></pre></td></tr></table></figure>
<p>安装完成之后，你可以在操作系统的服务列表中找到一个名称为MySQL55的服务。可按上面步骤确认该服务的路径是否正确。确认无误后执行启动命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; net start MySQL55</div><div class="line">MySQL57 服务正在启动 ...</div><div class="line">MySQL57 服务已经启动成功。</div></pre></td></tr></table></figure>
<p>如果想要卸载某个服务，可执行命令<code>mysqld --remove 服务名称</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">D:\application\setup\MySQL55\bin&gt;mysqld --remove MySQL55</div><div class="line">Service successfully removed.</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;命令行关闭和启动服务&quot;&gt;&lt;a href=&quot;#命令行关闭和启动服务&quot; class=&quot;headerlink&quot; title=&quot;命令行关闭和启动服务&quot;&gt;&lt;/a&gt;命令行关闭和启动服务&lt;/h3&gt;&lt;p&gt;以管理员身份运行&lt;code&gt;cmd&lt;/code&gt;，关闭MySQL服务，提示&lt;code&gt;服务名无效&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; net stop mysql&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;服务名无效。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;请键入 NET HELPMSG 2185 以获得更多的帮助。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以管理员身份运行&lt;code&gt;cmd&lt;/code&gt;，启动MySQL服务，提示&lt;code&gt;服务名无效&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; net start mysql&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;服务名无效。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;请键入 NET HELPMSG 2185 以获得更多的帮助。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>MySQL5.7 安装</title>
    <link href="http://yoursite.com/post/mysql57-setup.html"/>
    <id>http://yoursite.com/post/mysql57-setup.html</id>
    <published>2018-03-18T01:17:17.000Z</published>
    <updated>2018-03-25T03:00:43.996Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-安装包"><a href="#1-安装包" class="headerlink" title="1. 安装包"></a>1. 安装包</h3><p>到<a href="https://dev.mysql.com/downloads/windows/installer/5.7.html" target="_blank" rel="external">MySQL官网</a>下载安装应用包。点此下载 <a href="https://cdn.mysql.com//Downloads/MySQLInstaller/mysql-installer-community-5.7.21.0.msi" target="_blank" rel="external">mysql-installer-community-5.7.21.0.msi</a></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql0.png" alt=""></p>
<a id="more"></a>
<h3 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql1.png" alt=""></p>
<p>同意协议，进入下一步：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql2.png" alt=""></p>
<p>选择自定义安装，进入下一步：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql3.png" alt=""></p>
<p>选择需要安装的应用，这里只安装数据库服务，后续如果想添加应用可以重新执行安装包文件进行添加：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql4.png" alt=""></p>
<p>修改应用的安装路径：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql5.png" alt=""></p>
<p>然后点击下一步，开始安装：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql6.png" alt=""></p>
<p>安装完成后，对MySQL进行配置：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql7.png" alt=""></p>
<p>按默认选择，下一步：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql8.png" alt=""></p>
<p>按默认选择，下一步：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql9.png" alt=""></p>
<p>设置 root 账户的密码：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql10.png" alt=""></p>
<p>按默认选择，下一步：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql11.png" alt=""></p>
<p>按默认选择，下一步：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql12.png" alt=""></p>
<p>安装配置：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql13.png" alt=""></p>
<p>安装完配置之后，会跳回之前安装的界面：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql14.png" alt=""></p>
<p>配置已经完成，下一步：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql15.png" alt=""></p>
<p>完成安装：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql16.png" alt=""></p>
<h3 id="3-环境配置"><a href="#3-环境配置" class="headerlink" title="3. 环境配置"></a>3. 环境配置</h3><p>配置环境变量，将<code>bin</code>目录的路径加入系统的<code>PATH</code>变量中：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PATH=;D:\application\setup\MySQL57\bin</div></pre></td></tr></table></figure>
<p>检查链接是否成功：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql17.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-安装包&quot;&gt;&lt;a href=&quot;#1-安装包&quot; class=&quot;headerlink&quot; title=&quot;1. 安装包&quot;&gt;&lt;/a&gt;1. 安装包&lt;/h3&gt;&lt;p&gt;到&lt;a href=&quot;https://dev.mysql.com/downloads/windows/installer/5.7.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MySQL官网&lt;/a&gt;下载安装应用包。点此下载 &lt;a href=&quot;https://cdn.mysql.com//Downloads/MySQLInstaller/mysql-installer-community-5.7.21.0.msi&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;mysql-installer-community-5.7.21.0.msi&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/mysql0.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>程序员必知必会的 Linux Shell 命令</title>
    <link href="http://yoursite.com/post/linux-commands.html"/>
    <id>http://yoursite.com/post/linux-commands.html</id>
    <published>2017-11-11T03:00:12.000Z</published>
    <updated>2018-08-05T15:37:14.924Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-cd-命令"><a href="#1-cd-命令" class="headerlink" title="1. cd 命令"></a>1. cd 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">change directory（更改目录）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于切换工作目录。是最基本的 Linux 操作系统命令。</td></tr></table>

<p>1) 使用<code>cd</code>不带任何参数，可进入当前用户的主目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[fanlychie@129host apache-tomcat-8.0.45]$ <span class="built_in">cd</span></div><div class="line">[fanlychie@129host ~]$</div></pre></td></tr></table></figure>
<p>2) 使用<code>cd ~</code>也可进入当前用户的主目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[fanlychie@129host apache-tomcat-8.0.45]$ <span class="built_in">cd</span> ~</div><div class="line">[fanlychie@129host ~]$</div></pre></td></tr></table></figure>
<p>3) 使用<code>cd ..</code>返回上级目录（<code>..</code>用于表示上级目录，如返回上两级目录则应为<code>cd ../..</code>）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[fanlychie@129host webapps]$ <span class="built_in">cd</span> ..</div><div class="line">[fanlychie@129host apache-tomcat-8.0.45]$</div></pre></td></tr></table></figure>
<p>4) 使用<code>cd -</code>返回进入当前目录之前所在的目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[fanlychie@129host apache-tomcat-8.0.45]$ <span class="built_in">cd</span> -</div><div class="line">/home/fanlychie/apache-tomcat-8.0.45/webapps</div><div class="line">[fanlychie@129host webapps]$</div></pre></td></tr></table></figure>
 <a id="more"></a>
<h3 id="2-pwd-命令"><a href="#2-pwd-命令" class="headerlink" title="2. pwd 命令"></a>2. pwd 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">print work directory（打印工作目录）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于查看当前工作目录的路径，通常不需要带参数。</td></tr></table>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/home/fanlychie/apache-tomcat-8.0.45</div></pre></td></tr></table></figure>
<h3 id="3-mkdir-命令"><a href="#3-mkdir-命令" class="headerlink" title="3. mkdir 命令"></a>3. mkdir 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">make directory（创建目录）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于创建文件系统的目录（文件夹）。</td></tr></table>

<p>1) 创建一个名称为“dirname”的目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir dirname</div></pre></td></tr></table></figure>
<p>2）使用<code>-p, --parents</code>选项，当创建的目录的父目录不存在时，父目录也会一起被创建：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p pathname/dirname</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">该命令用于创建“dirname”目录，如果其父目录“pathname”尚未存在，则“pathname”目录会被一起创建。</td></tr></table>

<p>3) 使用<code>{..}</code>可以批量创建目录，如创建2018-01-01…2018-01-15…2018-01-31共31个目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir 2018-01-&#123;01..31&#125;</div></pre></td></tr></table></figure>
<p>4) 使用<code>{,}</code>可以批量创建目录，如创建2018-01-01、2018-01-15、2018-01-31共3个目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir 2018-01-&#123;01,15,31&#125;</div></pre></td></tr></table></figure>
<h3 id="4-ls-命令"><a href="#4-ls-命令" class="headerlink" title="4. ls 命令"></a>4. ls 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">list（列表信息）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于显示目录内容的列表信息。</td></tr></table>

<p>1) 使用<code>ls</code>命令查看当前工作目录的列表信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ls</div><div class="line">Catalina  catalina.policy  catalina.properties  context.xml  logging.properties  server.xml  tomcat-users.xml  tomcat-users.xsd  web.xml</div></pre></td></tr></table></figure>
<p>2) 使用<code>ll</code>命令查看当前工作目录的列表信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ll</div><div class="line">total 220</div><div class="line">drwxr-xr-x. 3 fanlychie fanlychie   4096 2017-11-11 17:05:03 Catalina</div><div class="line">-rw-------. 1 fanlychie fanlychie  13688 2017-06-26 20:09:48 catalina.policy</div><div class="line">-rw-------. 1 fanlychie fanlychie   7299 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   1577 2017-06-26 20:09:48 context.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   3387 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   6458 2017-11-11 17:24:47 server.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2155 2017-11-11 18:23:43 tomcat-users.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2634 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie 168496 2017-06-26 20:09:48 web.xml</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p><code>ll</code>是<code>ls -l</code>命令的别名（<code>-l</code>选项是用长格式方式显示信息，其每一个内容项都占据一行）</p><table><thead><tr><th style="text-align:center">序号</th><th style="text-align:center">示例</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">第一列</td><td style="text-align:center">drwxr-xr-x</td><td style="text-align:left">文件或目录的权限位描述符</td></tr><tr><td style="text-align:center">第二列</td><td style="text-align:center">3</td><td style="text-align:left">如果是一个文件，则表示文件的个数（数值必然是1）<br>如果是一个目录，则表示其子目录（包含隐藏的）总数</td></tr><tr><td style="text-align:center">第三列</td><td style="text-align:center">fanlychie</td><td style="text-align:left">文件或目录的属主（即所有者）</td></tr><tr><td style="text-align:center">第四列</td><td style="text-align:center">fanlychie</td><td style="text-align:left">文件或目录的属组</td></tr><tr><td style="text-align:center">第五列</td><td style="text-align:center">4096</td><td style="text-align:left">文件的大小，单位是B</td></tr><tr><td style="text-align:center">第六列</td><td style="text-align:center">2017-11-11</td><td style="text-align:left">文件或目录最后变更的日期</td></tr><tr><td style="text-align:center">第七列</td><td style="text-align:center">17:05:03</td><td style="text-align:left">文件或目录最后变更的时间</td></tr><tr><td style="text-align:center">第八列</td><td style="text-align:center">Catalina</td><td style="text-align:left">文件或目录的名称</td></tr></tbody></table><p>其中，第一列<code>drwxr-xr-x</code>的第一位表示文件系统对象类型，剩下的九位以每三位为一组表示：<img src="../img/linux_qx.png" width="380px"></p><p>常见的 Linux 文件系统对象类型有：</p><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">-</td><td style="text-align:left">普通文件</td></tr><tr><td style="text-align:center">d</td><td style="text-align:left">目录（文件夹）</td></tr><tr><td style="text-align:center">l</td><td style="text-align:left">符号连接（包括软链接和硬链接），它实质指向另一个文件</td></tr></tbody></table></td></tr></table>

<p>3) 使用<code>-a, --all</code>选项，会把以<code>.</code>和<code>..</code>开头的隐藏文件或目录信息也罗列显示出来：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ ll -a</div><div class="line">total 228</div><div class="line">drwxr-xr-x. 3 fanlychie fanlychie   4096 2018-04-25 07:18:36 .</div><div class="line">drwxrwxr-x. 9 fanlychie fanlychie   4096 2017-11-11 17:04:10 ..</div><div class="line">drwxrwxr-x. 3 fanlychie fanlychie   4096 2017-11-11 17:05:03 Catalina</div><div class="line">-rw-------. 1 fanlychie fanlychie  13688 2017-06-26 20:09:48 catalina.policy</div><div class="line">-rw-------. 1 fanlychie fanlychie   7299 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   1577 2017-06-26 20:09:48 context.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   3387 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   6458 2017-11-11 17:24:47 server.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2155 2017-11-11 18:23:43 tomcat-users.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2634 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie 168496 2017-06-26 20:09:48 web.xml</div></pre></td></tr></table></figure>
<p>4) 罗列指定路径（文件或目录路径）下的内容信息，如查看“Catalina”目录下的内容信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ll Catalina</div><div class="line">total 4</div><div class="line">drwxrwxr-x. 2 fanlychie fanlychie 4096 2018-04-24 11:21:47 localhost</div></pre></td></tr></table></figure>
<p>5) 使用<code>-t</code>选项，可以按文件或目录的修改时间排序（最新的排在最前面, 即降序）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ll -t</div><div class="line">total 220</div><div class="line">-rw-------. 1 fanlychie fanlychie   2155 2017-11-11 18:23:43 tomcat-users.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   6458 2017-11-11 17:24:47 server.xml</div><div class="line">drwxrwxr-x. 3 fanlychie fanlychie   4096 2017-11-11 17:05:03 Catalina</div><div class="line">-rw-------. 1 fanlychie fanlychie  13688 2017-06-26 20:09:48 catalina.policy</div><div class="line">-rw-------. 1 fanlychie fanlychie   7299 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   1577 2017-06-26 20:09:48 context.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   3387 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   2634 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie 168496 2017-06-26 20:09:48 web.xml</div></pre></td></tr></table></figure>
<p>6) 使用<code>-r, --reverse</code>选项，可以反向排序，默认是按文件或目录名称：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ll -r</div><div class="line">total 220</div><div class="line">-rw-------. 1 fanlychie fanlychie 168496 2017-06-26 20:09:48 web.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2634 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie   2155 2017-11-11 18:23:43 tomcat-users.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   6458 2017-11-11 17:24:47 server.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   3387 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   1577 2017-06-26 20:09:48 context.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   7299 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie  13688 2017-06-26 20:09:48 catalina.policy</div><div class="line">drwxrwxr-x. 3 fanlychie fanlychie   4096 2017-11-11 17:05:03 Catalina</div></pre></td></tr></table></figure>
<p>7) 组合<code>-r</code>选项，按文件或目录的修改时间升序排序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ll -rt</div><div class="line">total 220</div><div class="line">-rw-------. 1 fanlychie fanlychie 168496 2017-06-26 20:09:48 web.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2634 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie   3387 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   1577 2017-06-26 20:09:48 context.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   7299 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie  13688 2017-06-26 20:09:48 catalina.policy</div><div class="line">drwxrwxr-x. 3 fanlychie fanlychie   4096 2017-11-11 17:05:03 Catalina</div><div class="line">-rw-------. 1 fanlychie fanlychie   6458 2017-11-11 17:24:47 server.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2155 2017-11-11 18:23:43 tomcat-users.xml</div></pre></td></tr></table></figure>
<p>8) 使用<code>-S</code>选项，可以按文件或目录的大小排序（最大的排在最前面，即降序）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ll -S</div><div class="line">total 220</div><div class="line">-rw-------. 1 fanlychie fanlychie 168496 2017-06-26 20:09:48 web.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie  13688 2017-06-26 20:09:48 catalina.policy</div><div class="line">-rw-------. 1 fanlychie fanlychie   7299 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   6458 2017-11-11 17:24:47 server.xml</div><div class="line">drwxrwxr-x. 3 fanlychie fanlychie   4096 2017-11-11 17:05:03 Catalina</div><div class="line">-rw-------. 1 fanlychie fanlychie   3387 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   2634 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie   2155 2017-11-11 18:23:43 tomcat-users.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   1577 2017-06-26 20:09:48 context.xml</div></pre></td></tr></table></figure>
<p>9) 使用<code>-h, --human-readable</code>选项，以易读方式来显示文件或目录的大小（默认大小是以<code>B</code>作为单位，<code>-h, --human-readable</code>选项会自动的将其转换为<code>K</code>或<code>M</code>或<code>G</code>单位来显示）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ll -h</div><div class="line">total 220K</div><div class="line">drwxrwxr-x. 3 fanlychie fanlychie 4.0K 2017-11-11 17:05:03 Catalina</div><div class="line">-rw-------. 1 fanlychie fanlychie  14K 2017-06-26 20:09:48 catalina.policy</div><div class="line">-rw-------. 1 fanlychie fanlychie 7.2K 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie 1.6K 2017-06-26 20:09:48 context.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie 3.4K 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie 6.4K 2017-11-11 17:24:47 server.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie 2.2K 2017-11-11 18:23:43 tomcat-users.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie 2.6K 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie 165K 2017-06-26 20:09:48 web.xml</div></pre></td></tr></table></figure>
<p>10) 使用<code>-R, --recursive</code>选项，可以递归显示路径下的子目录下的树信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$ ll -R</div><div class="line">.:</div><div class="line">total 220</div><div class="line">drwxrwxr-x. 3 fanlychie fanlychie   4096 2017-11-11 17:05:03 Catalina</div><div class="line">-rw-------. 1 fanlychie fanlychie  13688 2017-06-26 20:09:48 catalina.policy</div><div class="line">-rw-------. 1 fanlychie fanlychie   7299 2017-06-26 20:09:48 catalina.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   1577 2017-06-26 20:09:48 context.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   3387 2017-06-26 20:09:48 logging.properties</div><div class="line">-rw-------. 1 fanlychie fanlychie   6458 2017-11-11 17:24:47 server.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2155 2017-11-11 18:23:43 tomcat-users.xml</div><div class="line">-rw-------. 1 fanlychie fanlychie   2634 2017-06-26 20:09:48 tomcat-users.xsd</div><div class="line">-rw-------. 1 fanlychie fanlychie 168496 2017-06-26 20:09:48 web.xml</div><div class="line"> </div><div class="line">./Catalina:</div><div class="line">total 4</div><div class="line">drwxrwxr-x. 2 fanlychie fanlychie 4096 2018-04-24 11:21:47 localhost</div><div class="line"> </div><div class="line">./Catalina/localhost:</div><div class="line">total 4</div><div class="line">-rw-------. 1 fanlychie fanlychie 426 2018-04-24 11:21:47 context.xml</div></pre></td></tr></table></figure>
<h3 id="5-rm-命令"><a href="#5-rm-命令" class="headerlink" title="5. rm 命令"></a>5. rm 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">remove（移除）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于删除文件或目录。</td></tr></table>

<p>1) 使用<code>-f, --force</code>选项，强行执行删除操作，即使删除的文件不存在也不会出现警告。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ rm -f catalina.2017-11-12.log</div></pre></td></tr></table></figure>
<p>2) 使用<code>-r, -R, --recursive</code>选项，可以删除一个目录（该目录下的所有文件和子目录都会被删除）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ rm -r logs/</div></pre></td></tr></table></figure>
<p>3) 使用<code>-v, --verbose</code>选项，可以回显执行过程：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ rm -v catalina.2017-11-11.log</div><div class="line">removed `catalina.2017-11-11.log`</div></pre></td></tr></table></figure>
<h3 id="6-mv-命令"><a href="#6-mv-命令" class="headerlink" title="6. mv 命令"></a>6. mv 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">move（移动）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于移动文件或目录到另外一个目录中，也可用于重命名文件或目录。</td></tr></table>

<p>1) 将源文件“zoo_sample.cfg”的名称重命名为“zoo.cfg”：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mv zoo_sample.cfg zoo.cfg</div></pre></td></tr></table></figure>
<p>2) 将源目录“config”的名称重命名为“conf”：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mv config/ conf</div></pre></td></tr></table></figure>
<p>3) 将“zoo_sample.cfg”文件移动到子目录“conf”中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mv zoo_sample.cfg conf/</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">若“conf”中已存在一个名为“zoo_sample.cfg”的文件，则新的文件会直接覆盖老的文件。</td></tr></table>

<p>4) 将文件“zoo_sample.cfg”移动到子目录“conf”中，并将文件重命名为“zoo.cfg”：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mv zoo_sample.cfg conf/zoo.cfg</div></pre></td></tr></table></figure>
<p>5) 将目录“node1”中的子目录“conf/”移动到目录“node2/”中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mv node1/conf/ node2/</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>如果“node2”目录中已经存在一个名称为“conf”的子目录并且该子目录的内容不为空，则会报出警告，不能成功的进行移动。除非先把“node2”目录中的“conf”子目录删除或者使用<code>-b</code>选项（如果移动的文件或目录在目标目录中已经存在，则移动前会自动进行备份，备份的文件或目录默认是以原名称+<code>~</code>结束）进行移动：<code>mv -b node1/conf/ node2/</code>。</p></td></tr></table>

<h3 id="7-chmod-命令"><a href="#7-chmod-命令" class="headerlink" title="7. chmod 命令"></a>7. chmod 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">change mode（改变模式）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于变更文件或目录的权限。</td></tr></table>

<p>Linux 系统的文件或目录是由<code>读取(r)</code>、<code>写入(w)</code>、<code>执行(x)</code>三种权限共同来决定。执行<code>ll</code>（<code>ls -l</code>）命令展示出来的第一列就是文件或目录的权限信息（<a href="https://fanlychie.github.io/post/linux-commands.html#4-ls-命令" target="_blank" rel="external">参考「ls 命令」</a>）。</p>
<div style="float:right;"><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/linux_chmod.png" width="230"></div>

<ul>
<li>属主 <span style="padding-left:11px">&nbsp;</span>(u) ：文件或目录的创建者，或被指定的文件或目录的所有者；</li>
<li>属组 <span style="padding-left:11px">&nbsp;</span>(g) ：文件或目录的所属用户组；</li>
<li>其它人 (o) ：既不是属主又不是属组里面的其它用户；</li>
</ul>
<p>文件或目录的<code>读取(r)</code>、<code>写入(w)</code>、<code>执行(x)</code>权限控制：</p>
<table>
<thead>
<tr>
<th style="text-align:center">字符</th>
<th style="text-align:center">数值</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">r</td>
<td style="text-align:center">4</td>
<td style="text-align:left">读取权限（如果是目录，那就是查看目录里面内容的权限）</td>
</tr>
<tr>
<td style="text-align:center">w</td>
<td style="text-align:center">2</td>
<td style="text-align:left">写入权限</td>
</tr>
<tr>
<td style="text-align:center">x</td>
<td style="text-align:center">1</td>
<td style="text-align:left">执行权限（如果是目录，那就是切换（cd）到目录的权限）</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">0</td>
<td style="text-align:left">没有权限</td>
</tr>
</tbody>
</table>
<p>假设现有一文件“my.sh”，其初始权限如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-rw-r--r--. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.sh</div></pre></td></tr></table></figure>
<p>1) 给文件或目录赋权，属主<code>u=r|w|x</code>，属组<code>g=r|w|x</code>，其他人<code>o=r|w|x</code>，所有<code>a=r|w|x</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ chmod u=rwx my.sh </div><div class="line">$ ll</div><div class="line">total 4</div><div class="line">-rwxr--r--. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.sh</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果想要同时为多个所属组赋权，使用英文逗号分隔：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ chmod g=rx,o=rx my.sh </div><div class="line">$ ll</div><div class="line">total 4</div><div class="line">-rwxr-xr-x. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.sh</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>2) 变更文件或目录的权限，属主<code>u±r|w|x</code>，属组<code>g±r|w|x</code>，其他人<code>o±r|w|x</code>，所有<code>a±r|w|x</code>（其中<code>+</code>为增加相应的权限，<code>-</code>为删除相应的权限）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ chmod o-x my.sh </div><div class="line">$ ll</div><div class="line">total 4</div><div class="line">-rwxr-xr--. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.sh</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果想要同时变更多个所属组权限，使用英文逗号分隔：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ chmod u-x,g-x my.sh </div><div class="line">$ ll</div><div class="line">total 4</div><div class="line">-rw-r--r--. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.sh</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>3) 使用数值代码变更文件或目录的权限，如将“my.sh”的文件权限修改为“755”（“rwxr-xr-x”）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ chmod 755 my.sh </div><div class="line">$ ll</div><div class="line">total 4</div><div class="line">-rwxr-xr-x. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.sh</div></pre></td></tr></table></figure>
<p>4) 使用<code>-R, --recursive</code>选项，可以修改一个目录以及该目录下所有的文件的权限：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ chmod -R 750 conf/</div><div class="line">$ ll -R</div><div class="line">.:</div><div class="line">total 4</div><div class="line">drwxr-x---. 2 fanlychie fanlychie 4096 2018-04-25 10:10:23 conf</div><div class="line"> </div><div class="line">./conf:</div><div class="line">total 4</div><div class="line">-rwxr-x---. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.sh</div></pre></td></tr></table></figure>
<h3 id="8-chown-命令"><a href="#8-chown-命令" class="headerlink" title="8. chown 命令"></a>8. chown 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">change owner（改变所有者）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于变更文件或目录的属主和属组。只有文件或目录的创建者或管理员用户才有权限操作。</td></tr></table>

<p><code>ll</code>（<code>ls -l</code>）命令展示出的第三和第四列分别就是文件或目录的属主和属组信息（<a href="https://fanlychie.github.io/post/linux-commands.html#4-ls-命令" target="_blank" rel="external">参考「ls 命令」</a>）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">drwxr-xr-x. 3 root root  4096 2018-04-25 09:58:44 <span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>1) 变更文件或目录的属主和属组，<code>chown 属主:属组 文件或目录</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># chown fanlychie:fanlychie test/</span></div><div class="line"><span class="comment"># ll -R</span></div><div class="line">.:</div><div class="line">total 4</div><div class="line">drwxr-xr-x. 3 fanlychie fanlychie  4096 2018-04-25 09:58:44 <span class="built_in">test</span></div><div class="line"> </div><div class="line">./<span class="built_in">test</span>:</div><div class="line">total 4</div><div class="line">drwxr-x---. 2 root root 4096 2018-04-25 10:10:23 conf</div><div class="line"> </div><div class="line">./<span class="built_in">test</span>/conf:</div><div class="line">total 4</div><div class="line">-rwxr-x---. 1 root root 601 2018-04-25 09:43:38 my.cfg</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>使用<code>-R, --recursive</code>选项，可以变更目录以及该目录下所有内容的属主和属组：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># chown -R fanlychie:fanlychie test/</span></div><div class="line"><span class="comment"># ll -R</span></div><div class="line">.:</div><div class="line">total 4</div><div class="line">drwxr-xr-x. 3 fanlychie fanlychie  4096 2018-04-25 09:58:44 <span class="built_in">test</span></div><div class="line"> </div><div class="line">./<span class="built_in">test</span>:</div><div class="line">total 4</div><div class="line">drwxr-x---. 2 fanlychie fanlychie 4096 2018-04-26 05:30:17 conf</div><div class="line"> </div><div class="line">./<span class="built_in">test</span>/conf:</div><div class="line">total 4</div><div class="line">-rwxr-x---. 1 fanlychie fanlychie 601 2018-04-25 09:43:38 my.cfg</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<h3 id="9-cp-命令"><a href="#9-cp-命令" class="headerlink" title="9. cp 命令"></a>9. cp 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">copy（复制）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于复制文件或目录。</td></tr></table>

<p>1) 将“index.html”文件复制到“WEB-INF”目录中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp index.html WEB-INF/</div></pre></td></tr></table></figure>
<p>2) 将“index.html”文件复制到“WEB-INF”目录中，并重命名为“index.htm”：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp index.html WEB-INF/index.htm</div></pre></td></tr></table></figure>
<p>3) 使用<code>-R, -r, --recursive</code>选项，可以将一个目录中的所有内容复制到另外一个目录中。<br><span style="padding-left:16px">&nbsp;</span>如将“jsp”目录（包括该目录以及该目录下的所有内容）复制到“WEB-INF”目录中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp -r jsp/ WEB-INF/</div></pre></td></tr></table></figure>
<p>4) 如果复制的源文件或目录在目标目录中已经存在，则默认会覆盖目标目录中的文件或目录。<br><span style="padding-left:16px">&nbsp;</span>使用<code>-b</code>选项可以备份目标目录中的文件或目录。备份的文件或目录的默认后缀名是是带<code>~</code>结尾。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ cp -b index.html WEB-INF/</div><div class="line">$ ll WEB-INF/</div><div class="line">total 44</div><div class="line">drwxr-xr-x. 20 fanlychie fanlychie  4096 2017-11-11 17:04:10 classes</div><div class="line">-rw-r--r--.  1 fanlychie fanlychie  1126 2018-04-26 06:06:21 index.html</div><div class="line">-rw-r--r--.  1 fanlychie fanlychie  1126 2018-04-26 06:04:57 index.html~</div><div class="line">drwxr-xr-x. 22 fanlychie fanlychie  4096 2018-04-26 06:03:07 jsp</div><div class="line">drwxr-xr-x.  2 fanlychie fanlychie  4096 2017-11-11 17:04:10 jsp2</div><div class="line">drwxr-xr-x.  2 fanlychie fanlychie  4096 2017-11-11 17:04:10 lib</div><div class="line">drwxr-xr-x.  2 fanlychie fanlychie  4096 2017-11-11 17:04:10 tags</div><div class="line">-rw-r--r--.  1 fanlychie fanlychie 14554 2017-06-26 20:09:51 web.xml</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>如果没有<code>-b</code>选项，则源文件“index.html”会直接覆盖“WEB-INF”目录中的“index.html”文件；<br>若使用了<code>-b</code>选项，源文件“index.html”在覆盖“WEB-INF”目录中的“index.html”文件之前，“WEB-INF”目录中的“index.html”文件会自动做一个备份，备份的文件名称就是为“index.html~”；</p></td></tr></table>

<h3 id="10-scp-命令"><a href="#10-scp-命令" class="headerlink" title="10. scp 命令"></a>10. scp 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">secure copy（安全复制）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>用于远程文件或目录的安全拷贝。它和<code>cp</code>命令类似，但<code>cp</code>命令只能在本机内对文件或目录进行拷贝。而<code>scp</code>命令能够在两台服务器之间跨服务器拷贝文件或目录。</p></td></tr></table>

<p>1) 将“192.168.139.129”服务器中的“index.html”拷贝到“192.168.139.130”服务器中：<br><span style="padding-left:16px">&nbsp;</span>语法：<code>scp 本机源文件 远程登录主机的用户名@远程主机IP:复制到远程主机的目标路径</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp index.html fanlychie@192.168.139.130:/home/fanlychie/<span class="built_in">test</span>/</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">如果远程目标机中已经存在该文件，则执行完命令之后，目标机中的文件将会被覆盖掉。</td></tr></table>

<p>2) 使用<code>-P</code>选项，可以指定远程主机的端口号，默认是<code>22</code>端口，如果不是，可以使用该项来指定。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp -P 33 index.html fanlychie@192.168.139.130:/home/fanlychie/<span class="built_in">test</span>/</div></pre></td></tr></table></figure>
<p>3) 使用<code>-r</code>选项，可以将本机的一个目录拷贝到另一台远程主机的目标目录中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp -r jsp/ fanlychie@192.168.139.130:/home/fanlychie/<span class="built_in">test</span>/</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">如果远程目标机中已经存在该目录，则执行完命令之后，目标机中的目录将会被覆盖掉。</td></tr></table>

<p>4) 除此之外，还可以反过来，在本机执行命令，将远程主机中的文件或目录拷贝到本机：<br><span style="padding-left:16px">&nbsp;</span>语法：<code>scp 远程登录主机的用户名@远程主机IP:远程主机的源文件 本机目录</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp fanlychie@192.168.139.130:/home/fanlychie/<span class="built_in">test</span>/index.html ./index.htm</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>远程拷贝目录与拷贝文件的方式相似，只需要加<code>-r</code>选项。</p></td></tr></table>

<p>5) 将“192.168.139.129”中的“index.html”拷贝到“192.168.139.130”并重命名为“idx.html”：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp index.html fanlychie@192.168.139.130:/home/fanlychie/<span class="built_in">test</span>/idx.html</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>拷贝目录与拷贝文件的方式相似，只需要加<code>-r</code>选项。</p></td></tr></table>

<h3 id="11-cat-命令"><a href="#11-cat-命令" class="headerlink" title="11. cat 命令"></a>11. cat 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">concatenate（串联）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于将文件内容打印到标准输出设备上。适合用于查看小文件的内容。</td></tr></table>

<p>1) 使用<code>-n, --number</code>选项，会对文件里面的每一行内容用数字进行编号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ cat -n zoo.cfg </div><div class="line">     1	<span class="comment"># The number of milliseconds of each tick</span></div><div class="line">     2	tickTime=2000</div><div class="line">     3	</div><div class="line">     4	<span class="comment"># The number of ticks that the initial</span></div><div class="line">     5	<span class="comment"># synchronization phase can take</span></div><div class="line">     6	initLimit=10</div><div class="line">     7	</div><div class="line">     8	<span class="comment"># The number of ticks that can pass between</span></div><div class="line">     9	<span class="comment"># sending a request and getting an acknowledgement</span></div><div class="line">    10	syncLimit=5</div><div class="line">    11	</div><div class="line">    12	<span class="comment"># the directory where the snapshot is stored.</span></div><div class="line">    13	<span class="comment"># do not use /tmp for storage, /tmp here is just</span></div><div class="line">    14	<span class="comment"># example sakes.</span></div><div class="line">    15	dataDir=/home/fanlychie/zookeeper/data</div><div class="line">    16	</div><div class="line">    17	</div><div class="line">    18	dataLogDir=/home/fanlychie/zookeeper/logs</div><div class="line">    19	</div><div class="line">    20	<span class="comment"># the port at which the clients will connect</span></div><div class="line">    21	clientPort=2181</div></pre></td></tr></table></figure>
<p>2) 使用<code>-b, --number-nonblank</code>选项，会对文件内容的非空白行用数字进行编号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ cat -b zoo.cfg </div><div class="line">     1	<span class="comment"># The number of milliseconds of each tick</span></div><div class="line">     2	tickTime=2000</div><div class="line"> </div><div class="line">     3	<span class="comment"># The number of ticks that the initial</span></div><div class="line">     4	<span class="comment"># synchronization phase can take</span></div><div class="line">     5	initLimit=10</div><div class="line"> </div><div class="line">     6	<span class="comment"># The number of ticks that can pass between</span></div><div class="line">     7	<span class="comment"># sending a request and getting an acknowledgement</span></div><div class="line">     8	syncLimit=5</div><div class="line"> </div><div class="line">     9	<span class="comment"># the directory where the snapshot is stored.</span></div><div class="line">    10	<span class="comment"># do not use /tmp for storage, /tmp here is just</span></div><div class="line">    11	<span class="comment"># example sakes.</span></div><div class="line">    12	dataDir=/home/fanlychie/zookeeper/data</div><div class="line"> </div><div class="line"> </div><div class="line">    13	dataLogDir=/home/fanlychie/zookeeper/logs</div><div class="line"> </div><div class="line">    14	<span class="comment"># the port at which the clients will connect</span></div><div class="line">    15	clientPort=2181</div></pre></td></tr></table></figure>
<p>3) 使用<code>-s, --squeeze-blank</code>选项，如果连续出现的多个空行就会压缩成一行显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ cat -s zoo.cfg </div><div class="line"><span class="comment"># The number of milliseconds of each tick</span></div><div class="line">tickTime=2000</div><div class="line"> </div><div class="line"><span class="comment"># The number of ticks that the initial</span></div><div class="line"><span class="comment"># synchronization phase can take</span></div><div class="line">initLimit=10</div><div class="line"> </div><div class="line"><span class="comment"># The number of ticks that can pass between</span></div><div class="line"><span class="comment"># sending a request and getting an acknowledgement</span></div><div class="line">syncLimit=5</div><div class="line"> </div><div class="line"><span class="comment"># the directory where the snapshot is stored.</span></div><div class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just</span></div><div class="line"><span class="comment"># example sakes.</span></div><div class="line">dataDir=/home/fanlychie/zookeeper/data</div><div class="line"> </div><div class="line">dataLogDir=/home/fanlychie/zookeeper/logs</div><div class="line"> </div><div class="line"><span class="comment"># the port at which the clients will connect</span></div><div class="line">clientPort=2181</div></pre></td></tr></table></figure>
<p>4) 去掉空白行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ cat zoo.cfg | grep -v ^$</div><div class="line"><span class="comment"># The number of milliseconds of each tick</span></div><div class="line">tickTime=2000</div><div class="line"><span class="comment"># The number of ticks that the initial</span></div><div class="line"><span class="comment"># synchronization phase can take</span></div><div class="line">initLimit=10</div><div class="line"><span class="comment"># The number of ticks that can pass between</span></div><div class="line"><span class="comment"># sending a request and getting an acknowledgement</span></div><div class="line">syncLimit=5</div><div class="line"><span class="comment"># the directory where the snapshot is stored.</span></div><div class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just</span></div><div class="line"><span class="comment"># example sakes.</span></div><div class="line">dataDir=/home/fanlychie/zookeeper/data</div><div class="line">dataLogDir=/home/fanlychie/zookeeper/logs</div><div class="line"><span class="comment"># the port at which the clients will connect</span></div><div class="line">clientPort=2181</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>其中，<code>|</code>是管道。<code>^$</code>是正则表达式，用于匹配空格。<code>grep</code>的用法可参考xxx。</p></td></tr></table>

<p>5) 去掉“#”注释行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ cat zoo.cfg | grep -v ^<span class="comment">#</span></div><div class="line">tickTime=2000</div><div class="line"> </div><div class="line">initLimit=10</div><div class="line"> </div><div class="line">syncLimit=5</div><div class="line"> </div><div class="line">dataDir=/home/fanlychie/zookeeper/data</div><div class="line"> </div><div class="line"> </div><div class="line">dataLogDir=/home/fanlychie/zookeeper/logs</div><div class="line"> </div><div class="line">clientPort=2181</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>其中，<code>|</code>是管道。<code>^#</code>是正则表达式，用于匹配“#”开头的行。<code>grep</code>的用法可参考xxx。</p></td></tr></table>

<p>6) 去掉空白行和注释行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cat zoo.cfg | grep -v ^$ | grep -v ^<span class="comment">#</span></div><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/home/fanlychie/zookeeper/data</div><div class="line">dataLogDir=/home/fanlychie/zookeeper/logs</div><div class="line">clientPort=2181</div></pre></td></tr></table></figure>
<h3 id="12-more-命令"><a href="#12-more-命令" class="headerlink" title="12. more 命令"></a>12. more 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于以分页的形式来展示文本文件的内容。适合用于查看较大文件的内容。</td></tr></table>

<p>该命令每次显示一屏的内容，在屏幕的左下方会出现<code>--More--(n%)</code>的内容浏览进度条提示。此外，该命令还支持按键操作响应事件，常用的按键操作有：</p>
<table>
<thead>
<tr>
<th style="text-align:left">按键</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">回车键</td>
<td style="text-align:left">前进一行（向下滚动一行）</td>
</tr>
<tr>
<td style="text-align:left">空格键</td>
<td style="text-align:left">前进一屏（向下滚动一屏）</td>
</tr>
<tr>
<td style="text-align:left">f</td>
<td style="text-align:left">前进一屏（向下滚动一屏）</td>
</tr>
<tr>
<td style="text-align:left">b</td>
<td style="text-align:left">后退一屏（向上滚动一屏）</td>
</tr>
<tr>
<td style="text-align:left">=</td>
<td style="text-align:left">显示当前行的行号</td>
</tr>
<tr>
<td style="text-align:left">q</td>
<td style="text-align:left">退出命令</td>
</tr>
<tr>
<td style="text-align:left">/pattern</td>
<td style="text-align:left">搜索字符，匹配的字符不高亮，只能向下（向文件尾）搜索（按“n”键搜索下一个）</td>
</tr>
</tbody>
</table>
<p>1) 使用<code>-s</code>选项，如果文件内容中连续出现的多个空行则会压缩成一行显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ more -s catalina.out</div></pre></td></tr></table></figure>
<p>2) 使用<code>+n</code>选项，可以从指定的第<code>n</code>行开始显示，如从第37行开始显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ more +37 catalina.out</div></pre></td></tr></table></figure>
<p>3) 使用<code>-n</code>选项，可以定义每屏显示的行数，如每屏显示10行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ more -10 catalina.out</div></pre></td></tr></table></figure>
<p>4) 使用<code>+/pattern</code>选项，可以从匹配到的搜索串处开始显示，如从“Exception”出现的地方开始显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ more +/Exception catalina.out</div></pre></td></tr></table></figure>
<h3 id="13-less-命令"><a href="#13-less-命令" class="headerlink" title="13. less 命令"></a>13. less 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>与<code>more</code>命令相似，但功能比<code>more</code>命令更强。</p><p>用于以分页的形式来展示文本文件的内容。适合用于查看较大文件的内容。</p></td></tr></table>

<p>该命令每次显示一屏的内容，同时它还支持按键操作响应事件，常用的按键操作有：</p>
<table>
<thead>
<tr>
<th style="text-align:left">按键</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">回车键</td>
<td style="text-align:left">前进一行（向下滚动一行）</td>
</tr>
<tr>
<td style="text-align:left">空格键</td>
<td style="text-align:left">前进一屏（向下滚动一屏）</td>
</tr>
<tr>
<td style="text-align:left">f</td>
<td style="text-align:left">前进一屏（向下滚动一屏）</td>
</tr>
<tr>
<td style="text-align:left">b</td>
<td style="text-align:left">后退一屏（向上滚动一屏）</td>
</tr>
<tr>
<td style="text-align:left">d</td>
<td style="text-align:left">前进半屏（向下滚动半屏）</td>
</tr>
<tr>
<td style="text-align:left">u</td>
<td style="text-align:left">后退半屏（向上滚动半屏）</td>
</tr>
<tr>
<td style="text-align:left">q</td>
<td style="text-align:left">退出命令</td>
</tr>
<tr>
<td style="text-align:left">PgUp（↑）</td>
<td style="text-align:left">向上翻一屏</td>
</tr>
<tr>
<td style="text-align:left">PgDn（↓）</td>
<td style="text-align:left">向下翻一屏</td>
</tr>
<tr>
<td style="text-align:left">/pattern</td>
<td style="text-align:left">向下搜索，匹配的字符高亮，按n在同一个方向搜索下一个，按N反方向搜索上一个</td>
</tr>
<tr>
<td style="text-align:left">?pattern</td>
<td style="text-align:left">向上搜索，匹配的字符高亮，按n在同一个方向搜索下一个，按N反方向搜索上一个</td>
</tr>
</tbody>
</table>
<p>1) 使用<code>-s</code>选项，如果文件内容中连续出现的多个空行则会压缩成一行显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ less -s catalina.out</div></pre></td></tr></table></figure>
<p>2) 使用<code>+n</code>选项，可以从指定的第<code>n</code>行开始显示，如从第37行开始显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ less +37 catalina.out</div></pre></td></tr></table></figure>
<p>3) 使用<code>-n</code>选项，可以定义每屏显示的行数，如每屏显示10行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ less -10 catalina.out</div></pre></td></tr></table></figure>
<p>4) 使用<code>+/pattern</code>选项，可以从匹配到的搜索串处开始显示，如从“Exception”出现的地方开始显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ less +/Exception catalina.out</div></pre></td></tr></table></figure>
<p>5) 使用<code>-N</code>选项，显式文件内容的行号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">less -N catalina.out</div></pre></td></tr></table></figure>
<p>6) 使用<code>-m</code>选项，在右下角显示文件浏览进度的百分比数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">less -m catalina.out</div></pre></td></tr></table></figure>
<h3 id="14-head-命令"><a href="#14-head-命令" class="headerlink" title="14. head 命令"></a>14. head 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用来查看文件的前几行（默认是前10行）的内容。</td></tr></table>

<p>1) 查看“catalina.out”文件（查看前10行）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ head catalina.out</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果想查看指定的前几行，可以使用<code>-n</code>参数，例如查看前20行：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ head -20 catalina.out</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<h3 id="15-tail-命令"><a href="#15-tail-命令" class="headerlink" title="15. tail 命令"></a>15. tail 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用来查看文件末尾的内容（默认是末尾10行）。</td></tr></table>

<p>1) 查看“catalina.out”文件（查看末尾的10行）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tail catalina.out</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果想查看指定的末尾几行，可以使用<code>-n</code>参数，例如查看末尾20行：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tail -20 catalina.out</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>2) 使用<code>-f, --follow</code>选项，可以跟随读取文件（常用于查看日志文件）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tail -f catalina.out</div></pre></td></tr></table></figure>
<h3 id="16-tar-命令"><a href="#16-tar-命令" class="headerlink" title="16. tar 命令"></a>16. tar 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">tape archive（最初是用来在磁带上创建档案）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>用于将一个文件或目录打包压缩成一个文件，或用于将一个文件或目录从压缩包里解压缩出来。</p><p>打包：它仅仅是将一个文件或一个目录下的所有内容汇总成一个总的文件；</p><p>压缩：则是指通过某些算法（如<code>gzip</code>、<code>bzip2</code>），将一个文件压缩成一个体积更小的文件；</p></td></tr></table>

<p>1) 将“logs”目录打包并压缩成“logs.tar.gz”文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tar zcvf logs.tar.gz logs/</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>tar</code>命令是汇总成“*.tar”文件。<code>z</code>选项是采用“gzip”算法压缩成“*.gz”文件。</p></td></tr></table>

<p>2) 查看“*.tar.gz”压缩包文件里面的内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tar ztvf logs.tar.gz</div></pre></td></tr></table></figure>
<p>3) 解压缩“*.tar.gz”压缩包文件里面的内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tar zxvf logs.tar.gz</div></pre></td></tr></table></figure>
<h3 id="17-ping-命令"><a href="#17-ping-命令" class="headerlink" title="17. ping 命令"></a>17. ping 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于测试两台主机之间网络的连通性。</td></tr></table>

<p>1) ping 主机 IP“192.168.1.100”的网络连通性：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ ping 192.168.1.100</div><div class="line">PING 192.168.1.100 (192.168.1.100) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.1.100: icmp_seq=1 ttl=128 time=0.801 ms</div><div class="line">64 bytes from 192.168.1.100: icmp_seq=2 ttl=128 time=0.610 ms</div><div class="line">64 bytes from 192.168.1.100: icmp_seq=3 ttl=128 time=0.581 ms</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>按<code>ctrl + c</code>组合键中断。</p></td></tr></table>

<p>2) ping 公网域名“baidu.com”的外网连通性（如果能ping通表明主机能正常访问外网，反之则不能）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ ping baidu.com</div><div class="line">PING baidu.com (220.181.57.216) 56(84) bytes of data.</div><div class="line">64 bytes from 220.181.57.216: icmp_seq=1 ttl=128 time=40.9 ms</div><div class="line">64 bytes from 220.181.57.216: icmp_seq=2 ttl=128 time=39.5 ms</div><div class="line">64 bytes from 220.181.57.216: icmp_seq=3 ttl=128 time=40.2 ms</div></pre></td></tr></table></figure>
<p>3) 使用<code>-c</code>选项，可以指定 ping 的次数。如 ping 测试3次：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ping -c 3 192.168.1.100</div></pre></td></tr></table></figure>
<h3 id="17-ssh-命令"><a href="#17-ssh-命令" class="headerlink" title="17. ssh 命令"></a>17. ssh 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于在一台Linux主机远程登录到另外一台Linux主机。</td></tr></table>

<p>1) 用“fanlychie”账户登录到远程主机“192.168.139.129”，语法<code>ssh 远程主机用户名@远程主机IP</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh fanlychie@192.168.139.129</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果当前Linux主机是首次远程登录到目标主机，它会询问你“Are you sure you want to continue connecting (yes/no)?”键入“yes”敲回车即可。然后它会要求你输入远程主机用户名登录到主机IP的密码“fanlychie@192.168.139.129’s password:”键入密码敲回车即可。</p><p>如果当前Linux主机也是以“fanlychie”账户登录的，则可以去掉登录远程主机的用户名：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh 192.168.139.129</div></pre></td></tr></table></figure><br><br></span><p>它默认是以当前Linux主机登录的用户名登录远程IP主机。</p></td></tr></table>

<p>2) 使用<code>p</code>选项，可以指定登录远程主机的端口（默认是<code>22</code>端口），例如指定33端口：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh -p 33 fanlychie@192.168.139.129</div></pre></td></tr></table></figure>
<h3 id="18-管道命令"><a href="#18-管道命令" class="headerlink" title="18. 管道命令"></a>18. 管道命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>管道<code>|</code>，它能将上一个命令的正确执行的输出传递给下一个命令，作为下一个命令的标准输入。</p></td></tr></table>

<p>1) 查看当前目录下的文件，按大小排序，然后分页查看：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ ll -Sh | less</div><div class="line">总用量 79M</div><div class="line">-rw-rw-r-- 1 fanlychie fanlychie 5.5M 2018-05-10 09:07:23 webtest.log.2018-05-10</div><div class="line">-rw-rw-r-- 1 fanlychie fanlychie 3.9M 2018-05-09 12:22:33 servicetest.log.2018-05-09</div><div class="line">-rw-rw-r-- 1 fanlychie fanlychie 3.5M 2018-05-12 17:43:42 apptest.log.2018-05-12</div><div class="line">... ...</div></pre></td></tr></table></figure>
<h3 id="19-ps-命令"><a href="#19-ps-命令" class="headerlink" title="19. ps 命令"></a>19. ps 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">process status（进程状态）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于查看当前系统运行的进程状态信息。该命令选项非常多，这里仅介绍常用的组合选项。</td></tr></table>

<p>1) 使用<code>-ef</code>组合选项，可以查看当前系统所有的进程信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ps -ef</div><div class="line">UID   PID    PPID  C   STIME   TTY     TIME        CMD</div><div class="line">500   2878   1     0   12:37   pts/0   00:00:24    /usr/<span class="built_in">local</span>/jdk1.8.0_144/bin/java -Djava.util.logging.config.file=/home/fanlychie/applications/apache-tomcat-8.0.45/conf/logging.properties</div><div class="line">... ...</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果想查看进程的PID或PPID可以选用该组合选项。其各字段的概述：</p><table><thead><tr><th style="text-align:center">字段</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">UID</td><td style="text-align:left">进程所属的用户ID</td></tr><tr><td style="text-align:center">PID</td><td style="text-align:left">进程ID</td></tr><tr><td style="text-align:center">PPID</td><td style="text-align:left">进程的父ID</td></tr><tr><td style="text-align:center">C</td><td style="text-align:left">CPU使用比率</td></tr><tr><td style="text-align:center">STIME</td><td style="text-align:left">进程的启动时间</td></tr><tr><td style="text-align:center">TTY</td><td style="text-align:left">开始此进程的终端设备。<span style="font-family:sans-serif">“?”</span>表示是系统启动的。<span style="font-family:sans-serif">“tty1”</span>至<span style="font-family:sans-serif">“tty6”</span>表示是本机上登录者程序。<span style="font-family:sans-serif">“pts/0”</span>等，则表示为由网络连接进主机的程序。</td></tr><tr><td style="text-align:center">TIME</td><td style="text-align:left">进程使用的CPU总时间</td></tr><tr><td style="text-align:center">CMD</td><td style="text-align:left">启动进程的命令和参数</td></tr></tbody></table></td></tr></table>

<p>2) 使用<code>aux</code>组合选项（注意前面没有<code>-</code>），可以查看当前系统所有的进程信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ps aux</div><div class="line">USER  PID    %CPU  %MEM   VSZ      RSS    TTY     STAT   START  TIME  COMMAND</div><div class="line">500   2878   0.1   18.3   2161124  89300  pts/0   Sl     12:37  0:27  /usr/<span class="built_in">local</span>/jdk1.8.0_144/bin/java -Dcom.sun.akuma.Daemon=daemonized -Djava.awt.headless=<span class="literal">true</span> -DJENKINS_HOME=/var/lib/jenkins</div><div class="line">... ...</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果想查看进程占用系统的内存和CPU信息可以选用该组合选项。其各字段的概述：</p><table><thead><tr><th style="text-align:center">字段</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">USER</td><td style="text-align:left">进程的拥有者</td></tr><tr><td style="text-align:center">PID</td><td style="text-align:left">进程ID</td></tr><tr><td style="text-align:center">%CPU</td><td style="text-align:left">进程占用的CPU百分比</td></tr><tr><td style="text-align:center">%MEM</td><td style="text-align:left">进程占用的内存的百分比</td></tr><tr><td style="text-align:center">VSZ</td><td style="text-align:left">进程使用的虚拟内存大小，单位：KB</td></tr><tr><td style="text-align:center">RSS</td><td style="text-align:left">进程占用的固定内存大小，单位：KB</td></tr><tr><td style="text-align:center">TTY</td><td style="text-align:left">开始此进程的终端设备。<span style="font-family:sans-serif">“?”</span>表示是系统启动的。<span style="font-family:sans-serif">“tty1”</span>至<span style="font-family:sans-serif">“tty6”</span>表示是本机上登录者程序。<span style="font-family:sans-serif">“pts/0”</span>等，则表示为由网络连接进主机的程序。</td></tr><tr><td style="text-align:center">STAT</td><td style="text-align:left">进程的状态。常见的状态有：<br>R：正在运行或可运行状态；<br>S：处于休眠状态，等待被唤醒；<br>Z：僵尸进程，程序已终止，进程无法正常退出；<br>T：已停止或处于被追踪状态；<br>D：不可中断，一般是在等待I/O；<br>&lt;：优先级高的进程；<br>N：优先级低的进程；<br>s：进程领导者，在它之下有子进程；<br>l：多线程的；</td></tr><tr><td style="text-align:center">START</td><td style="text-align:left">进程的启动时间</td></tr><tr><td style="text-align:center">TIME</td><td style="text-align:left">进程使用的CPU总时间</td></tr><tr><td style="text-align:center">COMMAND</td><td style="text-align:left">启动进程的命令和参数</td></tr></tbody></table></td></tr></table>

<p>3) 使用<code>-eo</code>选项，可以自定义显示的进程信息字段：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ ps -eo pid,pcpu,pmem,cmd</div><div class="line">  PID %CPU %MEM CMD</div><div class="line">    1  0.3  0.0 -bash</div><div class="line">    2  0.1  3.1 /usr/<span class="built_in">local</span>/jdk1.7.0_72/bin/java</div><div class="line">    ... ...</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><table><thead><tr><th style="text-align:left">字段</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">pid</td><td style="text-align:left">进程的ID</td></tr><tr><td style="text-align:left">pcpu</td><td style="text-align:left">进程的CPU百分占比%CPU</td></tr><tr><td style="text-align:left">pmem</td><td style="text-align:left">进程的内存百分占比%MEM</td></tr><tr><td style="text-align:left">cmd</td><td style="text-align:left">进程启动的命令CMD</td></tr></tbody></table></td></tr></table>

<p>4) 使用<code>--sort</code>选项，可以对指定的字段进行排序显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ps aux --sort -pmem</div><div class="line">USER       PID    %CPU %MEM    VSZ       RSS      TTY      STAT    START     TIME      COMMAND</div><div class="line">root       24742  0.1  3.1     2327664   123064   ?        Sl      3月26     105:28    /usr/<span class="built_in">local</span>/jdk1.7.0_72/bin/java</div><div class="line">root       648    0.0  0.7     331532    27592    ?        Ssl     3月25      0:47     /usr/bin/python</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>-pmem</code>表示对进程的内存百分占比%MEM降序排序。<code>-</code>是降序，<code>+</code>升序（默认是升序）。</p></td></tr></table>

<p>5) 找出最占内存的10个进程：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps aux --sort -pmem | head</div></pre></td></tr></table></figure>
<h3 id="20-kill-命令"><a href="#20-kill-命令" class="headerlink" title="20. kill 命令"></a>20. kill 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于杀死一个进程。</td></tr></table>

<p>该命令可以将给定的信号发送给指定的进程，如果没有给定明确的信号，则默认是发送<code>15</code>信号，该信号会终止进程。常用的信号有：</p>
<table>
<thead>
<tr>
<th style="text-align:center">信号</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:left">中断信号（ctrl + c）</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:left">强制终止</td>
</tr>
<tr>
<td style="text-align:center">15</td>
<td style="text-align:left">终止信号</td>
</tr>
<tr>
<td style="text-align:center">19</td>
<td style="text-align:left">暂停信号（ctrl + z）</td>
</tr>
</tbody>
</table>
<p>1) 强制杀掉进程ID为“2878”的进程（可以结合<code>ps</code>命令来查看进程ID）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">kill</span> -9 2878</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>kill 9</code>与<code>kill -9</code>的区别：<br><code>kill 9</code>：发送一个信号给进程并告诉进程，你需要终止运行。进程收到信号之后，并不会立刻停止运行，而是先释放占用的资源或者做一些其它的事情，并不会立即响应该信号，此进程仍然可能继续运行。<br><code>kill -9</code>：发送一个信号给进程并告诉进程，你需要立刻终止运行。该信号不能被捕获和忽略，进程收到后会立刻停止并退出。</p></td></tr></table>

<h3 id="21-top-命令"><a href="#21-top-命令" class="headerlink" title="21. top 命令"></a>21. top 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于查看进程占用系统资源的实时动态列表信息。</td></tr></table>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ top</div></pre></td></tr></table></figure>
<p>该命令输出的内容信息比较丰富，默认是每隔3秒自动刷新一次列表信息：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/shell3.png" alt=""></p>
<ul>
<li>第一行（系统整体的统计信息）：<ul>
<li><code>22:35:29</code>系统当前时间；</li>
<li><code>up 26 days, 13:33</code>系统连续运行的时间；</li>
<li><code>1 user</code>当前登录系统的用户数；</li>
<li><code>load average: 0.04, 0.03, 0.05</code>系统分别在1、5、15分钟内的平均负载；</li>
</ul>
</li>
<li>第二行（进程的统计信息）：<ul>
<li><code>133 total</code>进程的总数；</li>
<li><code>1 running</code>正在运行的进程数；</li>
<li><code>132 sleeping</code>休眠的进程数；</li>
<li><code>0 stopped</code>停止的进程数；</li>
<li><code>0 zombie</code>僵尸进程数；</li>
</ul>
</li>
<li>第三行（CPU的统计信息）：<ul>
<li><code>0.2 us</code>用户占用的CPU百分比；</li>
<li><code>0.2 sy</code>内核占用的CPU百分比；</li>
<li><code>99.6 id</code>空闲的CPU百分比；</li>
<li>其余不一一列举了…</li>
</ul>
</li>
<li>第四行（内存的统计信息）：<ul>
<li><code>12139564 total</code>物理内存的总大小；</li>
<li><code>1866952 free</code>空闲可用的物理内存总大小；</li>
<li><code>6600492 used</code>已经使用的物理内存总大小；</li>
<li><code>3672120 buff/cache</code>缓冲内存的总大小；</li>
</ul>
</li>
<li>第五行（交换分区的统计信息）：<ul>
<li><code>2097148 total</code>交换分区的总大小；</li>
<li><code>2062220 free</code>空闲可用的交换分区的大小；</li>
<li><code>34928 used</code>已经使用的交换分区的大小；</li>
</ul>
</li>
</ul>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>有时候，我们可能会看到CPU的使用率占比超过100%。这其实是因为<code>top</code>命令是按照单个CPU核数来计算的。也就是说，如果一台服务器的CPU核数为4核，那么该服务器的CPU使用率占比理论上最高可达到400%。</p><p>当系统物理内存剩余量不是很富余的时候，那就应该引起注意了。Linux系统有一个OOM-killer（Out Of Memory killer）机制。当Linux内核检测到系统内存不足的时候，就会触发OOM-killer来挑选一个最耗内存的进程并杀掉这个进程以求释放一些内存出来。</p><p>除此之外，<code>top</code>命令第一行的<code>load average</code>也很直观的反应出当前系统的性能指标，当数值是在0.00~1.00之间，则表示系统当前的状况良好。超过1.00则表示系统已经超出负荷。而实际上，我们也可能会看到服务器平均负载超过1.00的情况。这也跟服务器的CPU核数有关。如果一台服务器的CPU核数为4核，那么，该服务器的平均负载能力理论上可达到4.00。当系统平均负载达到总的70%左右时，就应该有所行动，在事情变得更糟糕之前，去分析其造成的原因。分析的焦点应放在后两项的数值，因为第一项是1分钟内的平均负载，时间太短，一瞬间的高并发导致该值大幅度上涨是很有可能的。</p></td></tr></table>

<p>进程信息区，部分字段的描述概要：</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PID</td>
<td style="text-align:left">进程ID</td>
</tr>
<tr>
<td style="text-align:left">USER</td>
<td style="text-align:left">进程所属者</td>
</tr>
<tr>
<td style="text-align:left">VIRT</td>
<td style="text-align:left">进程使用的虚拟内存总大小（KB）</td>
</tr>
<tr>
<td style="text-align:left">RES</td>
<td style="text-align:left">进程使用的物理内存大小（KB）</td>
</tr>
<tr>
<td style="text-align:left">SHR</td>
<td style="text-align:left">进程使用的共享内存的大小（KB）</td>
</tr>
<tr>
<td style="text-align:left">%CPU</td>
<td style="text-align:left">上次更新到现在的CPU时间占用百分比</td>
</tr>
<tr>
<td style="text-align:left">%MEM</td>
<td style="text-align:left">进程使用的物理内存百分比</td>
</tr>
<tr>
<td style="text-align:left">COMMAND</td>
<td style="text-align:left">进程启动的命令名或命令行</td>
</tr>
</tbody>
</table>
<p><code>top</code>命令支持按键操作响应事件，常用的按键操作有：</p>
<table>
<thead>
<tr>
<th style="text-align:left">按键</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">P（shift + p）</td>
<td style="text-align:left">按%CPU降序排序结果</td>
</tr>
<tr>
<td style="text-align:left">M（shift + m）</td>
<td style="text-align:left">按%MEM降序排序结果</td>
</tr>
<tr>
<td style="text-align:left">N（shift + n）</td>
<td style="text-align:left">按PID降序排序结果</td>
</tr>
<tr>
<td style="text-align:left">1（数字键1）</td>
<td style="text-align:left">查看每个核的CPU使用情况</td>
</tr>
<tr>
<td style="text-align:left">s</td>
<td style="text-align:left">刷新的时间间隔（默认是5秒）</td>
</tr>
<tr>
<td style="text-align:left">q</td>
<td style="text-align:left">退出命令</td>
</tr>
</tbody>
</table>
<p>1) 使用<code>-d</code>命令，可以指定列表信息刷新的时间间隔（默认是5秒）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ top -d 2</div></pre></td></tr></table></figure>
<p>2) 使用<code>-p</code>命令，可以指定特定的进程ID，只查看该进程的信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ top -p 12223</div></pre></td></tr></table></figure>
<h3 id="22-grep-命令"><a href="#22-grep-命令" class="headerlink" title="22. grep 命令"></a>22. grep 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于搜索文本内容。它能帮助你从大量的数据中快速找到你想要的数据。</td></tr></table>

<p>1) 查看“catalina.out”日志文件中，出现“ERROR”文本的行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep ERROR catalina.out</div></pre></td></tr></table></figure>
<p>2) 使用<code>-n, --line-number</code>选项，会对搜索匹配的行标记出其行号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -n ERROR catalina.out</div></pre></td></tr></table></figure>
<p>3) 使用<code>-e, --regexp</code>选项，可以一次指定搜索多个文本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -n -e WARN -e ERROR catalina.out</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于搜索“catalina.out”文件中，出现“WARN”或“ERROR”文本的行。</td></tr></table>

<p>4) 使用<code>--color</code>选项，可以在结果行中高亮显示搜索的文本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep --color catalina.out</div></pre></td></tr></table></figure>
<p>5) 使用<code>-E, --extended-regexp</code>选项（等效于<code>egrep</code>），可以使用正则表达式来搜索文本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ egrep <span class="string">'\b2018-05-17 11:[0-9]+'</span> catalina.out</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>用于搜索以“2018-05-17 11:”开头的行（即用于查看2018-05-17日11时的日志信息）。</p><p>常用的正则表达式表格：</p><p><table><thead><tr><th style="text-align:left">元字符</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">^</td><td style="text-align:left">匹配搜索字符串开始的位置。如“^abc”用于匹配以“abc”字符串开头的行。<br>如果用于中括号里面的第一个字符，则表示对字符集求反，如“[^abc]”用于匹配<br>除了以“a”或“b”或“c”以外的其它字符开头的行。</td></tr><tr><td style="text-align:left">$</td><td style="text-align:left">匹配搜索字符串结尾的位置。如“abc$”用于匹配以“abc”字符串结尾的行。</td></tr><tr><td style="text-align:left">\b</td><td style="text-align:left">锚定词首或词尾。如“\bhello”表示以“hello”开始的词。</td></tr><tr><td style="text-align:left">.</td><td style="text-align:left">匹配除换行符“\n”之外的任何单个字符。如“a.c”可以匹配“abc”或“a2c”等。</td></tr><tr><td style="text-align:left">?</td><td style="text-align:left">匹配零次或一次前面的字符或子表达式，等效于“{0,1}”。如“ab?c”可以匹配“abc”和“ac”。</td></tr><tr><td style="text-align:left"><em></em></td><td style="text-align:left">匹配零次或多次前面的字符或子表达式，等效于“{0,}”。如“abc”可以匹配“abc”和“ac”和“abbc”等。</td></tr><tr><td style="text-align:left">+</td><td style="text-align:left">匹配一次或多次前面的字符或子表达式，等效于“{1,}”。如“ab+c”可以匹配“abc”和“abbc”等。</td></tr><tr><td style="text-align:left">[ ]</td><td style="text-align:left">匹配中括号的开始和结尾。<br>如“[abc]”匹配“plain”中的“a”。<br>如“[a-z]”匹配26个小写英文字母。<br>如“[0-9]”匹配0到9的数字。</td></tr><tr><td style="text-align:left">{n}</td><td style="text-align:left">匹配前面的字符或子表达式正好n次。如“ab{2}c”匹配“abbc”。</td></tr><tr><td style="text-align:left">{n,}</td><td style="text-align:left">匹配前面的字符或子表达式至少n次。如“ab{2,}c”匹配“abbc”和“abbbc”等。</td></tr><tr><td style="text-align:left">{,m}</td><td style="text-align:left">匹配前面的字符或子表达式至多n次。如“ab{,2}c”匹配“ac”和“abc”和“abbc”。</td></tr><tr><td style="text-align:left">{n,m}</td><td style="text-align:left">匹配前面的字符或子表达式至少n次，至多m次。如“ab{2,3}c”匹配“abbc”和“abbbc”。</td></tr><tr><td style="text-align:left">\w</td><td style="text-align:left">匹配字母和数字，相当于“[0-9A-Za-z]”</td></tr><tr><td style="text-align:left">\W</td><td style="text-align:left">匹配非字母和数字，相当于“[^0-9A-Za-z]”</td></tr></tbody></table></p></td></tr></table>

<p>6) 使用<code>-v, --invert-match</code>选项，可以反转查找：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps -ef | grep java | grep -v grep</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>查看“java”进程信息，并且将<code>grep java</code>行的信息排除掉。</p></td></tr></table>

<p>7) 使用<code>-R, -r, --recursive</code>选项，可以从一个目录中的所有文件中搜索：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -r ERROR logs/</div></pre></td></tr></table></figure>
<h3 id="23-find-命令"><a href="#23-find-命令" class="headerlink" title="23. find 命令"></a>23. find 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>用于查找系统的文件。它能帮助你快速的定位和找到你想要的文件。</p><p>语法：<code>find [查找的目录] [选项] [参数]</code></p></td></tr></table>

<p>1) 使用<code>-name</code>选项，可以按文件的名称进行查找：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -name <span class="string">'*.log'</span></div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>在当前目录（“.”表示当前目录，<code>find</code>命令查找时，会对给定的目录以及该目录下所有的子目录都进行查找）下，查找“*.log”文件。</p><p><code>find</code>命令支持通配（<code>*</code>），为避免<code>*</code>被bash进行扩展，因此需要加引号。</p></td></tr></table>

<p>2) 使用<code>-type</code>选项，可以按文件类型进行查找：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -<span class="built_in">type</span> d</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>常见的文件类型有：</p><p><table><thead><tr><th style="text-align:left">文件类型</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">f</td><td style="text-align:left">普通文件</td></tr><tr><td style="text-align:left">d</td><td style="text-align:left">目录</td></tr><tr><td style="text-align:left">l</td><td style="text-align:left">符号链接</td></tr></tbody></table></p></td></tr></table>

<p>3) 使用<code>-mmin</code>选项（last modified minutes），可以查找在指定时间被更改过的文件或目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -name <span class="string">'*.log'</span> -mmin -3</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>-3</code>表示查找3分钟前。</p></td></tr></table>

<p>4) 使用<code>-exec command {} \;</code>选项，可以执行一个任意的command命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -name <span class="string">'*.log'</span> -<span class="built_in">exec</span> cat &#123;&#125; \; &gt; logs.txt</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>该命令是用于将当前目录下的所有的log文件的内容拼接成一个数据流重定向到logs.txt文件中。</p><p>其中的<code>{}</code>是与<code>-exec</code>选项搭配使用的一个特殊符，它最终会被替换为<code>find</code>命令匹配到的每个文件的文件名称。</p></td></tr></table>

<h3 id="24-su-命令"><a href="#24-su-命令" class="headerlink" title="24. su 命令"></a>24. su 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>用于切换用户身份。用户身份变更时，需要输入变更的用户账户密码。特殊的，root用户切换到其它用户账户时，不需要密码。<br>用户身份切换可以通过<code>ctrl + d</code>发送一个 exit 信号，用于快捷退出当前登录的用户账户，以返回切换前的用户身份。</p></td></tr></table>

<p><code>su [user]</code>可以切换当前的用户身份。默认<code>su</code>是切换为root用户：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ su</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>它等效于：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ su root</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>切换为“testusr”用户：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ su testusr</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>切换用户身份后，不会改变用户所在的当前目录。<br>如切换用户前是在“/home/fanlychie/myconfig”目录下，切换用户后还是在“/home/fanlychie/myconfig”目录下。</p></td></tr></table>

<p><code>su - [user]</code>切换当前的用户身份，并将工作目录改变为目标用户的“home”目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ su - testusr</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>例如切换用户前是在“/home/fanlychie/myconfig”目录下，切换用户后是在“/home/testusr”目录下。</p></td></tr></table>

<h3 id="25-前台和后台任务"><a href="#25-前台和后台任务" class="headerlink" title="25. 前台和后台任务"></a>25. 前台和后台任务</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>后台进程也叫守护进程，是运行在系统后台的一种特殊的进程，它脱离了终端控制台的控制。<br>前台进程是用户使用有控制终端的进程，它通常以窗口或对话框的形式展现。</p></td></tr></table>

<p>如果想要将一个进程放到后台去运行，只需在命令的末尾加<code>&amp;</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -jar spring-boot-application.jar &amp;</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>一般情况下，当用户退出终端时，用户启动的后台进程也会跟着退出。为了使进程可靠的在后台不间断的运行，可以使用<code>nohup command &amp;</code>。</p></td></tr></table>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nohup java -jar spring-boot-application.jar &amp;</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>默认情况下，<code>nohup</code>命令会将标准输出和标准错误输出重定向到当前目录下的“nohub.out”文件中。<code>nohup</code>并不能让进程在后台运行，但能让进程忽略挂断信号。用户退出终端或网络断开的情况下，<code>nohup</code>进程不会退出。</p></td></tr></table>

<p>当我们使用<code>nohup command &amp;</code>命令启动一个后台进程时，我们可能并不希望日志信息输出到前台或“nohub.out”文件中，特别是在使用脚本启动一个后台进程时。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nohup java -jar spring-boot-application.jar &gt;/dev/null 2&gt;&amp;1 &amp;</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>&gt;/dev/null</code>中的：<br><code>&gt;</code>表示重定向到某个地方。默认是标准输出，即<code>&gt;</code>等效于<code>1&gt;</code>。<br><code>/dev/null</code>是系统的空设备文件，经常被用来当做垃圾箱使用。也有人把它比作“黑洞”，因为所有输出到这里的东西都会消失的无影无踪，在终端上也不会显示任何信息。</p></td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>2&gt;&amp;1</code>中的：<br><code>&gt;&amp;</code>是等同于的意思。<br><code>2&gt;&amp;1</code>则是表示将标准错误重定向到与标准输出相同的地方。</p></td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>总的来说，这条命令的言外之意就是在后台启动一个服务，服务启动输出的信息和错误信息都不要显示在终端。</p></td></tr></table>

<p>上面涉及到的“1”和“2”是文件描述符，文件描述符是用来描述输入和输出的整数。最常见的文件描述符：</p>
<table>
<thead>
<tr>
<th style="text-align:center">文档类型</th>
<th style="text-align:center">说明</th>
<th style="text-align:center">文件描述符</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">stdin</td>
<td style="text-align:center">标准输入</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">stdout</td>
<td style="text-align:center">标准输出</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">stderr</td>
<td style="text-align:center">标准错误</td>
<td style="text-align:center">2</td>
</tr>
</tbody>
</table>
<p>后台的任务（或称进程，或称作业）可以使用<code>jobs</code>命令来查看：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">jobs</span></div><div class="line">[1]-  Running    nohup java -jar spring-boot-application.jar &gt; /dev/null 2&gt;&amp;1 &amp;</div><div class="line">[2]+  Stopped    tail -f nohup.out</div></pre></td></tr></table></figure>
<p>其中，<code>[num]</code>里面的数字表示的是任务序号，<code>+</code>号表示默认选择的任务。<code>-</code>号的任务需要通过任务序号来选择。</p>
<p>使用<code>fg [num]</code>命令可以将一个后台进程切换到前台，若<code>fg</code>命令后面没有指定任务序号，表示切换至默认的任务，即带<code>+</code>号的任务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">fg</span></div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>其等效于：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">fg</span> 2</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>通过使用组合键<code>ctrl + z</code>也可以将一个前台进程暂停并且放到后台中。比如通过<code>vi</code>编辑文件或通过<code>tail</code>查看文件的时候，<code>ctrl + z</code>将其放入后台后，可以非常方便的切换回来。</p>
<p>命令<code>bg [num]</code>可以让一个后台暂停的进程变为继续运行。同样的，若<code>bg</code>命令后面没有指定任务序号，表示默认选择带<code>+</code>号的任务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">bg</span></div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>其等效于：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">bg</span> 2</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>后台进程可以先切换至前台然后按<code>ctrl + c</code>强制中断杀死进程。也可以通过<code>kill %num</code>来杀死。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">kill</span> %2</div></pre></td></tr></table></figure>
<h3 id="26-磁盘空间"><a href="#26-磁盘空间" class="headerlink" title="26. 磁盘空间"></a>26. 磁盘空间</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>系统的磁盘空间是一种有限的存储介质资源。当系统磁盘空间使用快要爆满时，我们需要删除或移走部分文件以腾出更多可用的磁盘空间。掌握如何去查看服务器的磁盘空间的使用情况这就显得很重要了。<code>df</code>和<code>du</code>是 Linux 系统中用于查看系统磁盘使用情况的两个重要命令。</p></td></tr></table>

<p><code>df</code>（disk free，磁盘可用空间），用于查看服务器磁盘空间的使用情况：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ df -h</div><div class="line">Filesystem     Size    Used     Avail    Use%     Mounted on</div><div class="line">/dev/sda2      19G     3.1G     15G      18%      /</div><div class="line">tmpfs          238M    0        238M     0%       /dev/shm</div><div class="line">/dev/sda1      291M    34M      242M     13%      /boot</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>参数<code>-h, –human-readable</code>是使用易读格式（人类更易懂的）, 将数值自动转换为常见 M、G 等单位显示。</p></td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>其中，Size 是磁盘总的容量，Used 是已用的空间，Avail 是剩余可用的空间（重要），Use% 是已用的空间的百分比。</p></td></tr></table>

<p><code>du</code>（disk usage，磁盘使用），用于查看文件或目录占用的磁盘空间大小：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ du -h logs</div><div class="line">81M	logs/app</div><div class="line">149M	logs</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>参数<code>-h, –human-readable</code>是使用易读格式（人类更易懂的）, 将数值自动转换为常见 M、G 等单位显示。</p></td></tr></table>

<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>可以看出，logs目录总共占149M的磁盘空间。其中，logs/app目录共占81M，剩余的68M被logs根目录下的文件占用。如果想要查看各个文件占用的磁盘空间，可以追加使用<code>-a, –all</code>参数：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ du -ha logs</div><div class="line">332K	logs/demo1.log</div><div class="line">20K	logs/demo2.log</div><div class="line">68M	logs/demo3.log</div><div class="line">49M	logs/app/app-demo2.log</div><div class="line">33M	logs/app/app-demo1.log</div><div class="line">81M	logs/app</div><div class="line">149M	logs</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>参数<code>-s，--summarize</code>仅显示总计，如统计当前路径下所有的文件或目录占用的磁盘空间：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ du -sh *</div><div class="line">1.2G	apps</div><div class="line">149M	logs</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果只是想统计当前路径占用的磁盘空间可以使用<code>du -sh</code>（等效于：<code>du -sh .</code>）：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ du -sh</div><div class="line">1.3G	.</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<h3 id="27-内存空间"><a href="#27-内存空间" class="headerlink" title="27. 内存空间"></a>27. 内存空间</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>free</code>命令可用于查看系统内存的使用情况。</p></td></tr></table>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ free -h</div><div class="line">              total        used        free      shared  buff/cache   available</div><div class="line">Mem:            11G        6.7G        155M         75M        4.7G        4.4G</div><div class="line">Swap:          2.0G         20M        2.0G</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>参数<code>-h, –human-readable</code>是使用易读格式（人类更易懂的）, 将数值自动转换为常见 M、G 等单位显示。</p></td></tr></table>

<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">total</td>
<td style="text-align:left">总的内存。</td>
</tr>
<tr>
<td style="text-align:left">used</td>
<td style="text-align:left">已使用的内存。</td>
</tr>
<tr>
<td style="text-align:left">free</td>
<td style="text-align:left">可用的内存。</td>
</tr>
<tr>
<td style="text-align:left">shared</td>
<td style="text-align:left">多个进程共享的内存。</td>
</tr>
<tr>
<td style="text-align:left">buff/cache</td>
<td style="text-align:left">缓冲区和缓存使用的内存。</td>
</tr>
<tr>
<td style="text-align:left">available</td>
<td style="text-align:left">可用的内存。当系统内存不足（没有足够的free内存可用时），就会从buff/cache中回收部分空间，以满足应用程序的需求。这是一个理想的值，它往往存在一些误差。</td>
</tr>
</tbody>
</table>
<p>第一行<code>Mem</code>表示物理内存。第二行<code>Swap</code>是交换空间，它是磁盘上的一块区域。当系统的物理内存吃紧时，Linux 就会将内存中不常用的数据存储到 swap 分区上，这样就能腾出一些内存空间来为其他应用程序服务。当系统需要用到 swap 分区上存储的数据时，Linux 再将这些数据调入内存中。这就是换入和换出。swap 分区可以在一定程度上缓解内存不足的情况，但是它需要读写磁盘数据，所以性能不是很高。</p>
<h3 id="28-wc-命令"><a href="#28-wc-命令" class="headerlink" title="28. wc 命令"></a>28. wc 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>word count（单词统计）。</p></td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>用于统计文件或从标准设备读入的数据的行数、单词数和字符数。</p></td></tr></table>

<p>参数<code>-c, --bytes</code>用于统计字符数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ wc -c zookeeper.out </div><div class="line">60669 zookeeper.out</div></pre></td></tr></table></figure>
<p>参数<code>-w, --words</code>用于统计单词数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ wc -w zookeeper.out </div><div class="line">4169 zookeeper.out</div></pre></td></tr></table></figure>
<p>参数<code>-l, --lines</code>用于统计行数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ wc -l zookeeper.out </div><div class="line">491 zookeeper.out</div></pre></td></tr></table></figure>
<h3 id="29-netstat-命令"><a href="#29-netstat-命令" class="headerlink" title="29. netstat 命令"></a>29. netstat 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>用于查看系统的网络状态信息。</p></td></tr></table>

<p>使用<code>-ant</code>组合选项，可以查看所有的TCP连接状态信息：</p>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>-a, –all</code>显示所有的socket链接<br><code>-n, –numeric</code>使用数字类型的IP地址显示<br><code>-t, –tcp</code>只显示TCP传输协议的链接</p></td></tr></table>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ netstat -ant</div><div class="line">Proto     Recv-Q     Send-Q     Local Address           Foreign Address        State</div><div class="line">tcp6      0          0          :::20818                :::*                   LISTEN</div><div class="line">tcp6      0          0          :::20809                :::*                   LISTEN</div><div class="line">tcp6      0          0          10.10.10.171:20818      10.10.10.170:55648     ESTABLISHED</div><div class="line">tcp6      0          0          10.10.10.171:20818      10.10.10.170:34580     ESTABLISHED</div><div class="line">tcp6      0          0          10.10.10.171:20809      10.10.10.176:26379     ESTABLISHED</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><table><thead><tr><th style="text-align:left">字段</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">Local Address</td><td style="text-align:left">本地地址和端口信息</td></tr><tr><td style="text-align:left">Foreign Address</td><td style="text-align:left">远程地址和端口信息</td></tr><tr><td style="text-align:left">State</td><td style="text-align:left">状态信息。常见的状态有：<br>LISTEN：本地监听的端口；<br>ESTABLISHED：远程访问本机服务的地址和端口信息；<br>TIME_WAIT：链接已挂断，socket在网络上等待结束；</td></tr></tbody></table></td></tr></table>

<p>使用<code>-lntp</code>组合选项，可以查看系统监听端口的所有进程信息：</p>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>-l, –listening</code>只显示监听中的socket链接<br><code>-n, –numeric</code>使用数字类型的IP地址显示<br><code>-t, –tcp</code>只显示TCP传输协议的链接<br><code>-p, –program</code>显示正在使用此socket的进程PID和进程名称</p></td></tr></table>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ netstat -lntp</div><div class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name             </div><div class="line">tcp6       0      0 :::20811                :::*                    LISTEN      20369/java          </div><div class="line">tcp6       0      0 :::20813                :::*                    LISTEN      20465/java          </div><div class="line">tcp6       0      0 :::20815                :::*                    LISTEN      20489/java</div></pre></td></tr></table></figure>
<p>查找某个端口被哪个进程占用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ netstat -lntp | grep 8080</div><div class="line">tcp6       0      0 :::8080                 :::*                    LISTEN      7596/java</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>由此可见，8080端口被进程PID为7596的程序占用。然后可以通过<code>ps</code>命令查找出该进程所属的程序：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ps -ef | grep 7596</div><div class="line">joinpay   7596     1  0 7月09 ?       00:04:26 /usr/<span class="built_in">local</span>/jdk1.7.0_72/...</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>统计某个端口的服务当前的链接数量。如统计“20818”端口：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ netstat -ant | grep <span class="string">":20818"</span> | wc -l</div><div class="line">21</div></pre></td></tr></table></figure>
<h3 id="30-vi-命令"><a href="#30-vi-命令" class="headerlink" title="30. vi 命令"></a>30. vi 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>vi</code>是 Linux 系统中的一个强大的编辑器。可用于文本的写入、替换、删除、查找等。<br><code>vi</code>编辑器的三种模式：<br>1．命令模式：可以控制光标移动、字符或行等的删除或复制等操作；<br>2．插入模式：顾名思义就是插入文本，只有在该模式下才可以输入字符；<br>3．底行模式：可以设置编辑器环境、字符查找、文件保存和退出等操作；</p></td></tr></table>

<p>在命令模式下可以通过按键进行：</p>
<table>
<thead>
<tr>
<th style="text-align:left">按键</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">j</td>
<td style="text-align:left">光标向下移动（ ↓ ）</td>
</tr>
<tr>
<td style="text-align:left">k</td>
<td style="text-align:left">光标向上移动（ ↑ ）</td>
</tr>
<tr>
<td style="text-align:left">h</td>
<td style="text-align:left">光标向左移动（←）</td>
</tr>
<tr>
<td style="text-align:left">l</td>
<td style="text-align:left">光标向右移动（→）</td>
</tr>
<tr>
<td style="text-align:left">gg</td>
<td style="text-align:left">文首</td>
</tr>
<tr>
<td style="text-align:left">G</td>
<td style="text-align:left">文尾</td>
</tr>
<tr>
<td style="text-align:left">nG</td>
<td style="text-align:left">n是一个数字，定位到第n行</td>
</tr>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">行首（数字0）</td>
</tr>
<tr>
<td style="text-align:left">^</td>
<td style="text-align:left">行首</td>
</tr>
<tr>
<td style="text-align:left">$</td>
<td style="text-align:left">行尾</td>
</tr>
<tr>
<td style="text-align:left">dd</td>
<td style="text-align:left">删除光标所在的行</td>
</tr>
<tr>
<td style="text-align:left">yy</td>
<td style="text-align:left">复制光标所在的行</td>
</tr>
<tr>
<td style="text-align:left">x</td>
<td style="text-align:left">从光标高亮处（包括高亮处）开始向后（右）删除字符</td>
</tr>
<tr>
<td style="text-align:left">X</td>
<td style="text-align:left">从光标高亮处（不包括高亮处）开始向前（左）删除字符</td>
</tr>
<tr>
<td style="text-align:left">p</td>
<td style="text-align:left">将复制的内容粘贴在光标所在行的下一行</td>
</tr>
<tr>
<td style="text-align:left">P</td>
<td style="text-align:left">将复制的内容粘贴在光标所在行的上一行</td>
</tr>
<tr>
<td style="text-align:left">u</td>
<td style="text-align:left">还原动作</td>
</tr>
<tr>
<td style="text-align:left">.</td>
<td style="text-align:left">重复动作</td>
</tr>
<tr>
<td style="text-align:left">?word</td>
<td style="text-align:left">向上查找word字符串</td>
</tr>
<tr>
<td style="text-align:left">/word</td>
<td style="text-align:left">向下查找word字符串</td>
</tr>
<tr>
<td style="text-align:left">n</td>
<td style="text-align:left">同方向搜索（如果是“?”则是向上搜索，如果是“/”则是向下搜索）</td>
</tr>
<tr>
<td style="text-align:left">N</td>
<td style="text-align:left">反方向搜索（如果是“?”则是向下搜索，如果是“/”则是向上搜索）</td>
</tr>
</tbody>
</table>
<p>在命令模式下，通过以下的操作可以进入插入模式：</p>
<table>
<thead>
<tr>
<th style="text-align:left">按键</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">i</td>
<td style="text-align:left">在光标高亮处之前插入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">在光标所在行的行首插入</td>
</tr>
<tr>
<td style="text-align:left">a</td>
<td style="text-align:left">在光标高亮处之后追加</td>
</tr>
<tr>
<td style="text-align:left">A</td>
<td style="text-align:left">在光标所在行的行尾插入</td>
</tr>
<tr>
<td style="text-align:left">o</td>
<td style="text-align:left">在光标所在行的下一行插入一个空行</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">在光标所在行的上一行插入一个空行</td>
</tr>
<tr>
<td style="text-align:left">Esc</td>
<td style="text-align:left">退出插入模式，回到命令模式</td>
</tr>
</tbody>
</table>
<p>在命令模式下，通过以下的操作可以进入底行模式：</p>
<table>
<thead>
<tr>
<th style="text-align:left">按键</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">:w</td>
<td style="text-align:left">保存</td>
</tr>
<tr>
<td style="text-align:left">:q</td>
<td style="text-align:left">退出</td>
</tr>
<tr>
<td style="text-align:left">:w!</td>
<td style="text-align:left">强制写入保存</td>
</tr>
<tr>
<td style="text-align:left">:q!</td>
<td style="text-align:left">强制退出</td>
</tr>
<tr>
<td style="text-align:left">:wq</td>
<td style="text-align:left">保存退出</td>
</tr>
<tr>
<td style="text-align:left">:wq!</td>
<td style="text-align:left">强制保存退出</td>
</tr>
<tr>
<td style="text-align:left">:set nu</td>
<td style="text-align:left">显示行号</td>
</tr>
<tr>
<td style="text-align:left">:set nonu</td>
<td style="text-align:left">不显示行号</td>
</tr>
<tr>
<td style="text-align:left">:nohl</td>
<td style="text-align:left">退出匹配的高亮显示</td>
</tr>
<tr>
<td style="text-align:left">:s/表达式/替换字符/</td>
<td style="text-align:left">替换当前行匹配到的第一个处</td>
</tr>
<tr>
<td style="text-align:left">:s/表达式/替换字符/g</td>
<td style="text-align:left">替换当前行匹配到的所有处</td>
</tr>
<tr>
<td style="text-align:left">:%s/表达式/替换字符/g</td>
<td style="text-align:left">替换文档中匹配到的所有处</td>
</tr>
<tr>
<td style="text-align:left">ZZ</td>
<td style="text-align:left">保存退出</td>
</tr>
<tr>
<td style="text-align:left">ZQ</td>
<td style="text-align:left">不保存退出</td>
</tr>
</tbody>
</table>
<p>编辑“hello.txt”文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi hello.txt</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>其文件内容如下：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hello world</div></pre></td></tr></table></figure><br><br><p>输入:<code>%s/o/O/g</code>可将全部的“o”替换成“O”。</p><br></span></td></tr></table>

<p><code>vi</code>命令除了可以用来编辑文件之外，使用它来查看日志文件也是一个利器：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi -R my.log</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>-R</code>是只读模式，为避免不小心编辑到日志文件，最好加上此参数项。在<code>vi</code>编辑器里，你可以利用它强大的命令快捷的查看日志文件的内容。</p></td></tr></table>

<h3 id="N-rpm-命令"><a href="#N-rpm-命令" class="headerlink" title="N. rpm 命令"></a>N. rpm 命令</h3><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">RedHat Package Manager（RedHat Linux操作系统的软件包管理工具）。</td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;">用于对“*.rpm”软件包进行安装、查询、卸载等。</td></tr></table>

<h3 id="N-vi-命令"><a href="#N-vi-命令" class="headerlink" title="N. vi 命令"></a>N. vi 命令</h3><h3 id="01-命令执行控制"><a href="#01-命令执行控制" class="headerlink" title="01. 命令执行控制"></a>01. 命令执行控制</h3><p>使用<code>;</code>，<code>||</code>，<code>&amp;&amp;</code>分隔符，可以在一个命令行中执行多条命令。</p>
<p><strong>[ ; ]</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ command1 ; command2 [ ; command3 ...]</div></pre></td></tr></table></figure>
<p>command1执行不管成功与否，command2总是会继续执行。它相当于：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ command1</div><div class="line">$ command2</div></pre></td></tr></table></figure>
<p>示例：进入目录，罗列指定字符开头的文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> logs/ ; ll spring-boot-demo*</div></pre></td></tr></table></figure>
<p><strong>[ || ]</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ command1 || command2 [ || command3 ...]</div></pre></td></tr></table></figure>
<p>command1执行失败时，command2才执行。command1执行成功时，command2不执行。即或逻辑。</p>
<p>示例：关闭防火墙，如果操作失败，输出 fail。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ service iptables stop || <span class="built_in">echo</span> <span class="string">"fail"</span></div></pre></td></tr></table></figure>
<p><strong>[ &amp;&amp; ]</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ command1 &amp;&amp; command2 [ &amp;&amp; command3 ...]</div></pre></td></tr></table></figure>
<p>command1执行成功时，command2才执行。command1执行失败时，command2不执行。即与逻辑。</p>
<p>示例：启动 Tomcat 应用，启动命令执行成功后，打开控制台查看日志。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/startup.sh &amp;&amp; tail -f logs/catalina.out</div></pre></td></tr></table></figure>
<h2 id="02-后台进程"><a href="#02-后台进程" class="headerlink" title="02. 后台进程"></a>02. 后台进程</h2><p>如果想要将一个进程放到后台去运行，只需在命令的末尾加<code>&amp;</code>。</p>
<p>示例：启动服务，并让其在后台运行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -jar spring-boot-application.jar &amp;</div></pre></td></tr></table></figure>
<p>一般情况下，当用户退出终端时，用户启动的后台进程也会跟着退出。为了使进程可靠的在后台不间断的运行，可以使用<code>nohup command &amp;</code>。</p>
<p>示例：启动服务，并让其在后台不间断的运行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nohup java -jar spring-boot-application.jar &amp;</div></pre></td></tr></table></figure>
<p>默认情况下，<code>nohup</code>命令会将标准输出和标准错误输出重定向到当前目录下的<code>nohub.out</code>文件中。<code>nohup</code>并不能让进程在后台运行，但能让进程忽略挂断信号。用户退出终端或网络断开的情况下，<code>nohup</code>进程不会退出。</p>
<h2 id="03-文件描述符"><a href="#03-文件描述符" class="headerlink" title="03. 文件描述符"></a>03. 文件描述符</h2><p>文件描述符是用来描述输入和输出的整数。最常见的文件描述符：</p>
<table>
<thead>
<tr>
<th style="text-align:center">文档类型</th>
<th style="text-align:center">说明</th>
<th style="text-align:center">文件描述符</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">stdin</td>
<td style="text-align:center">标准输入</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">stdout</td>
<td style="text-align:center">标准输出</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">stderr</td>
<td style="text-align:center">标准错误</td>
<td style="text-align:center">2</td>
</tr>
</tbody>
</table>
<p>示例：启动服务，并让其在后台不挂断的运行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nohup java -jar spring-boot-application.jar &gt;/dev/null 2&gt;&amp;1 &amp;</div></pre></td></tr></table></figure>
<p>上面已经介绍了<code>nohup command &amp;</code>。我们这里主要来分析<code>&gt;/dev/null 2&gt;&amp;1</code>片段的含义和作用：</p>
<ul>
<li>第一部分：<code>&gt;</code>是重定向到某个地方。默认是标准输出，即<code>&gt;</code>等效于<code>1&gt;</code>。</li>
<li>第二部分：<code>/dev/null</code>是系统的空设备文件，经常被用来当做垃圾箱使用。也有人把它比作<span style="font-family:sans-serif">“黑洞”</span>，为所有输出到这里的东西都会消失的无影无踪，在终端上也不会显示任何信息。</li>
<li>第三部分：<code>&gt;&amp;</code>是等同于的意思。<code>2&gt;&amp;1</code>则是将标准错误重定向到与标准输出相同的地方。</li>
</ul>
<p>综上所述，这条命令的中心思想是：在后台运行服务，启动输出的信息和错误信息都不要显示在终端。</p>
<h2 id="04-前后台任务互切"><a href="#04-前后台任务互切" class="headerlink" title="04. 前后台任务互切"></a>04. 前后台任务互切</h2><p>上面介绍了<code>&amp;</code>将进程放到后台去运行，使用<code>jobs</code>命令可查看后台进程：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">jobs</span></div><div class="line">[1]-  Running    nohup java -jar spring-boot-application.jar &gt; /dev/null 2&gt;&amp;1 &amp;</div><div class="line">[2]+  Stopped    tail -f nohup.out</div></pre></td></tr></table></figure>
<p><code>[]</code>里面的数字表示的是任务序号，<code>+</code>号表示默认选择的任务。<code>-</code>号的任务需要通过任务序号来选择。</p>
<p><code>fg [任务序号]</code>可以将一个后台进程切换到前台，若<code>fg</code>命令后面没有指定任务序号，表示切换至默认的任务，即带<code>+</code>号的任务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">fg</span> 1</div></pre></td></tr></table></figure>
<p>组合键<code>ctrl + z</code>也可以将一个前台进程放到后台并且暂停。比如通过<code>vi</code>编辑文件或通过<code>tail</code>查看文件的时候，<code>ctrl + z</code>将其放入后台后，可以非常方便的切换回来。</p>
<p><code>bg [任务序号]</code>可以让一个后台暂停的进程变为继续运行。同样的，若<code>bg</code>命令后面没有指定任务序号，表示默认选择带<code>+</code>号的任务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">bg</span> 1</div></pre></td></tr></table></figure>
<p>后台进程可以先切换至前台然后按<code>ctrl + c</code>强制中断杀死进程。也可以通过<code>kill %任务序号</code>来杀死。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">kill</span> %2</div></pre></td></tr></table></figure>
<h2 id="05-管道"><a href="#05-管道" class="headerlink" title="05. 管道"></a>05. 管道</h2><p>管道<span style="font-family:sans-serif">“|”</span>可以将上一个命令的标准输出传递到下一个命令，并作为下一个命令的标准输入。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ command1 | command2 [ | command3 ...]</div></pre></td></tr></table></figure>
<p>查看目录下的文件，并显示行号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ ll | cat -n</div><div class="line">  1	total 40</div><div class="line">  2	drwxr-xr-x. 2 fanlychie fanlychie 4096 Nov  5 00:24 Desktop</div><div class="line">  3	drwxr-xr-x. 2 fanlychie fanlychie 4096 Nov  5 00:23 Documents</div><div class="line">  4	drwxr-xr-x. 2 fanlychie fanlychie 4096 Nov  5 00:23 Downloads</div></pre></td></tr></table></figure>
<h2 id="06-空格"><a href="#06-空格" class="headerlink" title="06. 空格"></a>06. 空格</h2><p>在 shell 编程中，空格是一个分隔符。一个常见的错误是：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">name = fanlychie</div><div class="line"><span class="built_in">echo</span> <span class="variable">$name</span></div></pre></td></tr></table></figure>
<p>执行的时候就会报：<code>line 2: name: command not found</code>。原因是<code>=</code>两边有空格，shell 会认为空格前面是一个命令，因此会报命令找不到的错误。</p>
<p>在 shell 编程中，空格的用法常见的有：</p>
<ul>
<li>命令和选项之间必须有空格；</li>
<li>赋值符号<code>=</code>两边不能有空格；</li>
<li>测试语句<code>[</code>的两边要有空格，<code>]</code>的左边要有空格。如<code>if [ condition ]</code>；</li>
<li>分隔符<code>;</code>、<code>||</code>、<code>&amp;&amp;</code>两边的空格可有可无；</li>
<li>管道<code>|</code>两边的空格可有可无；</li>
</ul>
<h2 id="07-引号"><a href="#07-引号" class="headerlink" title="07. 引号"></a>07. 引号</h2><p>当操作一个字符串时，如果该字符串中含有空格，那么，空格前面的字符就会被当成命令来执行。被引号包裹起来的字符串，shell 会将它当成一个普通的字符串对待，而不会去解析成命令来执行。</p>
<p><strong>单引号</strong></p>
<p>单引号<code>&#39;&#39;</code>包裹的内容是所见即所得。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">sayhi=<span class="string">'hello world'</span></div><div class="line"><span class="built_in">echo</span> <span class="variable">$sayhi</span></div></pre></td></tr></table></figure>
<p>执行结果：<code>hello world</code></p>
<p>单引号里面引用的变量无效（所见即所得，任何变量都不会被替换）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">sayhi=<span class="string">'hello world'</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'You have one new message: $sayhi'</span></div></pre></td></tr></table></figure>
<p>执行结果：<code>You have one new message: $sayhi</code></p>
<p><strong>双引号</strong></p>
<p>双引号<code>&quot;&quot;</code>包裹的内容，可以引用外部定义的变量。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">sayhi=<span class="string">"hello world"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"You have one new message: <span class="variable">$sayhi</span>"</span></div></pre></td></tr></table></figure>
<p>执行结果：<code>You have one new message: hello world</code></p>
<p><strong>反引号</strong></p>
<p>反引号<code>``</code>（键盘左上角Esc正下方的键）包裹的内容，可以用于存储命令的输出，即命令替换。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">echo</span> <span class="string">"curr time: `date`"</span></div></pre></td></tr></table></figure>
<p>执行结果：<code>curr time: Sat Nov 11 14:17:15 UTC 2017</code></p>
<h2 id="10-文本搜索"><a href="#10-文本搜索" class="headerlink" title="10. 文本搜索"></a>10. 文本搜索</h2><p>文本搜索能力很重要。它能帮助你从大量的数据中快速定位和找到你想要的数据。常用的是通过<code>grep</code>命令完成。语法：<code>grep [OPTIONS] PATTERN [FILE...]</code></p>
<p>示例：查找日志文件中，所有出现<span style="font-family:sans-serif">“ERROR”</span>字符串的地方：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep ERROR access.log</div></pre></td></tr></table></figure>
<p>示例：查找日志文件中，所有出现<span style="font-family:sans-serif">“ERROR”</span>字符串的地方，并打印行号：</p>
<p>参数：-n, --line-number</p>
<p>释义：搜索的结果显示文本在文件中的行号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -n ERROR access.log</div></pre></td></tr></table></figure>
<p>示例：查找日志文件中，所有出现“ERROR”字符串的地方，并打印行号高亮显示：</p>
<p>参数：--color</p>
<p>释义：匹配的文本会被不同颜色高亮显示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -n --color ERROR access.log</div></pre></td></tr></table></figure>
<p>示例：查找目录下所有的日志文件中，所有出现<span style="font-family:sans-serif">“ERROR”</span>字符串的地方，并打印行号高亮显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -n --color ERROR *.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>示例：查找日志文件中，所有出现<span style="font-family:sans-serif">“ERROR”</span>或<span style="font-family:sans-serif">“WARN”</span>字符串的地方，并打印行号高亮显示：</p>
<p>参数：-e, --regexp</p>
<p>释义：允许指定多个不同的搜索字符串</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -n --color -e ERROR -e WARN access.log</div></pre></td></tr></table></figure>
<p>示例：查找日志文件中，所有出现<span style="font-family:sans-serif">“Exception”</span>字符串的地方，并打印行号高亮显示：</p>
<p>参数：-E, --extended-regexp</p>
<p>释义：允许搜索串中使用正则表达式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ grep -En --color <span class="string">'\b\w+Exception\b'</span> access.log</div></pre></td></tr></table></figure>
<p><code>egrep</code>等效于<code>grep -E</code>。可以在搜索串中使用正则表达式来匹配。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ egrep -n --color <span class="string">'\b\w+Exception\b'</span> access.log</div></pre></td></tr></table></figure>
<p>示例：查找日志文件中，最近出现<span style="font-family:sans-serif">“Exception”</span>字符串的10个地方，并打印行号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ egrep -n <span class="string">'\b\w+Exception\b'</span> access.log | tail</div></pre></td></tr></table></figure>
<p>附正则表达式表：</p>
<table>
<thead>
<tr>
<th style="text-align:left">元字符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">^</td>
<td style="text-align:left">匹配搜索字符串开始的位置。如“^abc”用于匹配以“abc”字符串开头的行。<br>如果用于中括号里面的第一个字符，则表示对字符集求反，如“[^abc]”用于匹配<br>除了以“a”或“b”或“c”以外的其它字符开头的行。</td>
</tr>
<tr>
<td style="text-align:left">$</td>
<td style="text-align:left">匹配搜索字符串结尾的位置。如“abc$”用于匹配以“abc”字符串结尾的行。</td>
</tr>
<tr>
<td style="text-align:left">.</td>
<td style="text-align:left">匹配除换行符“\n”之外的任何单个字符。如“a.c”可以匹配“abc”或“a2c”等。</td>
</tr>
<tr>
<td style="text-align:left">?</td>
<td style="text-align:left">匹配零次或一次前面的字符或子表达式，等效于“{0,1}”。如“ab?c”可以匹配“abc”和“ac”。</td>
</tr>
<tr>
<td style="text-align:left">*</td>
<td style="text-align:left">匹配零次或多次前面的字符或子表达式，等效于“{0,}”。如“ab*c”可以匹配“abc”和“ac”和“abbc”等。</td>
</tr>
<tr>
<td style="text-align:left">+</td>
<td style="text-align:left">匹配一次或多次前面的字符或子表达式，等效于“{1,}”。如“ab+c”可以匹配“abc”和“abbc”等。</td>
</tr>
<tr>
<td style="text-align:left">[]</td>
<td style="text-align:left">匹配中括号的开始和结尾。<br>如“[abc]”匹配“plain”中的“a”。<br>如“[a-z]”匹配26个小写英文字母。<br>如“[0-9]”匹配0到9的数字。</td>
</tr>
<tr>
<td style="text-align:left">{n}</td>
<td style="text-align:left">匹配前面的字符或子表达式正好n次。如“ab{2}c”匹配“abbc”。</td>
</tr>
<tr>
<td style="text-align:left">{n,}</td>
<td style="text-align:left">匹配前面的字符或子表达式至少n次。如“ab{2,}c”匹配“abbc”和“abbbc”等。</td>
</tr>
<tr>
<td style="text-align:left">{,m}</td>
<td style="text-align:left">匹配前面的字符或子表达式至多n次。如“ab{,2}c”匹配“ac”和“abc”和“abbc”。</td>
</tr>
<tr>
<td style="text-align:left">{n,m}</td>
<td style="text-align:left">匹配前面的字符或子表达式至少n次，至多m次。如“ab{2,3}c”匹配“abbc”和“abbbc”。</td>
</tr>
<tr>
<td style="text-align:left">\w</td>
<td style="text-align:left">匹配字母和数字，相当于“[0-9A-Za-z]”</td>
</tr>
<tr>
<td style="text-align:left">\W</td>
<td style="text-align:left">匹配非字母和数字，相当于“[^0-9A-Za-z]”</td>
</tr>
</tbody>
</table>
<p>示例：从标准输入中搜索出现<span style="font-family:sans-serif">“java”</span>字符的地方：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ps -ef | grep java</div><div class="line">root  1807  1  0  Nov11 ?  00:01:38 /usr/<span class="built_in">local</span>/jdk1.8.0_144/bin/java -Dcom.sun.akuma.Daemon=daemonized -Djava.awt.headless=<span class="literal">true</span> -DJENKINS_HOME=/var/lib/jenkins -jar /usr/lib/jenkins/jenkins.war --logfile=/var/<span class="built_in">log</span>/jenkins/jenkins.log --webroot=/var/cache/jenkins/war --daemon --httpPort=8080 --debug=5 --handlerCountMax=100 --handlerCountMaxIdle=20</div><div class="line">500   4621  4164  0  00:23 pts/2  00:00:00 grep java</div></pre></td></tr></table></figure>
<p><code>ps</code>是用来查看进程信息，后续会讲到。看回上面输出的最后一行，通常情况下，它不是我们想要的，我们可以使用<code>-v</code>（--invert-match，反转匹配。即除了匹配外的其他所有行）参数将它过滤掉：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ps -ef | grep java | grep -v grep</div><div class="line">root  1807  1  0  Nov11 ?  00:01:38 /usr/<span class="built_in">local</span>/jdk1.8.0_144/bin/java -Dcom.sun.akuma.Daemon=daemonized -Djava.awt.headless=<span class="literal">true</span> -DJENKINS_HOME=/var/lib/jenkins -jar /usr/lib/jenkins/jenkins.war --logfile=/var/<span class="built_in">log</span>/jenkins/jenkins.log --webroot=/var/cache/jenkins/war --daemon --httpPort=8080 --debug=5 --handlerCountMax=100 --handlerCountMaxIdle=20</div></pre></td></tr></table></figure>
<p>示例：递归搜索目录下的所有文件中出现<span style="font-family:sans-serif">“Exception”</span>的地方，并打印行号高亮显示：</p>
<p>参数：-R, -r, --recursive</p>
<p>释义：从给定的目录开始递归所有的子目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ egrep -rn --color <span class="string">'\b\w+Exception\b'</span></div></pre></td></tr></table></figure>
<h2 id="11-文件搜索"><a href="#11-文件搜索" class="headerlink" title="11. 文件搜索"></a>11. 文件搜索</h2><p>文件搜索的能力也很重要。它能帮助你快速的找到你想要的文件。常用的是通过<code>find</code>命令完成的。</p>
<p>示例：查找目录下的某个文件：</p>
<p>参数：-name</p>
<p>释义：根据文件的名称搜索</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ find . -name <span class="string">'logging.properties'</span></div><div class="line">./conf/logging.properties</div></pre></td></tr></table></figure>
<p>示例：使用通配符查找目录下的所有的.properties文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -name <span class="string">'*.properties'</span></div></pre></td></tr></table></figure>
<p>示例：查看目录下的所有的子目录：</p>
<p>参数：-type</p>
<p>释义：根据文件的类型搜索，常用的d（directory，目录）、f（regular file，文件）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -<span class="built_in">type</span> d</div></pre></td></tr></table></figure>
<p>示例：查看目录下的所有的文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -<span class="built_in">type</span> f</div></pre></td></tr></table></figure>
<p>示例：查找3分钟之内有流量进来的日志文件：</p>
<p>参数：-mmin（最后一次修改文件的时间）</p>
<p>释义：最近一次文件内容被修改的时间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -name <span class="string">'*.log'</span> -mmin -3</div></pre></td></tr></table></figure>
<p>示例：高级用法，执行一个命令。</p>
<p>参数：-exec command {} \;</p>
<p>释义：执行一个任意的command命令。</p>
<p>备注：<code>{}</code>是一个与<code>-exec</code>搭配使用的特殊符，它会被替换为<code>find</code>命令匹配到的每个文件的文件名称。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ find . -<span class="built_in">type</span> f -name <span class="string">'*.log'</span> -<span class="built_in">exec</span> cat &#123;&#125; \; &gt; demo.txt</div></pre></td></tr></table></figure>
<p>达到的效果就是，将当前所有的log文件的内容拼接成一个数据流重定向到demo.txt文件中。</p>
<h2 id="12-进程信息"><a href="#12-进程信息" class="headerlink" title="12. 进程信息"></a>12. 进程信息</h2><p>当前系统运行的所有进程信息都可以用<code>ps</code>命令来查看，搭配<code>kill</code>命令可以随时杀死某个进程。</p>
<p>示例：查看当前系统所有的进程信息，常用的组合参数是<code>-ef</code>或<code>aux</code>（注意参数前面没有<code>-</code>）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ps -ef</div><div class="line">UID   PID    PPID  C   STIME   TTY     TIME        CMD</div><div class="line">500   2878   1     0   12:37   pts/0   00:00:24    /usr/<span class="built_in">local</span>/jdk1.8.0_144/bin/java -Djava.util.logging.config.file=/home/fanlychie/applications/apache-tomcat-8.0.45/conf/logging.properties</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">字段</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">UID</td>
<td style="text-align:left">进程所属的用户ID</td>
</tr>
<tr>
<td style="text-align:center">PID</td>
<td style="text-align:left">进程ID</td>
</tr>
<tr>
<td style="text-align:center">PPID</td>
<td style="text-align:left">进程的父ID</td>
</tr>
<tr>
<td style="text-align:center">C</td>
<td style="text-align:left">CPU 使用比率</td>
</tr>
<tr>
<td style="text-align:center">STIME</td>
<td style="text-align:left">进程的启动时间</td>
</tr>
<tr>
<td style="text-align:center">TTY</td>
<td style="text-align:left">开始此进程的终端设备。<span style="font-family:sans-serif">“?”</span>表示是系统启动的与终端无关。<span style="font-family:sans-serif">“tty1”</span>至<span style="font-family:sans-serif">“tty6”</span>表示是本机上登录者程序。<span style="font-family:sans-serif">“pts/0”</span>等，则表示为由网络连接进主机的程序。</td>
</tr>
<tr>
<td style="text-align:center">TIME</td>
<td style="text-align:left">进程使用的 CPU 总时间</td>
</tr>
<tr>
<td style="text-align:center">CMD</td>
<td style="text-align:left">启动进程的命令和参数</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ps aux</div><div class="line">USER  PID    %CPU  %MEM   VSZ      RSS    TTY     STAT   START  TIME  COMMAND</div><div class="line">500   2878   0.1   18.3   2161124  89300  pts/0   Sl     12:37  0:27  /usr/<span class="built_in">local</span>/jdk1.8.0_144/bin/java -Dcom.sun.akuma.Daemon=daemonized -Djava.awt.headless=<span class="literal">true</span> -DJENKINS_HOME=/var/lib/jenkins</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">字段</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">USER</td>
<td style="text-align:left">进程的拥有者</td>
</tr>
<tr>
<td style="text-align:center">PID</td>
<td style="text-align:left">进程ID</td>
</tr>
<tr>
<td style="text-align:center">%CPU</td>
<td style="text-align:left">进程占用的 CPU 百分比</td>
</tr>
<tr>
<td style="text-align:center">%MEM</td>
<td style="text-align:left">进程占用的内存的百分比</td>
</tr>
<tr>
<td style="text-align:center">VSZ</td>
<td style="text-align:left">进程使用的虚拟内存大小，单位：KB</td>
</tr>
<tr>
<td style="text-align:center">RSS</td>
<td style="text-align:left">进程占用的固定内存大小，单位：KB</td>
</tr>
<tr>
<td style="text-align:center">TTY</td>
<td style="text-align:left">开始此进程的终端设备。“?”表示是系统启动的与终端无关。<span style="font-family:sans-serif">“tty1”</span>至<span style="font-family:sans-serif">“tty6”</span>表示是本机上登入者程序。<span style="font-family:sans-serif">“pts/0”</span>等，则表示为由网络连接进主机的程序。</td>
</tr>
<tr>
<td style="text-align:center">STAT</td>
<td style="text-align:left">进程的状态。常见的状态有：<br>R：正在运行或可运行状态；<br>S：处于休眠状态，等待被唤醒；<br>Z：僵尸进程，程序已终止，进程无法正常退出；<br>T：已停止或处于被追踪状态；<br>D：不可中断，一般是在等待I/O；<br>&lt;：优先级高的进程；<br>N：优先级低的进程；<br>s ：进程领导者，在它之下有子进程；<br>l：多线程的；</td>
</tr>
<tr>
<td style="text-align:center">START</td>
<td style="text-align:left">进程的启动时间</td>
</tr>
<tr>
<td style="text-align:center">TIME</td>
<td style="text-align:left">进程使用的 CPU 总时间</td>
</tr>
<tr>
<td style="text-align:center">COMMAND</td>
<td style="text-align:left">启动进程的命令和参数</td>
</tr>
</tbody>
</table>
<p>小结：<code>ps</code>命令的参数项非常多，掌握常用的参数组合项即可。如果只是查看进程的PID或PPID信息可选用<code>ps -ef</code>；如果要查看进程的PID和占用系统的内存和CPU信息可选用<code>ps aux</code>。</p>
<div style="margin:0 0 -8px">&nbsp;</div>

<p>示例：使用<code>ps</code>命令列出的进程信息会比较多，可以通过管道结合<code>more</code>或<code>less</code>命令翻页查看：</p>
<p>提示：<code>less</code>命令可以通过键盘的PageUp键（↑）和PageDown键（↓）上下翻页，按q键退出。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps -ef | less</div></pre></td></tr></table></figure>
<p>示例：自定义显示的进程信息的字段，参数组合-eo：</p>
<p>释义：pid,pcpu,pmem,cmd是别名，分别对应PID,%CPU,%MEM,CMD。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ps -eo pid,pcpu,pmem,cmd</div><div class="line">PID    %CPU    %MEM    CMD</div><div class="line"> 1     0.0     0.1    /sbin/init</div><div class="line"> 2     0.0     0.0    [kthreadd]</div></pre></td></tr></table></figure>
<p>示例：查看所有的进程并按CPU降序排序：</p>
<p>参数：--sort</p>
<p>释义：排序字段</p>
<p>排序：-pcpu表示按%CPU降序，+pcpu表示按%CPU升序，由于+是默认的，因此可简写为pcpu</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps aux --sort -pcpu</div></pre></td></tr></table></figure>
<p>示例：自定义显示的进程信息的字段并按CPU降序排序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps -eo pid,pcpu,pmem,cmd --sort -pcpu</div></pre></td></tr></table></figure>
<p>示例：找出最耗CPU的10个进程信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps aux --sort -pcpu | head</div></pre></td></tr></table></figure>
<p>示例：查看所有的进程并按内存降序排序：</p>
<p>疑惑：像%CPU一样用别名来排序无效，这里借助管道通过sort命令来排序</p>
<p>参数：此为sort的参数，-r降序（若没有此参数，sort默认采用升序的顺序来排序），-n按数值来排序，-k列的索引（第一列的索引值为1，以此类推）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps aux | sort -nrk 4</div></pre></td></tr></table></figure>
<p>示例：自定义显示的进程信息的字段并按内存降序排序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps -eo pid,pcpu,pmem,cmd | sort -nrk 3</div></pre></td></tr></table></figure>
<p>示例：找出最耗内存的10个进程信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ps -eo pid,pcpu,pmem,cmd | sort -nrk 3 | head</div></pre></td></tr></table></figure>
<h2 id="12-杀死进程"><a href="#12-杀死进程" class="headerlink" title="12. 杀死进程"></a>12. 杀死进程</h2><p>通常情况下，残忍的杀死一个进程我们经常会使用<code>kill</code>命令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">kill</span> -9 2878</div></pre></td></tr></table></figure>
<p>该命令的中心思想是用来强行杀死PID为2878的进程。kill是用来终止进程的信号。-9是一个信号编号，表示强行杀死。除此之外，常见的信号编号还有：</p>
<table>
<thead>
<tr>
<th style="text-align:center">信号编号</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:left">当按下组合键“Ctrl + c”时会发出该信号</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:left">强行杀死</td>
</tr>
<tr>
<td style="text-align:center">15</td>
<td style="text-align:left">终止进程默认发送的信号</td>
</tr>
<tr>
<td style="text-align:center">20</td>
<td style="text-align:left">当按下组合键“Ctrl + z”时会发出该信号</td>
</tr>
</tbody>
</table>
<h2 id="13-top-命令"><a href="#13-top-命令" class="headerlink" title="13. top 命令"></a>13. top 命令</h2><p><code>top</code>命令可以实时的监控系统中各个进程的资源占用情况，经常用于服务器性能监控和分析。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ top</div></pre></td></tr></table></figure>
<p><code>top</code>列出的信息内容非常丰富（部分信息与ps相似，不再赘述），默认每隔3秒钟自动刷新一次：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/shell3.png" alt=""></p>
<p><code>top</code>命令在运行中的时候，可以通过一些按键来控制显示的信息结果，常用的有：</p>
<table>
<thead>
<tr>
<th style="text-align:center">信号编号</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Shift + p</td>
<td style="text-align:left">按%CPU排序结果</td>
</tr>
<tr>
<td style="text-align:center">Shift + m</td>
<td style="text-align:left">按%MEM排序结果</td>
</tr>
<tr>
<td style="text-align:center">Shift + n</td>
<td style="text-align:left">按PID排序结果</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:left">数字1，查看每个核的CPU使用情况</td>
</tr>
</tbody>
</table>
<p>首先来看前5行信息的内容：</p>
<ul>
<li>第一行，系统的统计信息：<ul>
<li><code>22:35:29 up 26 days, 13:33</code>表示系统连续运行的时间；</li>
<li><code>1 user</code>表示当前登录系统的用户数；</li>
<li><code>load average: 0.04, 0.03, 0.05</code>表示系统分别在1、5、15分钟内的平均负载；</li>
</ul>
</li>
<li>第二行，进程的统计信息：<ul>
<li><code>133 total</code>表示进程的总数；</li>
<li><code>1 running</code>表示正在运行的进程数；</li>
<li><code>132 sleeping</code>表示休眠的进程数；</li>
<li><code>0 stopped</code>表示停止的进程数；</li>
<li><code>0 zombie</code>表示僵尸进程数；</li>
</ul>
</li>
<li>第三行，CPU的统计信息：<ul>
<li><code>0.2 us</code>表示用户占用的CPU百分比；</li>
<li><code>0.2 sy</code>表示内核占用的CPU百分比；</li>
<li><code>99.6 id</code>表示空闲的CPU百分比；</li>
<li>其余不一一列举了…</li>
</ul>
</li>
<li>第四行，内存的统计信息：<ul>
<li><code>12139564 total</code>表示物理内存的总大小；</li>
<li><code>1866952 free</code>表示空闲可用的物理内存总大小；</li>
<li><code>6600492 used</code>表示已经使用的物理内存总大小；</li>
<li><code>3672120 buff/cache</code>表示缓冲内存的总大小；</li>
</ul>
</li>
<li>第五行，交换分区的统计信息：<ul>
<li><code>2097148 total</code>表示交换分区的总大小；</li>
<li><code>2062220 free</code>表示空闲可用的交换分区的大小；</li>
<li><code>34928 used</code>表示已经使用的交换分区的大小；</li>
</ul>
</li>
</ul>
<p>示例：单独跟踪某个进程的运行状态：</p>
<p>参数：-d</p>
<p>释义：每隔多少秒刷新一次</p>
<p>参数：-p</p>
<p>释义：进程的ID</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ top -d 1 -p 12515</div></pre></td></tr></table></figure>
<p>有时候，我们经常会看到CPU的使用率占比超过100%。你莫要惊慌，这是因为<code>top</code>是按照单个CPU核数来计算的。如果一台服务器的CPU核数为4核，那么，该服务器的CPU使用率占比最高可达到400%。</p>
<div style="margin:0 0 -8px">&nbsp;</div>

<p>内存是真内存！你看到剩余多少就是多少，没有更多了。如果系统剩余物理内存不是很足了，那就要引起注意了。Linux系统有一个OOM-killer（Out Of Memory killer）机制。当Linux内核检测到系统内存不足的时候，就会触发OOM-killer来挑选一个最耗内存的进程并杀掉这个进程以求释放一些内存出来。</p>
<div style="margin:0 0 -8px">&nbsp;</div>

<p>除了内存和CPU，top还有一个地方很直观的反应出当前系统的性能指标，那就是第一行的load average系统平均负载。0.00~1.00之间的数值表示系统状况良好。超过1.00表示系统已经超出负荷快要不堪重负了。而实际上，我们也经常会看到服务器平均负载超过1.00的情况。这也跟服务器的CPU核数有关。如果一台服务器的CPU核数为4核，那么，该服务器的平均负载能力可达到4.00。事实上，当系统平均负载达到70%左右时，你就应该有所行动，在事情变得更糟糕之前，去分析其造成的原因。分析的焦点应放在后两项的数值，因为第一项是1分钟内的平均负载，时间太短，一瞬间的高并发导致该值大幅度上涨是很有可能的。作为一个程序猿，对top的心得言尽于此。</p>
<h2 id="14-硬盘使用情况"><a href="#14-硬盘使用情况" class="headerlink" title="14. 硬盘使用情况"></a>14. 硬盘使用情况</h2><p>掌握如何去查看服务器的硬盘空间使用情况以及在硬盘空间捉襟见肘如何去查找大文件也很重要。特别是对于一些吃硬盘的应用，比如文件系统、索引检索应用等。</p>
<p>示例：查看服务器硬盘空间使用情况：</p>
<p>命令：df</p>
<p>释义：disk free，磁盘可用空间</p>
<p>参数：-h, --human-readable</p>
<p>释义：易读格式, 指的是数值后面的单位，如：M、G 等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ df -h</div><div class="line">Filesystem     Size    Used     Avail    Use%     Mounted on</div><div class="line">/dev/sda2      19G     3.1G     15G      18%      /</div><div class="line">tmpfs          238M    0        238M     0%       /dev/shm</div><div class="line">/dev/sda1      291M    34M      242M     13%      /boot</div></pre></td></tr></table></figure>
<p>一般只看第一行就行，其它涉及Linux文件系统方面的知识有兴趣可以自行谷歌百度，这里不作描述。Size是磁盘容量，Used是已用的空间，Avail是剩余可用的空间（重要），Use%是已用的空间的百分比。</p>
<p>示例：查看文件或目录占用的磁盘空间大小：</p>
<p>命令：du</p>
<p>释义：disk usage，磁盘使用</p>
<p>参数：-h, --human-readable</p>
<p>释义：易读格式, 指的是数值后面的单位，如：M、G 等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ du -h logs</div><div class="line">81M	logs/app</div><div class="line">149M	logs</div></pre></td></tr></table></figure>
<p>可以看出，logs目录总共占149M的磁盘空间。其中，logs/app目录共占81M，剩余的68M被logs根目录下的文件占用。如果想要查看各个文件占用的磁盘空间，可以追加使用-a, --all参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ du -ha logs</div><div class="line">332K	logs/demo1.log</div><div class="line">20K	logs/demo2.log</div><div class="line">68M	logs/demo3.log</div><div class="line">49M	logs/app/app-demo2.log</div><div class="line">33M	logs/app/app-demo1.log</div><div class="line">81M	logs/app</div><div class="line">149M	logs</div></pre></td></tr></table></figure>
<p>示例：找出目录下最大的10个文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> du -b &#123;&#125; \; | sort -nrk 1 | head</div><div class="line">70938260       ./demo3.log</div><div class="line">50838254       ./app/app-demo2.log</div><div class="line">33759270       ./app/app-demo1.log</div><div class="line">336939         ./demo1.log</div><div class="line">17510          ./demo2.log</div></pre></td></tr></table></figure>
<p>由于是要按数值大小排序，故这里不能使用-h参数，-b, --bytes是统计字节数，这样排序才准确。</p>
<p>查看目录的磁盘大小<br>du -sh *</p>
<h2 id="15-网络链接"><a href="#15-网络链接" class="headerlink" title="15. 网络链接"></a>15. 网络链接</h2><p>还在为系统链接不了网络而烦恼？还在为系统自动获取IP每次客户端链接终端都要修改IP地址而烦恼？</p>
<p>为你虚拟机的Linux操作系统设置静态IP！【工具：VMware；操作系统：CentOS6（CentOS7类似）】</p>
<p>在顶部菜单中选择编辑–&gt;虚拟网络编辑器</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/vmware_001.png" alt=""></p>
<div style="margin:0 0 -8px">&nbsp;</div>

<p>在 NAT 设置中查看网关IP：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/vmware_002.png" alt=""></p>
<div style="margin:0 0 -8px">&nbsp;</div>

<p>在 DHCP 设置中查看子网掩码、广播地址、子网IP段：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/vmware_003.png" alt=""></p>
<p>虚拟机Linux系统的网络适配器选择NAT模式。CentOS操作系统网卡的名称通常是以ifcfg-xxx的方式命名，你也可以使用ifconfig命令来查看系统的网卡名称。CentOS6的网卡名称通常是ifcfg-eth0。编辑网卡信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /etc/sysconfig/network-scripts/ifcfg-eth0</span></div></pre></td></tr></table></figure>
<p>CentOS6 配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">DEVICE="eth0"</span></div><div class="line"><span class="string">BOOTPROTO="static"</span></div><div class="line"><span class="string">HWADDR="00:0C:29:66:3F:AB"</span></div><div class="line"><span class="string">ONBOOT="yes"</span></div><div class="line"><span class="string">UUID="96bcd1e9-5921-4cf9-bc0e-7c4b9d80e215"</span></div><div class="line"><span class="string">IPADDR=192.168.139.129</span></div><div class="line"><span class="string">NETMASK=255.255.255.0</span></div><div class="line"><span class="string">GATEWAY=192.168.139.2</span></div><div class="line"><span class="string">DNS1=192.168.139.2</span></div></pre></td></tr></table></figure></p>
<p>CentOS7 配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">...</span> <span class="string">...</span></div><div class="line"><span class="string">BOOTPROTO="static"</span></div><div class="line"><span class="string">IPADDR0=192.168.139.129</span></div><div class="line"><span class="string">PREFIX0=24</span></div><div class="line"><span class="string">GATEWAY0=192.168.139.2</span></div><div class="line"><span class="string">DNS1=192.168.139.2</span></div><div class="line"><span class="string">DNS2=8.8.8.8</span></div></pre></td></tr></table></figure>
<p>网卡配置信息主要修改BOOTPROTO为static，以及添加后面几行的配置，DNS的值保持和网关一致。</p>
<p>重启网络服务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service network restart</span></div></pre></td></tr></table></figure>
<p>验证网络是否可用（如果能ping通，说明网络可用）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ping baidu.com</div></pre></td></tr></table></figure>
<h2 id="16-网络状态"><a href="#16-网络状态" class="headerlink" title="16. 网络状态"></a>16. 网络状态</h2><p>如果想查看系统的网络状态信息，可以使用<code>netstat</code>命令。</p>
<p>参数：–numeric , -n</p>
<p>释义：使用数字类型的IP地址显示</p>
<p>参数：-a, –all</p>
<p>释义：显示所有经过TCP建立链接的Socket</p>
<p>参数：-t, –tcp</p>
<p>释义：只显示TCP传输协议的连线</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ netstat -ant</div><div class="line">Proto     Recv-Q     Send-Q     Local Address           Foreign Address        State</div><div class="line">tcp6      0          0          :::20818                :::*                   LISTEN</div><div class="line">tcp6      0          0          :::20809                :::*                   LISTEN</div><div class="line">tcp6      0          0          10.10.10.171:20818      10.10.10.170:55648     ESTABLISHED</div><div class="line">tcp6      0          0          10.10.10.171:20818      10.10.10.170:34580     ESTABLISHED</div><div class="line">tcp6      0          0          10.10.10.171:20809      10.10.10.176:26379     ESTABLISHED</div></pre></td></tr></table></figure>
<p>这里主要来介绍后面的三列信息内容：</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Local Address</td>
<td style="text-align:left">本地地址和端口信息</td>
</tr>
<tr>
<td style="text-align:left">Foreign Address</td>
<td style="text-align:left">远程地址和端口信息</td>
</tr>
<tr>
<td style="text-align:left">State</td>
<td style="text-align:left">状态信息。常见的状态有：<br>LISTEN：本地监听的端口；<br>ESTABLISHED：远程访问本机服务的地址和端口信息；<br>TIME-WAIT：链接已挂断，socket在网络上等待结束；</td>
</tr>
</tbody>
</table>
<p>示例：统计某个端口的服务当前的链接数量：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ $ netstat -ant | grep <span class="string">":20818"</span> | wc -l</div><div class="line">21</div></pre></td></tr></table></figure>
<h2 id="5-数值运算"><a href="#5-数值运算" class="headerlink" title="5. 数值运算"></a>5. 数值运算</h2><p>高高兴兴的写脚本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">n1=1</div><div class="line">n2=2</div><div class="line">result=n1+n2</div><div class="line"><span class="built_in">echo</span> <span class="string">"n1 + n2 = <span class="variable">$result</span>"</span></div></pre></td></tr></table></figure>
<p>执行结果：<code>n1 + n2 = n1+n2</code>（一脸懵逼有没有o(╯□╰)o）</p>
<p>在shell中，给变量赋予数字类型的值最终也是以字符串的方式存储的，如果想要让它们变得像数字一样能够进行数值运算，可以采用以下的方法。</p>
<h3 id="5-1-let"><a href="#5-1-let" class="headerlink" title="5.1 let"></a>5.1 let</h3><p>使用<code>let</code>作数值运算时，变量名前不需要加<code>$</code>符号，适用于整数运算：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">let</span> result=n1+n2</div><div class="line"><span class="built_in">let</span> result++</div><div class="line"><span class="built_in">let</span> result--</div><div class="line"><span class="built_in">let</span> result+=1</div><div class="line"><span class="built_in">let</span> result-=1</div></pre></td></tr></table></figure>
<h3 id="5-2"><a href="#5-2" class="headerlink" title="5.2 $[ ]"></a>5.2 $[ ]</h3><p>使用<code>$[ ]</code>作数值运算时，变量名前不需要加<code>$</code>符号，<code>[]</code>里面可以有空格，适用于整数运算：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result=$[ n1 + n2 ]</div></pre></td></tr></table></figure>
<h3 id="5-3"><a href="#5-3" class="headerlink" title="5.3 $(( ))"></a>5.3 $(( ))</h3><p>使用<code>$(( ))</code>作数值运算时，变量名前不需要加<code>$</code>符号，<code>(())</code>里面可以有空格，适用于整数运算：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result=$(( n1 + n2 ))</div></pre></td></tr></table></figure>
<h3 id="5-4-expr"><a href="#5-4-expr" class="headerlink" title="5.4 expr"></a>5.4 expr</h3><p>使用<code>expr</code>作数值运算时，变量名前需要加<code>$</code>符号，适用于整数运算：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result=`expr <span class="variable">$n1</span> + <span class="variable">$n2</span>`</div></pre></td></tr></table></figure>
<h3 id="5-5-bc"><a href="#5-5-bc" class="headerlink" title="5.5 bc"></a>5.5 bc</h3><p>以上列举的方法都只适用于整数。如果要对小数进行运算，可以使用<code>bc</code>（数值运算的高级工具）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">n1=1.234</div><div class="line">n2=2</div><div class="line">result=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$n1</span> * <span class="variable">$n2</span>"</span> | bc`</div><div class="line"><span class="built_in">echo</span> <span class="string">"n1 * n2 = <span class="variable">$result</span>"</span></div></pre></td></tr></table></figure>
<p>除此之外，你还可以使用<code>scale</code>来指定需要保留的小数位数，中间用定界符分号来隔开：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result=`<span class="built_in">echo</span> <span class="string">"scale=2; <span class="variable">$n1</span> * <span class="variable">$n2</span> / 1"</span> | bc`</div></pre></td></tr></table></figure>
<p>注：<code>scale</code>只对除法、取余、乘幂有效，对乘法无效，所以上例除以了一个1来达到效果。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-cd-命令&quot;&gt;&lt;a href=&quot;#1-cd-命令&quot; class=&quot;headerlink&quot; title=&quot;1. cd 命令&quot;&gt;&lt;/a&gt;1. cd 命令&lt;/h3&gt;&lt;table class=&quot;cmtbl&quot;&gt;&lt;tr&gt;&lt;td style=&quot;border-right:1px solid #e2dfdf!important;width:5.2%&quot;&gt;&lt;img src=&quot;../img/info.png&quot; style=&quot;width:18px&quot;&gt;&lt;/td&gt;&lt;td style=&quot;padding-left:18px;width:94.8%;&quot;&gt;change directory（更改目录）。&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;table class=&quot;cmtbl&quot;&gt;&lt;tr&gt;&lt;td style=&quot;border-right:1px solid #e2dfdf!important;width:5.2%&quot;&gt;&lt;img src=&quot;../img/info.png&quot; style=&quot;width:18px&quot;&gt;&lt;/td&gt;&lt;td style=&quot;padding-left:18px;width:94.8%;&quot;&gt;用于切换工作目录。是最基本的 Linux 操作系统命令。&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;1) 使用&lt;code&gt;cd&lt;/code&gt;不带任何参数，可进入当前用户的主目录：&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host apache-tomcat-8.0.45]$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host ~]$&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2) 使用&lt;code&gt;cd ~&lt;/code&gt;也可进入当前用户的主目录：&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host apache-tomcat-8.0.45]$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; ~&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host ~]$&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3) 使用&lt;code&gt;cd ..&lt;/code&gt;返回上级目录（&lt;code&gt;..&lt;/code&gt;用于表示上级目录，如返回上两级目录则应为&lt;code&gt;cd ../..&lt;/code&gt;）：&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host webapps]$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; ..&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host apache-tomcat-8.0.45]$&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;4) 使用&lt;code&gt;cd -&lt;/code&gt;返回进入当前目录之前所在的目录：&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host apache-tomcat-8.0.45]$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; -&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/fanlychie/apache-tomcat-8.0.45/webapps&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[fanlychie@129host webapps]$&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="http://yoursite.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>FastDFS 客户端工具类</title>
    <link href="http://yoursite.com/post/fastdfs-client.html"/>
    <id>http://yoursite.com/post/fastdfs-client.html</id>
    <published>2017-09-24T04:33:54.000Z</published>
    <updated>2018-07-26T07:08:16.923Z</updated>
    
    <content type="html"><![CDATA[<p>依赖配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.bestwu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastdfs-client-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<p>FastDFS 配置：</p>
<p></p><p class="code-title"># fastdfs-client.properties</p><br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fastdfs.http_tracker_http_port=8080</div><div class="line">fastdfs.tracker_servers=10.10.10.121:22122,10.10.10.122:22122,10.10.10.123:22122</div></pre></td></tr></table></figure><p></p>
<p>FastDFS 客户端工具类：</p>
<p></p><p class="code-title"># FastDFSClient</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.csource.fastdfs.ClientGlobal;</div><div class="line"><span class="keyword">import</span> org.csource.fastdfs.StorageClient1;</div><div class="line"><span class="keyword">import</span> org.csource.fastdfs.StorageServer;</div><div class="line"><span class="keyword">import</span> org.csource.fastdfs.TrackerClient;</div><div class="line"><span class="keyword">import</span> org.csource.fastdfs.TrackerServer;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</div><div class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.FileInputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line">	</div><div class="line"><span class="comment">/**</span></div><div class="line"> * FastDFS 客户端工具</div><div class="line"> * Created by fanlychie on 2017/9/22.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FastDFSClient</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StorageClient1 storageClient;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 上传文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> file 文件对象</div><div class="line">     * <span class="doctag">@return</span> 上传如果成功, 则返回表示该文件的文件ID字符串; 否则抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadFile</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">        String name = file.getName();</div><div class="line">        <span class="keyword">int</span> index = name.lastIndexOf(<span class="string">"."</span>);</div><div class="line">        String extension = index == -<span class="number">1</span> ? <span class="keyword">null</span> : name.substring(index + <span class="number">1</span>);</div><div class="line">        <span class="keyword">byte</span>[] sources;</div><div class="line">        InputStream inputStream = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            inputStream = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">            sources = <span class="keyword">new</span> <span class="keyword">byte</span>[inputStream.available()];</div><div class="line">            inputStream.read(sources);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> storage(sources, extension);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 存储任意源到文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> sources 源</div><div class="line">     * <span class="doctag">@return</span> 存储如果成功, 则返回表示该文件的文件ID字符串; 否则抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">storage</span><span class="params">(<span class="keyword">byte</span>[] sources)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> storage(sources, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 存储任意源到文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> sources   源</div><div class="line">     * <span class="doctag">@param</span> extension 存储的文件扩展名</div><div class="line">     * <span class="doctag">@return</span> 存储如果成功, 则返回表示该文件的文件ID字符串; 否则抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">storage</span><span class="params">(<span class="keyword">byte</span>[] sources, String extension)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> storageClient.upload_file1(sources, extension, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 更新文件, 更新时, 先上传新的文件, 若上传成功, 则删除原文件; 若新文件上传失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId  原文件ID</div><div class="line">     * <span class="doctag">@param</span> newFile 新的文件对象</div><div class="line">     * <span class="doctag">@return</span> 先上传新的文件, 若上传成功, 则删除原文件, 并返回新的文件ID; 若新文件上传失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">updateFile</span><span class="params">(String fileId, File newFile)</span> </span>&#123;</div><div class="line">        String newFileId = uploadFile(newFile);</div><div class="line">        delete(fileId);</div><div class="line">        <span class="keyword">return</span> newFileId;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 更新源, 更新时, 先存储新的源内容, 若存储成功, 则删除原文件; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId     原文件ID</div><div class="line">     * <span class="doctag">@param</span> newSources 新的源内容</div><div class="line">     * <span class="doctag">@return</span> 先存储新的源内容, 若存储成功, 则删除原文件, 并返回新的文件ID; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">modify</span><span class="params">(String fileId, <span class="keyword">byte</span>[] newSources)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> modify(fileId, newSources, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 更新源, 更新时, 先存储新的源内容, 若存储成功, 则删除原文件; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId     原文件ID</div><div class="line">     * <span class="doctag">@param</span> newSources 新的源内容</div><div class="line">     * <span class="doctag">@param</span> extension 存储的文件扩展名</div><div class="line">     * <span class="doctag">@return</span> 先存储新的源内容, 若存储成功, 则删除原文件, 并返回新的文件ID; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">modify</span><span class="params">(String fileId, <span class="keyword">byte</span>[] newSources, String extension)</span> </span>&#123;</div><div class="line">        String newFileId = storage(newSources, extension);</div><div class="line">        delete(fileId);</div><div class="line">        <span class="keyword">return</span> newFileId;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 删除文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId 文件ID</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(String fileId)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            storageClient.delete_file1(fileId);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下载文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId       文件ID</div><div class="line">     * <span class="doctag">@param</span> outputStream 输出流对象</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">downloadFile</span><span class="params">(String fileId, OutputStream outputStream)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] bytes;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            bytes = storageClient.download_file1(fileId);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">        InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        <span class="keyword">try</span> (BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(inputStream);</div><div class="line">             BufferedOutputStream bos = <span class="keyword">new</span> BufferedOutputStream(outputStream)) &#123;</div><div class="line">            <span class="keyword">int</span> read;</div><div class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span> * <span class="number">1024</span>];</div><div class="line">            <span class="keyword">while</span> ((read = bis.read(buffer)) != -<span class="number">1</span>) &#123;</div><div class="line">                bos.write(buffer, <span class="number">0</span>, read);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">if</span> (!e.getClass().getSimpleName().equals(<span class="string">"ClientAbortException"</span>)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下载文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> response 客户端响应对象</div><div class="line">     * <span class="doctag">@param</span> fileId   文件ID</div><div class="line">     * <span class="doctag">@param</span> fileName 客户端下载框中显示的文件名称, 如果有扩展名, 该名称应含文件的扩展名</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">downloadFile</span><span class="params">(HttpServletResponse response, String fileId, String fileName)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            fileName = <span class="keyword">new</span> String(fileName.getBytes(<span class="string">"UTF-8"</span>), <span class="string">"ISO-8859-1"</span>);</div><div class="line">            response.setContentType(<span class="string">"application/octet-stream; charset=iso-8859-1"</span>);</div><div class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment; filename="</span> + fileName);</div><div class="line">            downloadFile(fileId, response.getOutputStream());</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 初始化 FastDFS</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ClientGlobal.initByProperties(<span class="string">"fastdfs-client.properties"</span>);</div><div class="line">            TrackerClient trackerClient = <span class="keyword">new</span> TrackerClient(ClientGlobal.getG_tracker_group());</div><div class="line">            TrackerServer trackerServer = trackerClient.getConnection();</div><div class="line">            <span class="keyword">if</span> (trackerServer == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FastDFSClientException(<span class="string">"连接 FastDFS 服务失败"</span>);</div><div class="line">            &#125;</div><div class="line">            StorageServer storageServer = trackerClient.getStoreStorage(trackerServer);</div><div class="line">            <span class="keyword">if</span> (storageServer == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FastDFSClientException(<span class="string">"获取 FastDFS 存储对象失败"</span>);</div><div class="line">            &#125;</div><div class="line">            storageClient = <span class="keyword">new</span> StorageClient1(trackerServer, storageServer);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 第一次加载时执行初始化工作</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> &#123; init(); &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 异常包装器, 将非运行时异常包装成运行时异常并在运行时抛出</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionWrapper</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</div><div class="line">		</div><div class="line">        <span class="keyword">private</span> Throwable cause;</div><div class="line">		</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ExceptionWrapper</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.cause = throwable;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Throwable <span class="title">getCause</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> cause;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * FastDFS 客户端异常</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FastDFSClientException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</div><div class="line">		</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FastDFSClientException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(message);</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p>单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.FileOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line">	</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastDFSClientTest</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试文件上传</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUploadFile</span><span class="params">()</span> </span>&#123;</div><div class="line">        File file = <span class="keyword">new</span> File(<span class="string">"src/test/resources/demo.txt"</span>);</div><div class="line">        String fileID = FastDFSClient.uploadFile(file);</div><div class="line">        System.out.println(fileID);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试内容存储</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStorage</span><span class="params">()</span> </span>&#123;</div><div class="line">        String fileID = FastDFSClient.storage(<span class="string">"Hello World!!!"</span>.getBytes());</div><div class="line">        System.out.println(fileID);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试内容修改更新, 文件更新使用 updateFile</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testModify</span><span class="params">()</span> </span>&#123;</div><div class="line">        String fileID = FastDFSClient.modify(<span class="string">"group1/M00/00/00/wKiLgVnHDwOAdxolAAAADtiRrk0132.txt"</span>, <span class="string">"Hello FastDFS!!!"</span>.getBytes());</div><div class="line">        System.out.println(fileID);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试文件下载</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDownloadFile</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        OutputStream os = <span class="keyword">new</span> FileOutputStream(<span class="string">"src/test/resources/demo-download.txt"</span>);</div><div class="line">        FastDFSClient.downloadFile(<span class="string">"group1/M00/00/00/CgoKe1tYT4yAQqpZAAAAlLyiB3s056.txt"</span>, os);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;依赖配置：&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependencies&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;cn.bestwu&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;fastdfs-client-java&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;1.27&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;javax.servlet&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;servlet-api&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;2.5&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;provided&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;junit&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;junit&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;4.12&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;test&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependencies&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="FastDFS" scheme="http://yoursite.com/tags/FastDFS/"/>
    
  </entry>
  
  <entry>
    <title>FastDFS集群搭建</title>
    <link href="http://yoursite.com/post/fastdfs-cluster-setup.html"/>
    <id>http://yoursite.com/post/fastdfs-cluster-setup.html</id>
    <published>2017-09-23T04:33:54.000Z</published>
    <updated>2018-08-05T15:36:11.004Z</updated>
    
    <content type="html"><![CDATA[<p>FastDFS有两个重要的角色：跟踪服务器（tracker）和存储服务器（storage）。</p>
<a id="more"></a>
<h3 id="1-存储服务器（storage-server）"><a href="#1-存储服务器（storage-server）" class="headerlink" title="1. 存储服务器（storage server）"></a>1. 存储服务器（storage server）</h3><p>FastDFS中的storage是采用分组（group）的方式来存储文件。</p>
<p>一个group中可以由一个或多个storage server组成，同一个group中的storage server是互备关系，即同一个group中的每个storage server相互进行文件同步（由专门的线程来完成），最终达到每个storage server中存储的文件是完全一致的。</p>
<p>一个storage集群是由一个或多个group组成。storage集群的存储总容量是集群中所有的group的存储总容量之和。由于同一个group中的storage server是互备关系，因此每个group的存储总容量是该group中存储容量最小的storage server的存储容量。因此，同一个group中的storage server的硬件配置应尽量保持一致，以免造成浪费。</p>
<p>storage server提供了文件上传、文件删除、文件访问（下载）等基础的功能。文件访问（下载）可以通过使用nginx扩展模块来完成（即每个storage server中都需要安装一个nginx应用）。</p>
<h3 id="2-跟踪服务器（tracker-server）"><a href="#2-跟踪服务器（tracker-server）" class="headerlink" title="2. 跟踪服务器（tracker server）"></a>2. 跟踪服务器（tracker server）</h3><p>FastDFS中的tracker主要的作用是负载均衡和调度。tracker server可以有多个，tracker server之间是对等的关系，没有主从之分。当客户端连接tracker server时，如果tracker server有多个，客户端会任意选择其中的一个来连接。storage server会周期性定时的向集群中的所有tracker server报告其分组和状态等信息（storage server会通过启动一个单独的线程来完成）。</p>
<h3 id="3-客户端（client）"><a href="#3-客户端（client）" class="headerlink" title="3. 客户端（client）"></a>3. 客户端（client）</h3><p>以文件上传为例，client、tracker server、storage server的时序图如下（图片摘自网络）：</p>
<p><img src="../img/fastdfs_upload_file.png"></p>
<h3 id="4-部署概况"><a href="#4-部署概况" class="headerlink" title="4. 部署概况"></a>4. 部署概况</h3><table>
<thead>
<tr>
<th style="text-align:center">角色</th>
<th style="text-align:center">IP</th>
<th style="text-align:center">端口</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">tracker</td>
<td style="text-align:center">10.10.10.121</td>
<td style="text-align:center">22122</td>
</tr>
<tr>
<td style="text-align:center">tracker</td>
<td style="text-align:center">10.10.10.122</td>
<td style="text-align:center">22122</td>
</tr>
<tr>
<td style="text-align:center">tracker</td>
<td style="text-align:center">10.10.10.123</td>
<td style="text-align:center">22122</td>
</tr>
<tr>
<td style="text-align:center">storage</td>
<td style="text-align:center">10.10.10.121</td>
<td style="text-align:center">22122</td>
</tr>
<tr>
<td style="text-align:center">storage</td>
<td style="text-align:center">10.10.10.122</td>
<td style="text-align:center">22122</td>
</tr>
<tr>
<td style="text-align:center">storage</td>
<td style="text-align:center">10.10.10.123</td>
<td style="text-align:center">22122</td>
</tr>
</tbody>
</table>
<h3 id="5-安装清单"><a href="#5-安装清单" class="headerlink" title="5. 安装清单"></a>5. 安装清单</h3><ul>
<li>FastDFS<ul>
<li><a href="https://codeload.github.com/happyfish100/fastdfs/tar.gz/V5.10" target="_blank" rel="external">fastdfs-5.10.tar.gz</a></li>
<li><a href="https://codeload.github.com/happyfish100/libfastcommon/tar.gz/V1.0.36" target="_blank" rel="external">libfastcommon-1.0.36.tar.gz</a></li>
<li><a href="https://ncu.dl.sourceforge.net/project/fastdfs/FastDFS%20Nginx%20Module%20Source%20Code/fastdfs-nginx-module_v1.16.tar.gz" target="_blank" rel="external">fastdfs-nginx-module_v1.16.tar.gz</a></li>
</ul>
</li>
<li>Nginx<ul>
<li><a href="http://nginx.org/download/nginx-1.12.1.tar.gz" target="_blank" rel="external">nginx-1.12.1.tar.gz</a></li>
<li><a href="https://www.openssl.org/source/openssl-1.0.2l.tar.gz" target="_blank" rel="external">openssl-1.0.2l.tar.gz</a></li>
<li><a href="http://ncu.dl.sourceforge.net/project/pcre/pcre/8.36/pcre-8.36.tar.gz" target="_blank" rel="external">pcre-8.36.tar.gz</a></li>
<li><a href="http://zlib.net/zlib-1.2.11.tar.gz" target="_blank" rel="external">zlib-1.2.11.tar.gz</a></li>
</ul>
</li>
</ul>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>注：FastDFS的基础详细安装可参考「<a href="https://fanlychie.github.io/post/fastdfs-setup.html" target="_blank" rel="external">FastDFS分布式文件系统搭建</a>」。</p></td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>注：本文示例每台虚拟机都分别安装一个<code>tracker</code>和一个<code>storage</code>。<code>10.10.10.121</code><code>10.10.10.122</code><code>10.10.10.123</code>三台机器安装和配置均相同，按以下步骤进行。</p></td></tr></table>

<h4 id="5-1-libfastcommon-安装"><a href="#5-1-libfastcommon-安装" class="headerlink" title="5.1 libfastcommon 安装"></a>5.1 libfastcommon 安装</h4><p>解压缩并进入解压缩后的文件夹的根目录：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tar zxvf libfastcommon-1.0.36.tar.gz &amp;&amp; cd libfastcommon-1.0.36</span></div></pre></td></tr></table></figure></p>
<p>执行编译安装：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure></p>
<h4 id="5-2-fastdfs-安装"><a href="#5-2-fastdfs-安装" class="headerlink" title="5.2 fastdfs 安装"></a>5.2 fastdfs 安装</h4><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tar zxvf fastdfs-5.10.tar.gz &amp;&amp; cd fastdfs-5.10</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>安装完成之后，在系统的<code>/etc</code>路径下会自动生成一个<code>/fdfs</code>目录，该目录下是<code>FastDFS</code>相关的一些示例配置文件。</p></td></tr></table>

<p>将当前路径下 conf 目录里面的 anti-steal.jpg，http.conf，mime.types 复制到 /etc/fdfs 目录中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cp conf/anti-steal.jpg conf/http.conf conf/mime.types /etc/fdfs/</span></div></pre></td></tr></table></figure>
<h5 id="5-2-1-tracker-配置"><a href="#5-2-1-tracker-配置" class="headerlink" title="5.2.1 tracker 配置"></a>5.2.1 tracker 配置</h5><p>将<code>/etc/fdfs/tracker.conf.sample</code>重命名为<code>/etc/fdfs/tracker.conf</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mv /etc/fdfs/tracker.conf.sample /etc/fdfs/tracker.conf</span></div></pre></td></tr></table></figure>
<p>编辑 tracker 配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /etc/fdfs/tracker.conf</span></div></pre></td></tr></table></figure>
<p>主要配置及说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"># 端口</div><div class="line">port=22122</div><div class="line">#</div><div class="line"># 连接超时时间，单位秒，默认是30</div><div class="line">connect_timeout=30</div><div class="line">#</div><div class="line"># 网络超时时间，单位秒，默认是60</div><div class="line">network_timeout=60</div><div class="line">#</div><div class="line"># 数据文件和日志文件存储的基路径</div><div class="line">base_path=/home/fanlychie/fastdfs</div><div class="line">#</div><div class="line"># 最大并发连接数</div><div class="line">max_connections=256</div><div class="line">#</div><div class="line"># 上传文件时，选group的策略</div><div class="line"># 0：轮询group</div><div class="line"># 1：使用特定的group</div><div class="line"># 2：选择可用空间最大的group</div><div class="line">store_lookup=2</div><div class="line">#</div><div class="line"># 指定文件上传到哪个group。当store_lookup设置为1时，必须指定这个group的名称。当store_lookup是其它值时该属性可以不设值</div><div class="line">store_group=group1</div><div class="line">#</div><div class="line"># 上传文件时，选storage server的策略</div><div class="line"># 0：轮询</div><div class="line"># 1：根据配置的IP的顺序</div><div class="line"># 2：根据配置的优先级</div><div class="line">store_server=0</div><div class="line">#</div><div class="line"># 上传文件时，选存储介质（磁盘或挂载点）的策略</div><div class="line"># 0：轮询</div><div class="line"># 1：优先使用最大可用空间的路径</div><div class="line">store_path=0</div><div class="line">#</div><div class="line"># 下载文件时，选storage server的策略</div><div class="line"># 0：轮询</div><div class="line"># 1：当前文件上传的源storage server</div><div class="line">download_server=0</div><div class="line">#</div><div class="line"># 系统保留的存储空间</div><div class="line">reserved_storage_space = 1%</div><div class="line">#</div><div class="line"># HTTP端口</div><div class="line">http.server_port=8080</div></pre></td></tr></table></figure>
<h5 id="5-2-2-storage-配置"><a href="#5-2-2-storage-配置" class="headerlink" title="5.2.2 storage 配置"></a>5.2.2 storage 配置</h5><p>将<code>/etc/fdfs/storage.conf.sample</code>重命名为<code>/etc/fdfs/storage.conf</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mv /etc/fdfs/storage.conf.sample /etc/fdfs/storage.conf</span></div></pre></td></tr></table></figure>
<p>编辑 storage 配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /etc/fdfs/storage.conf</span></div></pre></td></tr></table></figure>
<p>主要配置及说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"># 所属group的名称</div><div class="line">group_name=group1</div><div class="line">#</div><div class="line"># 端口</div><div class="line">port=23000</div><div class="line">#</div><div class="line"># 连接超时时间，单位秒，默认是30</div><div class="line">connect_timeout=30</div><div class="line">#</div><div class="line"># 网络超时时间，单位秒，默认是60</div><div class="line">network_timeout=60</div><div class="line">#</div><div class="line"># 数据文件和日志文件存储的基路径</div><div class="line">base_path=/home/fanlychie/fastdfs/storage</div><div class="line">#</div><div class="line"># 最大并发连接数</div><div class="line">max_connections=256</div><div class="line">#</div><div class="line"># 文件存储的路径。可以配置多个</div><div class="line">store_path0=/home/fanlychie/fastdfs/storage</div><div class="line">#store_path1=/home/fanlychie/fastdfs/storage1</div><div class="line">#</div><div class="line"># tracker server的IP和端口。如果有多个则配置多行</div><div class="line">tracker_server=10.10.10.121:22122</div><div class="line">tracker_server=10.10.10.122:22122</div><div class="line">tracker_server=10.10.10.123:22122</div></pre></td></tr></table></figure>
<h5 id="5-2-3-client-配置"><a href="#5-2-3-client-配置" class="headerlink" title="5.2.3 client 配置"></a>5.2.3 client 配置</h5><p>将<code>/etc/fdfs/client.conf.sample</code>重命名为<code>/etc/fdfs/client.conf</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mv /etc/fdfs/client.conf.sample /etc/fdfs/client.conf</span></div></pre></td></tr></table></figure>
<p>编辑 client 配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /etc/fdfs/client.conf</span></div></pre></td></tr></table></figure>
<p>主要配置及说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 数据文件和日志文件存储的基路径</div><div class="line">base_path=/home/fanlychie/fastdfs</div><div class="line">#</div><div class="line"># tracker server的IP和端口。如果有多个则配置多行</div><div class="line">tracker_server=10.10.10.121:22122</div><div class="line">tracker_server=10.10.10.122:22122</div><div class="line">tracker_server=10.10.10.123:22122</div></pre></td></tr></table></figure>
<h4 id="5-3-fastdfs-nginx-module-安装"><a href="#5-3-fastdfs-nginx-module-安装" class="headerlink" title="5.3 fastdfs-nginx-module 安装"></a>5.3 fastdfs-nginx-module 安装</h4><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tar zxvf fastdfs-nginx-module_v1.16.tar.gz &amp;&amp; cd fastdfs-nginx-module</span></div></pre></td></tr></table></figure>
<p>编辑<code>src/mod_fastdfs.conf</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi src/mod_fastdfs.conf</span></div></pre></td></tr></table></figure>
<p>主要配置及说明：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># tracker server的IP和端口。如果有多个则配置多行</div><div class="line">tracker_server=10.10.10.121:22122</div><div class="line">tracker_server=10.10.10.122:22122</div><div class="line">tracker_server=10.10.10.123:22122</div><div class="line">#</div><div class="line"># 如果请求的url地址中包含了group_name（如“group1/M00/00/00/xxx”）则应设为true。</div><div class="line"># 如果请求的url地址中不包含group_name（如“/M00/00/00/xxx”）则应设为false。</div><div class="line">url_have_group_name = true</div><div class="line">#</div><div class="line"># 文件存储的路径。可以配置多个</div><div class="line"># 必须配置与本机storage.conf中配置的store_path0路径相同</div><div class="line">store_path0=/home/fanlychie/fastdfs/storage</div><div class="line">#store_path1=/home/fanlychie/fastdfs/storage1</div></pre></td></tr></table></figure>
<p>复制文件<code>src/mod_fastdfs.conf</code>到<code>/etc/fdfs/</code>目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cp src/mod_fastdfs.conf /etc/fdfs/</span></div></pre></td></tr></table></figure>
<p>编辑<code>src/config</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi src/config</span></div></pre></td></tr></table></figure>
<p>找到<code>CORE_INCS</code>的配置行，去掉路径中的<code>/local</code>，改为如下并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CORE_INCS="$CORE_INCS /usr/include/fastdfs /usr/include/fastcommon/"</div></pre></td></tr></table></figure>
<h4 id="5-4-nginx-安装"><a href="#5-4-nginx-安装" class="headerlink" title="5.4 nginx 安装"></a>5.4 nginx 安装</h4><p>由于<code>FastDFS</code>提供的HTTP服务较为简单，它无法提供负载均衡等高性能的服务。因此，<code>FastDFS</code>通常会结合<code>Nginx</code>来使用。安装<code>Nginx</code>所需的依赖有：</p>
<ul>
<li>nginx 的 gzip 模块（压缩）需要依赖 zlib 库</li>
<li>nginx 的 ssl 模块（支持 HTTPS）需要依赖 openssl 库</li>
<li>nginx 的 rewrite 模块（支持 URL 重写）需要依赖 pcre 库</li>
</ul>
<h5 id="5-4-1-pcre-安装"><a href="#5-4-1-pcre-安装" class="headerlink" title="5.4.1 pcre 安装"></a>5.4.1 pcre 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf pcre-8.36.tar.gz &amp;&amp; <span class="built_in">cd</span> pcre-8.36</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<p>创建软连接（64位系统）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/lib/libpcre.so.1 /lib64</span></div></pre></td></tr></table></figure>
<p>创建软连接（32位系统）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/lib/libpcre.so.1 /lib</span></div></pre></td></tr></table></figure>
<h5 id="5-4-2-zlib-安装"><a href="#5-4-2-zlib-安装" class="headerlink" title="5.4.2 zlib 安装"></a>5.4.2 zlib 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf zlib-1.2.11.tar.gz &amp;&amp; <span class="built_in">cd</span> zlib-1.2.11</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<h5 id="5-4-3-openssl-安装"><a href="#5-4-3-openssl-安装" class="headerlink" title="5.4.3 openssl 安装"></a>5.4.3 openssl 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf openssl-1.0.2l.tar.gz &amp;&amp; <span class="built_in">cd</span> openssl-1.0.2l</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./config &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<h5 id="5-4-4-nginx-安装"><a href="#5-4-4-nginx-安装" class="headerlink" title="5.4.4 nginx 安装"></a>5.4.4 nginx 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf nginx-1.12.1.tar.gz &amp;&amp; <span class="built_in">cd</span> nginx-1.12.1</span></div></pre></td></tr></table></figure>
<p>编译安装（<em>注意修改<code>--add-module</code>的路径</em>）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>–add-module</code>的路径需要改成你服务上上面配置好的<code>fastdfs-nginx-module</code>对应的路径。</p></td></tr></table>

<p>编辑 nginx 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span></div></pre></td></tr></table></figure>
<p>添加如下配置：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /group1/M00 &#123;</div><div class="line">    root /home/fanlychie/fastdfs/storage/data/;</div><div class="line">    ngx_fastdfs_module;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>root</code>指定到<code>storage</code>配置的<code>${base_path}/data/</code>目录下。</p></td></tr></table>

<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>ngx_fastdfs_module</code>是<code>FastDFS</code>模块名称，该名称固定不需要改变。</p></td></tr></table>

<h4 id="5-5-启动服务"><a href="#5-5-启动服务" class="headerlink" title="5.5 启动服务"></a>5.5 启动服务</h4><h5 id="5-5-1-tracker"><a href="#5-5-1-tracker" class="headerlink" title="5.5.1 tracker"></a>5.5.1 tracker</h5><p>启动命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_trackerd /etc/fdfs/tracker.conf start</span></div></pre></td></tr></table></figure>
<p>停止命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_trackerd /etc/fdfs/tracker.conf stop</span></div></pre></td></tr></table></figure>
<p>重启命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_trackerd /etc/fdfs/tracker.conf restart</span></div></pre></td></tr></table></figure>
<h5 id="5-5-2-storage"><a href="#5-5-2-storage" class="headerlink" title="5.5.2 storage"></a>5.5.2 storage</h5><p>启动命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_storaged /etc/fdfs/storage.conf start</span></div></pre></td></tr></table></figure>
<p>停止命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_storaged /etc/fdfs/storage.conf stop</span></div></pre></td></tr></table></figure>
<p>重启命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_storaged /etc/fdfs/storage.conf restart</span></div></pre></td></tr></table></figure>
<h5 id="5-5-3-nginx"><a href="#5-5-3-nginx" class="headerlink" title="5.5.3 nginx"></a>5.5.3 nginx</h5><p>启动命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx</span></div></pre></td></tr></table></figure>
<p>停止命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s stop</span></div></pre></td></tr></table></figure>
<p>重新加载命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>10.10.10.121</code><code>10.10.10.122</code><code>10.10.10.123</code>三台机器的tracker配置相同。</p></td></tr></table>

<h3 id="6-storage-配置"><a href="#6-storage-配置" class="headerlink" title="6. storage 配置"></a>6. storage 配置</h3><p>编辑tracker的配置文件：</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;FastDFS有两个重要的角色：跟踪服务器（tracker）和存储服务器（storage）。&lt;/p&gt;
    
    </summary>
    
    
      <category term="FastDFS" scheme="http://yoursite.com/tags/FastDFS/"/>
    
  </entry>
  
  <entry>
    <title>FastDFS分布式文件系统搭建</title>
    <link href="http://yoursite.com/post/fastdfs-setup.html"/>
    <id>http://yoursite.com/post/fastdfs-setup.html</id>
    <published>2017-09-22T14:39:04.000Z</published>
    <updated>2018-07-26T02:23:59.737Z</updated>
    
    <content type="html"><![CDATA[<p>FastDFS 是一个开源的轻量级分布式文件系统，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。适合以文件为载体的在线服务，如图片网站、视频网站等等。</p>
<a id="more"></a>
<h3 id="1-环境和软件安装包清单"><a href="#1-环境和软件安装包清单" class="headerlink" title="1. 环境和软件安装包清单"></a>1. 环境和软件安装包清单</h3><ul>
<li>Linux<ul>
<li>CentOS 7</li>
</ul>
</li>
<li>FastDFS<ul>
<li><a href="https://codeload.github.com/happyfish100/fastdfs/tar.gz/V5.10" target="_blank" rel="external">fastdfs-5.10.tar.gz</a></li>
<li><a href="https://codeload.github.com/happyfish100/libfastcommon/tar.gz/V1.0.36" target="_blank" rel="external">libfastcommon-1.0.36.tar.gz</a></li>
<li><a href="https://ncu.dl.sourceforge.net/project/fastdfs/FastDFS%20Nginx%20Module%20Source%20Code/fastdfs-nginx-module_v1.16.tar.gz" target="_blank" rel="external">fastdfs-nginx-module_v1.16.tar.gz</a></li>
</ul>
</li>
<li>Nginx<ul>
<li><a href="http://nginx.org/download/nginx-1.12.1.tar.gz" target="_blank" rel="external">nginx-1.12.1.tar.gz</a></li>
<li><a href="https://www.openssl.org/source/openssl-1.0.2l.tar.gz" target="_blank" rel="external">openssl-1.0.2l.tar.gz</a></li>
<li><a href="http://ncu.dl.sourceforge.net/project/pcre/pcre/8.36/pcre-8.36.tar.gz" target="_blank" rel="external">pcre-8.36.tar.gz</a></li>
<li><a href="http://zlib.net/zlib-1.2.11.tar.gz" target="_blank" rel="external">zlib-1.2.11.tar.gz</a></li>
</ul>
</li>
</ul>
<h3 id="2-FastDFS-安装"><a href="#2-FastDFS-安装" class="headerlink" title="2. FastDFS 安装"></a>2. FastDFS 安装</h3><p>FastDFS 服务端有两个重要的角色：跟踪器（tracker）和存储器（storage）。客户端通过 tracker 将文件存储在 storage 服务器。在访问量不大情况下，可将 tracker 和 storage 都部署在同一台服务器上，后期根据业务需要进行扩展。以下是安装所需的软件包：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ll</span></div><div class="line">total 10552</div><div class="line">-rw-r--r-- 1 gw gw   17510 Sep 20  2017 fastdfs-nginx-module_v1.16.tar.gz</div><div class="line">-rw-r--r-- 1 gw gw  344620 Sep 22  2017 FastDFS_v5.08.tar.gz</div><div class="line">-rw-r--r-- 1 gw gw  434873 Sep 20  2017 libfastcommon-1.0.36.tar.gz</div><div class="line">-rw-r--r-- 1 gw gw  981093 Sep 20  2017 nginx-1.12.1.tar.gz</div><div class="line">-rw-r--r-- 1 gw gw 5365054 Sep 20  2017 openssl-1.0.2l.tar.gz</div><div class="line">-rw-r--r-- 1 gw gw 2009464 Sep 20  2017 pcre-8.36.tar.gz</div><div class="line">-rw-r--r-- 1 gw gw  607698 Sep 20  2017 zlib-1.2.11.tar.gz</div></pre></td></tr></table></figure>
<h4 id="2-1-libfastcommon-安装"><a href="#2-1-libfastcommon-安装" class="headerlink" title="2.1 libfastcommon 安装"></a>2.1 libfastcommon 安装</h4><table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>libfastcommon</code>是从<code>FastDFS</code>和<code>FastDHT</code>中提取出来的公共C函数库，<code>FastDFS</code>依赖该模块，需要首先安装它。</p></td></tr></table>

<p>解压缩并进入解压缩后的文件夹的根目录：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf libfastcommon-1.0.36.tar.gz &amp;&amp; <span class="built_in">cd</span> libfastcommon-1.0.36</span></div></pre></td></tr></table></figure></p>
<p>执行编译安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure></p>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果报 <font color="#da5985" style="margin:-12px 0 6px 0;">gcc: command not found</font> 错误，说明系统缺少<code>gcc</code>编译环境。先安装<code>gcc</code>环境：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum install -y gcc gcc-c++</span></div></pre></td></tr></table></figure><br><br></span><p>重新编译安装：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./make.sh clean &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>安装完成后，返回到上一级目录（软件包所在的根目录）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd -</span></div></pre></td></tr></table></figure>
<h4 id="2-2-fastdfs-安装"><a href="#2-2-fastdfs-安装" class="headerlink" title="2.2 fastdfs 安装"></a>2.2 fastdfs 安装</h4><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf fastdfs-5.10.tar.gz &amp;&amp; <span class="built_in">cd</span> fastdfs-5.10</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>如果报 <font color="#da5985" style="margin:-12px 0 6px 0;">perl: command not found</font> 错误，说明系统缺少<code>perl</code>编译环境。先安装<code>perl</code>环境：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum install perl</span></div></pre></td></tr></table></figure><br><br></span><p>重新编译安装：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./make.sh clean &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>安装成功后，在系统<code>/etc</code>路径下会生成一个<code>/fdfs</code>目录，该目录下是<code>FastDFS</code>相关的一些示例配置文件内容。</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ll /etc/fdfs/</span></div><div class="line">total 24</div><div class="line">-rw-r--r-- 1 root root 1461 Jun  5 16:46 client.conf.sample</div><div class="line">-rw-r--r-- 1 root root 7927 Jun  5 16:46 storage.conf.sample</div><div class="line">-rw-r--r-- 1 root root  105 Jun  5 16:46 storage_ids.conf.sample</div><div class="line">-rw-r--r-- 1 root root 7200 Jun  5 16:46 tracker.conf.sample</div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>将当前路径下 conf 目录里面的 anti-steal.jpg，http.conf，mime.types 复制到 /etc/fdfs 目录中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cp conf/anti-steal.jpg conf/http.conf conf/mime.types /etc/fdfs/</span></div></pre></td></tr></table></figure>
<p>安装完成后，返回到上一级目录（软件包所在的根目录）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd -</span></div></pre></td></tr></table></figure>
<h5 id="2-2-1-tracker-配置"><a href="#2-2-1-tracker-配置" class="headerlink" title="2.2.1 tracker 配置"></a>2.2.1 tracker 配置</h5><p>将<code>/etc/fdfs/tracker.conf.sample</code>重命名为<code>/etc/fdfs/tracker.conf</code>并编辑它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mv /etc/fdfs/tracker.conf.sample /etc/fdfs/tracker.conf &amp;&amp; vi /etc/fdfs/tracker.conf</span></div></pre></td></tr></table></figure>
<p>找到<code>base_path</code>的配置行，将其修改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">base_path=/home/fanlychie/fastdfs</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>这里的<code>base_path</code>是<code>tracker</code>用于存储数据文件（其路径为：base_path/data）以及日志文件（其路径为：base_path/logs）的基路径。如果配置的目录尚未存在，需要先创建该路径：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p /home/fanlychie/fastdfs</span></div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>启动命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_trackerd /etc/fdfs/tracker.conf start</span></div></pre></td></tr></table></figure>
<p>停止命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_trackerd /etc/fdfs/tracker.conf stop</span></div></pre></td></tr></table></figure>
<p>重启命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_trackerd /etc/fdfs/tracker.conf restart</span></div></pre></td></tr></table></figure>
<h5 id="2-2-2-storage-配置"><a href="#2-2-2-storage-配置" class="headerlink" title="2.2.2 storage 配置"></a>2.2.2 storage 配置</h5><p>将<code>/etc/fdfs/storage.conf.sample</code>重命名为<code>/etc/fdfs/storage.conf</code>并编辑它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mv /etc/fdfs/storage.conf.sample /etc/fdfs/storage.conf &amp;&amp; vi /etc/fdfs/storage.conf</span></div></pre></td></tr></table></figure>
<p>找到<code>base_path</code>的配置行，将其修改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">base_path=/home/fanlychie/fastdfs/storage</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>这里的<code>base_path</code>是<code>storage</code>用于存储数据文件（其路径为：base_path/data）以及日志文件（其路径为：base_path/logs）的基路径。如果配置的目录尚未存在，需要先创建该路径：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p /home/fanlychie/fastdfs/storage</span></div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>找到<code>store_path0</code>的配置行，将其修改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">store_path0=/home/fanlychie/fastdfs/storage</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>store_path0</code>如果配置的路径不存在，则会使用<code>base_path</code>配置的路径。</p></td></tr></table>

<p>找到<code>tracker_server</code>的配置行，将其修改为<code>tracker</code>服务器的地址：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<p>启动命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_storaged /etc/fdfs/storage.conf start</span></div></pre></td></tr></table></figure>
<p>停止命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_storaged /etc/fdfs/storage.conf stop</span></div></pre></td></tr></table></figure>
<p>重启命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fdfs_storaged /etc/fdfs/storage.conf restart</span></div></pre></td></tr></table></figure>
<h5 id="2-2-3-client-配置"><a href="#2-2-3-client-配置" class="headerlink" title="2.2.3 client 配置"></a>2.2.3 client 配置</h5><p>将<code>/etc/fdfs/client.conf.sample</code>重命名为<code>/etc/fdfs/client.conf</code>并编辑它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mv /etc/fdfs/client.conf.sample /etc/fdfs/client.conf &amp;&amp; vi /etc/fdfs/client.conf</span></div></pre></td></tr></table></figure>
<p>找到<code>base_path</code>的配置行，将其修改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">base_path=/home/fanlychie/fastdfs</div></pre></td></tr></table></figure>
<table><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%;border:none"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;border:none"><p>这里的<code>base_path</code>是<code>storage</code>用于存储数据文件（其路径为：base_path/data）以及日志文件（其路径为：base_path/logs）的基路径。如果配置的目录尚未存在，需要先创建该路径：</p><span class="cfigure"> <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p /home/fanlychie/fastdfs</span></div></pre></td></tr></table></figure><br><br></span></td></tr></table>

<p>找到<code>tracker_server</code>的配置行，将其修改为<code>tracker</code>服务器的地址：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<h4 id="2-3-fastdfs-nginx-module-安装"><a href="#2-3-fastdfs-nginx-module-安装" class="headerlink" title="2.3 fastdfs-nginx-module 安装"></a>2.3 fastdfs-nginx-module 安装</h4><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf fastdfs-nginx-module_v1.16.tar.gz &amp;&amp; <span class="built_in">cd</span> fastdfs-nginx-module</span></div></pre></td></tr></table></figure>
<p>编辑<code>src/mod_fastdfs.conf</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi src/mod_fastdfs.conf</span></div></pre></td></tr></table></figure>
<p>找到<code>tracker_server</code>的配置行，将其修改为<code>tracker</code>服务器的地址：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<p>找到<code>url_have_group_name</code>的配置行，将其改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">url_have_group_name = true</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>如果请求的url地址中包含了<code>group_name</code>（如“group1/M00/00/00/xxx”）则应设为true。<br>如果请求的url地址中不包含<code>group_name</code>（如“/M00/00/00/xxx”）则应设为false。</p></td></tr></table>

<p>找到<code>store_path0</code>的配置行，将其改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">store_path0=/home/fanlychie/fastdfs/storage</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p>必须配置与本机<code>storage.conf</code>中配置的<code>store_path0</code>路径相同。</p></td></tr></table>

<p>复制文件<code>src/mod_fastdfs.conf</code>到<code>/etc/fdfs/</code>目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cp src/mod_fastdfs.conf /etc/fdfs/</span></div></pre></td></tr></table></figure>
<p>编辑<code>src/config</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi src/config</span></div></pre></td></tr></table></figure>
<p>找到<code>CORE_INCS</code>的配置行：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CORE_INCS="$CORE_INCS /usr/local/include/fastdfs /usr/local/include/fastcommon/"</div></pre></td></tr></table></figure>
<p>去掉路径中的<code>/local</code>，改为如下并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CORE_INCS="$CORE_INCS /usr/include/fastdfs /usr/include/fastcommon/"</div></pre></td></tr></table></figure>
<h4 id="2-4-nginx-安装"><a href="#2-4-nginx-安装" class="headerlink" title="2.4 nginx 安装"></a>2.4 nginx 安装</h4><p>由于<code>FastDFS</code>提供的HTTP服务较为简单，它无法提供负载均衡等高性能的服务。因此，<code>FastDFS</code>通常会结合<code>Nginx</code>来使用。安装<code>Nginx</code>所需的依赖有：</p>
<ul>
<li>nginx 的 gzip 模块（压缩）需要依赖 zlib 库</li>
<li>nginx 的 ssl 模块（支持 HTTPS）需要依赖 openssl 库</li>
<li>nginx 的 rewrite 模块（支持 URL 重写）需要依赖 pcre 库</li>
</ul>
<h5 id="2-5-1-pcre-安装"><a href="#2-5-1-pcre-安装" class="headerlink" title="2.5.1 pcre 安装"></a>2.5.1 pcre 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf pcre-8.36.tar.gz &amp;&amp; <span class="built_in">cd</span> pcre-8.36</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<p>创建软连接（64位系统）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/lib/libpcre.so.1 /lib64</span></div></pre></td></tr></table></figure>
<p>创建软连接（32位系统）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/lib/libpcre.so.1 /lib</span></div></pre></td></tr></table></figure>
<p>回到上一级目录（软件包所在的根目录）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd -</span></div></pre></td></tr></table></figure>
<h5 id="2-4-2-zlib-安装"><a href="#2-4-2-zlib-安装" class="headerlink" title="2.4.2 zlib 安装"></a>2.4.2 zlib 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf zlib-1.2.11.tar.gz &amp;&amp; <span class="built_in">cd</span> zlib-1.2.11</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<p>回到上一级目录（软件包所在的根目录）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd -</span></div></pre></td></tr></table></figure>
<h5 id="2-5-3-openssl-安装"><a href="#2-5-3-openssl-安装" class="headerlink" title="2.5.3 openssl 安装"></a>2.5.3 openssl 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf openssl-1.0.2l.tar.gz &amp;&amp; <span class="built_in">cd</span> openssl-1.0.2l</span></div></pre></td></tr></table></figure>
<p>执行编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./config &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<p>回到上一级目录（软件包所在的根目录）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd -</span></div></pre></td></tr></table></figure>
<h5 id="2-5-4-nginx-安装"><a href="#2-5-4-nginx-安装" class="headerlink" title="2.5.4 nginx 安装"></a>2.5.4 nginx 安装</h5><p>解压缩并进入解压缩后的文件夹的根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf nginx-1.12.1.tar.gz &amp;&amp; <span class="built_in">cd</span> nginx-1.12.1</span></div></pre></td></tr></table></figure>
<p>编译安装（<em>注意修改<code>--add-module</code>的路径</em>）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>–add-module</code>的路径需要改成你服务上上面配置好的<code>fastdfs-nginx-module</code>对应的路径。</p></td></tr></table>

<p>编辑 nginx 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span></div></pre></td></tr></table></figure>
<p>配置如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">user  root;</div><div class="line"> </div><div class="line">... ...</div><div class="line"> </div><div class="line">location /group1/M00 &#123;</div><div class="line">    root /home/fanlychie/fastdfs/storage/data/;</div><div class="line">    ngx_fastdfs_module;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<table class="cmtbl"><tr><td style="border-right:1px solid #e2dfdf!important;width:5.2%"><img src="../img/info.png" style="width:18px"></td><td style="padding-left:18px;width:94.8%;"><p><code>root</code>指定到<code>storage</code>配置的<code>${base_path}/data/</code>目录下。</p></td></tr></table>

<p>启动命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx</span></div></pre></td></tr></table></figure>
<p>停止命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s stop</span></div></pre></td></tr></table></figure>
<p>重新加载命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<h3 id="3-FastDFS-测试"><a href="#3-FastDFS-测试" class="headerlink" title="3. FastDFS 测试"></a>3. FastDFS 测试</h3><p>新建测试文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'Hello World!'</span> &gt; hello.txt</span></div></pre></td></tr></table></figure>
<p>测试上传：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> fdfs_test /etc/fdfs/client.conf upload hello.txt</span></div></pre></td></tr></table></figure>
<p>上传成功之后返回类似信息：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">example file url: http://192.168.1.102/group1/M00/00/00/CgoKgFsXN6qAWGyzAAAADT9THu8575.txt</div></pre></td></tr></table></figure>
<p>访问测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> curl http://192.168.1.102/group1/M00/00/00/CgoKgFsXN6qAWGyzAAAADT9THu8575.txt</span></div></pre></td></tr></table></figure>
<h3 id="4-开启服务端口"><a href="#4-开启服务端口" class="headerlink" title="4. 开启服务端口"></a>4. 开启服务端口</h3><p>对外开启 80、8080、22122、23000 端口。</p>
<p>CentOS7 firewall 防火墙配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --permanent --add-port=80/tcp</div><div class="line">firewall-cmd --permanent --add-port=8080/tcp</div><div class="line">firewall-cmd --permanent --add-port=22122/tcp</div><div class="line">firewall-cmd --permanent --add-port=23000/tcp</div></pre></td></tr></table></figure>
<p>重加载：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --reload</span></div></pre></td></tr></table></figure>
<p>CentOS6 iptables 防火墙配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /etc/sysconfig/iptables</span></div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</div><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT</div><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 22122 -j ACCEPT</div><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 23000 -j ACCEPT</div></pre></td></tr></table></figure>
<p>重加载：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service iptables restart</span></div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;FastDFS 是一个开源的轻量级分布式文件系统，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。适合以文件为载体的在线服务，如图片网站、视频网站等等。&lt;/p&gt;
    
    </summary>
    
    
      <category term="FastDFS" scheme="http://yoursite.com/tags/FastDFS/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins 定时任务</title>
    <link href="http://yoursite.com/post/jenkins-schedule.html"/>
    <id>http://yoursite.com/post/jenkins-schedule.html</id>
    <published>2017-08-20T10:24:11.000Z</published>
    <updated>2017-11-05T07:58:53.542Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-创建自由风格的软件项目"><a href="#1-创建自由风格的软件项目" class="headerlink" title="1. 创建自由风格的软件项目"></a>1. 创建自由风格的软件项目</h3><p>创建一个自由风格的软件项目，并找到<code>构建触发器</code>项，勾选<code>Build periodically</code>：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-schedule.png" alt=""></p>
<a id="more"></a>
<p>首次需要手工点一次任务构建，以后就会定时自动构建了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-创建自由风格的软件项目&quot;&gt;&lt;a href=&quot;#1-创建自由风格的软件项目&quot; class=&quot;headerlink&quot; title=&quot;1. 创建自由风格的软件项目&quot;&gt;&lt;/a&gt;1. 创建自由风格的软件项目&lt;/h3&gt;&lt;p&gt;创建一个自由风格的软件项目，并找到&lt;code&gt;构建触发器&lt;/code&gt;项，勾选&lt;code&gt;Build periodically&lt;/code&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-schedule.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins SSH 远程执行 Shell 脚本</title>
    <link href="http://yoursite.com/post/jenkins-remote-ssh.html"/>
    <id>http://yoursite.com/post/jenkins-remote-ssh.html</id>
    <published>2017-08-20T07:44:41.000Z</published>
    <updated>2017-11-05T07:34:42.951Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-安装插件"><a href="#1-安装插件" class="headerlink" title="1. 安装插件"></a>1. 安装插件</h3><p>系统管理 -&gt; 管理插件 -&gt; 可用插件，搜索：SSH Plugin</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-1.png" alt=""></p>
<a id="more"></a>
<h3 id="2-远程主机身份配置"><a href="#2-远程主机身份配置" class="headerlink" title="2. 远程主机身份配置"></a>2. 远程主机身份配置</h3><p>Credentials –&gt; global –&gt; Add Credentials</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-2.png" alt=""></p>
<h3 id="3-远程主机SSH配置"><a href="#3-远程主机SSH配置" class="headerlink" title="3. 远程主机SSH配置"></a>3. 远程主机SSH配置</h3><p>系统管理 –&gt; 系统设置，找到<code>SSH remote hosts</code>项，点击添加按钮：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-3.png" alt=""></p>
<h3 id="4-远程主机SSH免密登陆配置"><a href="#4-远程主机SSH免密登陆配置" class="headerlink" title="4. 远程主机SSH免密登陆配置"></a>4. 远程主机SSH免密登陆配置</h3><p>当前主机信息：</p>
<ul>
<li>IP：192.168.1.202</li>
<li>用户：root</li>
</ul>
<p>目标主机信息：</p>
<ul>
<li>IP：192.168.1.201</li>
<li>用户：fanlychie</li>
</ul>
<p>主机202以root用户身份免密SSH登陆到主机201的fanlychie用户的配置方式：</p>
<p>① 在主机202以root用户身份执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ssh-keygen -t rsa</span></div></pre></td></tr></table></figure>
<p>② 一路回车，生成的密钥文件在当前用户的目录的<code>.ssh</code>目录中。</p>
<p>③ 复制主机202用户目录下的id_rsa.pub文件到主机201的fanlychie用户目录下的<code>.ssh</code>目录中，并将文件重命名为authorized_keys：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ~/.ssh/ &amp;&amp; scp id_rsa.pub fanlychie@192.168.1.201:/home/fanlychie/.ssh/authorized_keys</span></div></pre></td></tr></table></figure>
<p>④ 验证SSH免密登陆，在主机202以root用户身份执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ssh fanlychie@192.168.1.201</span></div></pre></td></tr></table></figure>
<p>如果能顺利登陆主机201，说明配置成功。</p>
<p>⑤ 退出SSH登陆：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exit</span></span></div></pre></td></tr></table></figure>
<p>如果主机202需要远程登陆多台目标主机，如主机203，只需要从第3步开始配置即可。</p>
<h3 id="5-验证配置"><a href="#5-验证配置" class="headerlink" title="5. 验证配置"></a>5. 验证配置</h3><p>新建一个自由风格的软件项目，在<code>构建</code>项里面选择<code>增加构建后操作步骤</code>并选择<code>Execute shell script on remote host using ssh</code>：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-4.png" alt=""></p>
<p>在目标主机201中编写测试脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~ &amp;&amp; mkdir scripts &amp;&amp; vi scripts/hello.sh</span></div></pre></td></tr></table></figure>
<p>测试内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"> </div><div class="line">echo '========================================='</div><div class="line">echo 'Hello World!'</div><div class="line">echo '========================================='</div></pre></td></tr></table></figure>
<p>保存退出。并修改文件权限为可执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> chmod 764 scripts/hello.sh</span></div></pre></td></tr></table></figure>
<p>构建任务：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-5.png" alt=""></p>
<h3 id="6-环境变量"><a href="#6-环境变量" class="headerlink" title="6. 环境变量"></a>6. 环境变量</h3><p>上面这种远程SSH到目标主机属于<code>NoLogin</code>方式，无法获取 PATH 等环境变量。</p>
<p>Jenkins构建好项目之后，如果应用服务器跟Jenkins服务器不是同一台主机，那Jenkins就需要通过SSH远程将应用的部署包发布到目标主机。执行发布的过程，通常需要目标主机环境变量的支持。例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"> </div><div class="line">java -version</div></pre></td></tr></table></figure>
<p>构建结果：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-6.png" alt=""></p>
<p>实际上，java 环境变量是已经在服务器中配置好了的。但由于是<code>NoLogin</code>的方式登陆，无法获取 PATH 等环境变量导致。目前我的解决方法是在脚本中重新定义一次。如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"> </div><div class="line">JAVA_HOME=/usr/local/jdk1.8.0_144</div><div class="line">CLASSPATH=.:$JAVA_HOME/lib</div><div class="line">PATH=$PATH:$JAVA_HOME/bin</div><div class="line">export JAVA_HOME CLASSPATH PATH</div><div class="line"> </div><div class="line">java -version</div></pre></td></tr></table></figure>
<p>构建结果：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-7.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-安装插件&quot;&gt;&lt;a href=&quot;#1-安装插件&quot; class=&quot;headerlink&quot; title=&quot;1. 安装插件&quot;&gt;&lt;/a&gt;1. 安装插件&lt;/h3&gt;&lt;p&gt;系统管理 -&amp;gt; 管理插件 -&amp;gt; 可用插件，搜索：SSH Plugin&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins 为视图添加控制台按钮</title>
    <link href="http://yoursite.com/post/jenkins-console-icon.html"/>
    <id>http://yoursite.com/post/jenkins-console-icon.html</id>
    <published>2017-08-20T06:42:32.000Z</published>
    <updated>2017-11-05T05:54:18.655Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-安装插件"><a href="#1-安装插件" class="headerlink" title="1. 安装插件"></a>1. 安装插件</h3><p>系统管理 -&gt; 管理插件 -&gt; 可用插件，搜索：Console Column Plugin</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-1.png" alt=""></p>
<a id="more"></a>
<h3 id="2-编辑视图"><a href="#2-编辑视图" class="headerlink" title="2. 编辑视图"></a>2. 编辑视图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-2.png" alt=""></p>
<h3 id="3-添加列"><a href="#3-添加列" class="headerlink" title="3. 添加列"></a>3. 添加列</h3><p>视图的列顺序可以自由拖放改变，按照你自己的习惯摆放即可。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-3.png" alt=""></p>
<h3 id="4-效果图"><a href="#4-效果图" class="headerlink" title="4. 效果图"></a>4. 效果图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-4.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-安装插件&quot;&gt;&lt;a href=&quot;#1-安装插件&quot; class=&quot;headerlink&quot; title=&quot;1. 安装插件&quot;&gt;&lt;/a&gt;1. 安装插件&lt;/h3&gt;&lt;p&gt;系统管理 -&amp;gt; 管理插件 -&amp;gt; 可用插件，搜索：Console Column Plugin&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins 视图管理</title>
    <link href="http://yoursite.com/post/jenkins-view.html"/>
    <id>http://yoursite.com/post/jenkins-view.html</id>
    <published>2017-08-20T04:12:22.000Z</published>
    <updated>2017-11-05T05:19:12.131Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-添加视图"><a href="#1-添加视图" class="headerlink" title="1. 添加视图"></a>1. 添加视图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view.png" alt=""></p>
<a id="more"></a>
<h3 id="2-填写信息"><a href="#2-填写信息" class="headerlink" title="2. 填写信息"></a>2. 填写信息</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view-2.png" alt=""></p>
<h3 id="3-配置信息"><a href="#3-配置信息" class="headerlink" title="3. 配置信息"></a>3. 配置信息</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view-3.png" alt=""></p>
<h3 id="4-效果图"><a href="#4-效果图" class="headerlink" title="4. 效果图"></a>4. 效果图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view-4.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-添加视图&quot;&gt;&lt;a href=&quot;#1-添加视图&quot; class=&quot;headerlink&quot; title=&quot;1. 添加视图&quot;&gt;&lt;/a&gt;1. 添加视图&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>使用 Jenkins 进行持续集成</title>
    <link href="http://yoursite.com/post/jenkins-guide.html"/>
    <id>http://yoursite.com/post/jenkins-guide.html</id>
    <published>2017-08-19T14:52:52.000Z</published>
    <updated>2017-11-04T19:13:38.612Z</updated>
    
    <content type="html"><![CDATA[<p>Jenkins 的前身是 Hudson，它是基于 Java 开发的一种持续集成（Continuous Integration，简称 CI）开源工具。用于持续交付、自动构建、测试、发布和监控等，无需过多的人工干预，利于提高开发的效率。</p>
<a id="more"></a>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>到 <a href="https://jenkins.io/" target="_blank" rel="external">Jenkins</a> 官网下载安装包 <a href="https://pkg.jenkins.io/redhat-stable/jenkins-2.60.3-1.1.noarch.rpm" target="_blank" rel="external">jenkins-2.60.3-1.1.noarch.rpm</a>。Jenkins 2.54 或以上的版本需要 JDK 8 或以上的版本作为运行时环境。如果你系统环境的 JDK 版本低于 8，请选用低于 2.54 的 Jenkins 安装包。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> rpm -ivh jenkins-2.60.3-1.1.noarch.rpm</span></div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>目录</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/usr/lib/jenkins/</td>
<td>war 包目录</td>
</tr>
<tr>
<td>/var/lib/jenkins/</td>
<td>默认的 JENKINS_HOME 目录</td>
</tr>
<tr>
<td>/var/log/jenkins/</td>
<td>日志文件目录</td>
</tr>
<tr>
<td>/etc/sysconfig/jenkins</td>
<td>配置文件</td>
</tr>
</tbody>
</table>
<h4 id="1-1-JDK-配置"><a href="#1-1-JDK-配置" class="headerlink" title="1.1 JDK 配置"></a>1.1 JDK 配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/init.d/jenkins</span></div></pre></td></tr></table></figure>
<p>在 66 行附近找到 candidates 的配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">candidates="</div><div class="line">/etc/alternatives/java</div><div class="line">/usr/lib/jvm/java-1.8.0/bin/java</div><div class="line">/usr/lib/jvm/jre-1.8.0/bin/java</div><div class="line">/usr/lib/jvm/java-1.7.0/bin/java</div><div class="line">/usr/lib/jvm/jre-1.7.0/bin/java</div><div class="line">/usr/bin/java</div><div class="line">"</div></pre></td></tr></table></figure>
<p>将你机器的 JDK 安装目录下的 /bin/java 文件的路径添加到第一行，其余行也可以删掉：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">candidates="</div><div class="line">/usr/local/jdk1.8.0_144/bin/java</div><div class="line">"</div></pre></td></tr></table></figure>
<h4 id="1-2-端口配置（可选）："><a href="#1-2-端口配置（可选）：" class="headerlink" title="1.2 端口配置（可选）："></a>1.2 端口配置（可选）：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/jenkins</span></div></pre></td></tr></table></figure>
<p>在 56 行，默认端口是 8080，可自行修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JENKINS_PORT="8888"</div></pre></td></tr></table></figure>
<h4 id="1-3-用户配置"><a href="#1-3-用户配置" class="headerlink" title="1.3 用户配置"></a>1.3 用户配置</h4><p>Jenkins 安装时默认创建了一个名为 jenkins 的用户，为避免 Jenkins 运行时没有操作其他文件的权限，可修改为其他权限用户，比如 root：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/jenkins</span></div></pre></td></tr></table></figure>
<p>在 29 行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Type:        string</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Default:     "jenkins"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ServiceRestart: jenkins</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"> Unix user account that runs the Jenkins daemon</span></div><div class="line"><span class="meta">#</span><span class="bash"> Be careful when you change this, as you need to update</span></div><div class="line"><span class="meta">#</span><span class="bash"> permissions of <span class="variable">$JENKINS_HOME</span> and /var/<span class="built_in">log</span>/jenkins.</span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line">JENKINS_USER="root"</div></pre></td></tr></table></figure>
<h4 id="1-4-命令行"><a href="#1-4-命令行" class="headerlink" title="1.4 命令行"></a>1.4 命令行</h4><p>启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service jenkins start</div></pre></td></tr></table></figure>
<p>停止：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service jenkins stop</div></pre></td></tr></table></figure>
<p>重启：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service jenkins restart</div></pre></td></tr></table></figure>
<h4 id="1-5-启动应用"><a href="#1-5-启动应用" class="headerlink" title="1.5 启动应用"></a>1.5 启动应用</h4><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_1.png" alt=""></p>
<p>第一次使用 Jenkins 时，它会自动生成一个随机的口令。你需要输入正确的口令才能进入系统。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> cat /var/lib/jenkins/secrets/initialAdminPassword</span></div></pre></td></tr></table></figure>
<p>复制并粘贴口令进入到安装界面：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_2.png" alt=""></p>
<p>选择第一项<code>Install suggested plugins</code>，等待安装完成。待安装完成之后，创建管理员账户：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_3.png" alt=""></p>
<p>至此，安装完成。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_4.png" alt=""></p>
<h3 id="2-应用配置"><a href="#2-应用配置" class="headerlink" title="2. 应用配置"></a>2. 应用配置</h3><h4 id="2-1-JDK-配置"><a href="#2-1-JDK-配置" class="headerlink" title="2.1 JDK 配置"></a>2.1 JDK 配置</h4><p><code>系统管理 -&gt; Global Tool Configuration</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_5.png" alt=""></p>
<h4 id="2-2-Maven-配置"><a href="#2-2-Maven-配置" class="headerlink" title="2.2 Maven 配置"></a>2.2 Maven 配置</h4><p><code>系统管理 -&gt; Global Tool Configuration</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_7.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_6.png" alt=""></p>
<h4 id="2-3-SVN-账户配置"><a href="#2-3-SVN-账户配置" class="headerlink" title="2.3 SVN 账户配置"></a>2.3 SVN 账户配置</h4><p><code>Credentials -&gt; global -&gt; Add Credentials</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_8.png" alt=""></p>
<h4 id="2-4-GIT-账户配置"><a href="#2-4-GIT-账户配置" class="headerlink" title="2.4 GIT 账户配置"></a>2.4 GIT 账户配置</h4><p><code>Credentials -&gt; global -&gt; Add Credentials</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_9.png" alt=""></p>
<h4 id="2-5-Maven-集成插件"><a href="#2-5-Maven-集成插件" class="headerlink" title="2.5 Maven 集成插件"></a>2.5 Maven 集成插件</h4><p><code>系统管理 -&gt; 管理插件 -&gt; Maven Integration plugin</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_10.png" alt=""></p>
<h4 id="2-6-发布插件"><a href="#2-6-发布插件" class="headerlink" title="2.6 发布插件"></a>2.6 发布插件</h4><p><code>系统管理 -&gt; 管理插件 -&gt; Deploy to container Plugin</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_11.png" alt=""></p>
<h3 id="3-创建任务"><a href="#3-创建任务" class="headerlink" title="3. 创建任务"></a>3. 创建任务</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_12.png" alt=""></p>
<h3 id="4-任务配置"><a href="#4-任务配置" class="headerlink" title="4. 任务配置"></a>4. 任务配置</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_13.png" alt=""></p>
<p>附 Shell 脚本源码：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/bin/bash</span></div><div class="line"> </div><div class="line"><span class="comment"># 必须, 否则Tomcat无法启动</span></div><div class="line"><span class="string">export</span> <span class="string">BUILD_ID=anything</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用部署到的Tomcat的路径, 不同项目只需改变此参数即可</span></div><div class="line"><span class="string">app_tomcat_path=/home/fanlychie/application/helloworld-demo-tomcat</span></div><div class="line"> </div><div class="line"><span class="comment"># 工作区间</span></div><div class="line"><span class="string">workspace=$WORKSPACE</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用的名称</span></div><div class="line"><span class="string">app_final_name=$&#123;workspace##*/&#125;</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用Tomcat的名称, 用于查杀进程</span></div><div class="line"><span class="string">app_tomcat_name=$&#123;app_tomcat_path##*/&#125;</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用包备份的目录</span></div><div class="line"><span class="string">app_backup_path=$app_tomcat_path/backup</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用包备份的路径</span></div><div class="line"><span class="string">app_backup_pathname=$app_backup_path/`echo</span> <span class="string">| awk '&#123;print strftime("%Y-%m-%d-%H-%M-%S")&#125;'`</span></div><div class="line"> </div><div class="line"># 应用Tomcat的进程ID</div><div class="line">app_tomcat_process_id=`ps -ef | grep $app_tomcat_name | grep -v grep | awk '&#123;print $2&#125;'`</div><div class="line"> </div><div class="line"># 杀掉进程</div><div class="line">if [ $app_tomcat_process_id != "" ]; then</div><div class="line">    kill -9 $app_tomcat_process_id</div><div class="line">fi</div><div class="line"> </div><div class="line"># 创建备份目录</div><div class="line">if [ ! -d $app_backup_path ]; then</div><div class="line">    mkdir $app_backup_path</div><div class="line">fi</div><div class="line"> </div><div class="line"># 创建备份路径</div><div class="line">mkdir $app_backup_pathname</div><div class="line"> </div><div class="line"># 备份应用</div><div class="line">cp -r $app_tomcat_path/webapps/ROOT $app_backup_pathname</div><div class="line"> </div><div class="line"># 清空目录</div><div class="line">rm -rf $app_tomcat_path/webapps/ROOT/*</div><div class="line"> </div><div class="line"># 拷贝应用包</div><div class="line">cp -f $&#123;workspace&#125;/target/*.war $&#123;app_tomcat_path&#125;/webapps/ROOT</div><div class="line"> </div><div class="line"># 进入ROOT目录</div><div class="line">cd $&#123;app_tomcat_path&#125;/webapps/ROOT</div><div class="line"> </div><div class="line"># 解压缩应用包</div><div class="line">jar xvf *.war</div><div class="line"> </div><div class="line"># 删除应用包</div><div class="line">rm -f *.war</div><div class="line"> </div><div class="line"># 启动应用Tomcat服务</div><div class="line">$&#123;app_tomcat_path&#125;/bin/startup.sh</div></pre></td></tr></table></figure>
<h3 id="5-用户管理"><a href="#5-用户管理" class="headerlink" title="5. 用户管理"></a>5. 用户管理</h3><p><code>系统管理 -&gt; Configure Global Security</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_15.png" alt=""></p>
<p><code>系统管理 -&gt; 管理用户 -&gt; 新建用户</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_14.png" alt=""></p>
<p>用户新建完成后再到<code>系统管理 -&gt; Configure Global Security</code>添加用户并配置权限。</p>
<blockquote>
<p>环境：Java-8、Maven-3、Tomcat-8、Jenkins-2.60.3、Centos-6</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Jenkins 的前身是 Hudson，它是基于 Java 开发的一种持续集成（Continuous Integration，简称 CI）开源工具。用于持续交付、自动构建、测试、发布和监控等，无需过多的人工干预，利于提高开发的效率。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 集群容错</title>
    <link href="http://yoursite.com/post/dubbo-cluster-fault-tolerance.html"/>
    <id>http://yoursite.com/post/dubbo-cluster-fault-tolerance.html</id>
    <published>2017-07-29T10:18:21.000Z</published>
    <updated>2017-07-30T10:08:01.956Z</updated>
    
    <content type="html"><![CDATA[<p>在集群调用失败时，dubbo 提供了多种可选的容错方案：</p>
<p><code>failover</code>、<code>failfast</code>、<code>failsafe</code>、<code>failback</code>、<code>forking</code>、<code>broadcast</code></p>
<a id="more"></a>
<h3 id="1-failover"><a href="#1-failover" class="headerlink" title="1. failover"></a>1. failover</h3><p>失败自动切换，当出现失败，重试其它服务器。通常用于读操作，但重试会带来更长延迟。</p>
<p>在缺省配置的情况下，dubbo 采用此方案作为默认的集群容错模式（可以通过<code>cluster</code>参数设置），并默认失败重试2次（不含第一次）调用其他的服务器（可以通过<code>retries</code>参数设置）。直至重试次数用完或调用成功为止。失败一次消费者调用方就会抛一个异常，但只要有一次调用是成功的，结果就是成功的。除非全部调用都失败了，结果才是失败的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">retries</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">retries</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:method</span> <span class="attr">name</span>=<span class="string">"findFoo"</span> <span class="attr">retries</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dubbo:reference</span>&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(retries = <span class="number">2</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(retries = <span class="number">2</span>)</div></pre></td></tr></table></figure>
<h3 id="2-failfast"><a href="#2-failfast" class="headerlink" title="2. failfast"></a>2. failfast</h3><p>快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，比如新增记录。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"failfast"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failfast"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"failfast"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"failfast"</span>)</div></pre></td></tr></table></figure>
<h3 id="3-failsafe"><a href="#3-failsafe" class="headerlink" title="3. failsafe"></a>3. failsafe</h3><p>失败安全，出现异常时，直接忽略。通常用于写入审计日志等操作。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"failsafe"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failsafe"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"failsafe"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"failsafe"</span>)</div></pre></td></tr></table></figure>
<h3 id="4-failback"><a href="#4-failback" class="headerlink" title="4. failback"></a>4. failback</h3><p>失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"failback"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failback"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"failback"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"failback"</span>)</div></pre></td></tr></table></figure>
<h3 id="5-forking"><a href="#5-forking" class="headerlink" title="5. forking"></a>5. forking</h3><p>并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过<code>forks=&quot;2&quot;</code>来设置最大并行数。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"forking"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"forking"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"forking"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"forking"</span>)</div></pre></td></tr></table></figure>
<h3 id="6-broadcast"><a href="#6-broadcast" class="headerlink" title="6. broadcast"></a>6. broadcast</h3><p>广播调用所有提供者，逐个调用，任意一台报错则报错。（2.1.0开始支持）通常用于通知所有提供者更新缓存或日志等本地资源信息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"broadcast"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"broadcast"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"broadcast"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"broadcast"</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>参考文档文献链接：<a href="http://dubbo.io/user-guide/demos/集群容错.html" target="_blank" rel="external">dubbo集群容错</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在集群调用失败时，dubbo 提供了多种可选的容错方案：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;failover&lt;/code&gt;、&lt;code&gt;failfast&lt;/code&gt;、&lt;code&gt;failsafe&lt;/code&gt;、&lt;code&gt;failback&lt;/code&gt;、&lt;code&gt;forking&lt;/code&gt;、&lt;code&gt;broadcast&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 关闭启动时检查解决服务之间调用的问题</title>
    <link href="http://yoursite.com/post/resolve-dubbo-services-call-situation.html"/>
    <id>http://yoursite.com/post/resolve-dubbo-services-call-situation.html</id>
    <published>2017-07-28T07:26:57.000Z</published>
    <updated>2017-07-28T12:47:41.218Z</updated>
    
    <content type="html"><![CDATA[<p>dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线前，能及早发现问题，默认<code>check=&quot;true&quot;</code>。</p>
<p>如果你的 Spring 容器是懒加载的，或者通过 API 编程延迟引用服务，请关闭检查，否则服务临时不可用时会抛出异常，拿到 null 引用，如果<code>check=&quot;false&quot;</code>，总是会返回引用，当服务恢复时，能自动连上。</p>
<p>比如对一些不关心的服务，或者服务之间出现了相互依赖必须有一方先启动时，你可以关闭检查避免异常。</p>
<a id="more"></a>
<h3 id="1-场景描述"><a href="#1-场景描述" class="headerlink" title="1. 场景描述"></a>1. 场景描述</h3><p>假设现有两个已知的服务：用户中心服务、订单中心服务。它们作为服务提供者分别向 dubbo 注册了自己。用户中心服务中的<code>UserServiceImpl</code>调用了订单中心服务的<code>OrderServiceImpl</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByUserIdAndOrderStatus</span><span class="params">(Integer userId, String orderStatus)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPaidOrdersById</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        orderService.findByUserIdAndOrderStatus(id, <span class="string">"PAID"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-XML-配置方式"><a href="#2-XML-配置方式" class="headerlink" title="2. XML 配置方式"></a>2. XML 配置方式</h3><p>订单中心服务配置信息的代码片段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 声明 Bean --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"orderService"</span> <span class="attr">class</span>=<span class="string">"org.fanlychie.service.OrderServiceImpl"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.OrderService"</span> <span class="attr">ref</span>=<span class="string">"orderService"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>用户中心服务配置信息的代码片段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 声明引用的服务, check 设为 false 以关闭服务的启动时检查, 避免服务启动顺序引发的异常 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"orderService"</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.OrderService"</span> <span class="attr">check</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 声明 Bean --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"org.fanlychie.service.UserServiceImpl"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 声明依赖的服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"orderService"</span> <span class="attr">ref</span>=<span class="string">"orderService"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.UserService"</span> <span class="attr">ref</span>=<span class="string">"userService"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p><code>&lt;dubbo:reference&gt;</code>的 check 属性设为 false 以关闭服务的启动时检查，否则服务的启动顺序不当会直接导致服务启动不了。如<code>check=true</code>（默认）若先启动用户中心服务会报以下异常导致服务启动失败：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Failed to check the status of the service ...</div></pre></td></tr></table></figure>
<p>在用户心中调用订单中心的服务示例代码片段，相关的依赖需要通过 setter 方法注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPaidOrdersById</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        orderService.findByUserIdAndOrderStatus(id, <span class="string">"PAID"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderService</span><span class="params">(OrderService orderService)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.orderService = orderService;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-注解的方式"><a href="#3-注解的方式" class="headerlink" title="3. 注解的方式"></a>3. 注解的方式</h3><p>订单中心的服务接口使用<code>com.alibaba.dubbo.config.annotation.@Service</code>注解直接暴露服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</div><div class="line"> </div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByUserIdAndOrderStatus</span><span class="params">(Integer userId, String orderStatus)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用户中心的服务接口使用<code>com.alibaba.dubbo.config.annotation.@Service</code>注解暴露服务，并使用使用<code>com.alibaba.dubbo.config.annotation.@Reference</code>注解引用订单中心的接口服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</div><div class="line"> </div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Reference</span></div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPaidOrdersById</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        orderService.findByUserIdAndOrderStatus(id, <span class="string">"PAID"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>引用的服务的属性<code>check</code>应设为 false 以关闭服务的启动时检查，避免服务启动顺序引发的异常。使用注解<code>@Reference(check = false)</code>的方式是无效的，需要在调用方(本文为用户中心)的配置文件中添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 关闭引用服务的启动时检查 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:consumer</span> <span class="attr">check</span>=<span class="string">"false"</span> /&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>参考文档文献链接：<a href="http://dubbo.io/user-guide/demos/启动时检查.html" target="_blank" rel="external">启动时检查</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线前，能及早发现问题，默认&lt;code&gt;check=&amp;quot;true&amp;quot;&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;如果你的 Spring 容器是懒加载的，或者通过 API 编程延迟引用服务，请关闭检查，否则服务临时不可用时会抛出异常，拿到 null 引用，如果&lt;code&gt;check=&amp;quot;false&amp;quot;&lt;/code&gt;，总是会返回引用，当服务恢复时，能自动连上。&lt;/p&gt;
&lt;p&gt;比如对一些不关心的服务，或者服务之间出现了相互依赖必须有一方先启动时，你可以关闭检查避免异常。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 注解方式整合 springmvc</title>
    <link href="http://yoursite.com/post/dubbo-annotation-with-springmvc.html"/>
    <id>http://yoursite.com/post/dubbo-annotation-with-springmvc.html</id>
    <published>2017-07-27T17:54:38.000Z</published>
    <updated>2017-07-28T10:18:24.001Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1. 项目结构"></a>1. 项目结构</h3><p>创建一个 maven 多模块项目，结构如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dubbo-annotation-with-springmvc-sample（父模块）</div><div class="line">|</div><div class="line">|__ user-module-api（服务接口模块）</div><div class="line">|</div><div class="line">|__ user-module-provider（服务提供者）</div><div class="line">|</div><div class="line">|__ user-module-consumer（服务消费者）</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="1-1-父模块项目"><a href="#1-1-父模块项目" class="headerlink" title="1.1 父模块项目"></a>1.1 父模块项目</h4><p>dubbo-annotation-with-springmvc-sample/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Sample project for Dubbo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>4.3.7.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!-- dubbo依赖的spring版本（2.5）较低, 排除此依赖, 使用自己的spring版本 --&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="1-2-服务接口模块"><a href="#1-2-服务接口模块" class="headerlink" title="1.2 服务接口模块"></a>1.2 服务接口模块</h4><p>user-module-api/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>编写注册用户的示例服务接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line">    </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(String username, String password)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-3-服务提供者"><a href="#1-3-服务提供者" class="headerlink" title="1.3 服务提供者"></a>1.3 服务提供者</h4><p>user-module-provider/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 打包配置, 输出可执行的 jar 包 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.alibaba.dubbo.container.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">appendAssemblyId</span>&gt;</span>false<span class="tag">&lt;/<span class="name">appendAssemblyId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>实现服务接口，使用<code>com.alibaba.dubbo.config.annotation.@Service</code>注解暴露服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line">    </div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</div><div class="line">    </div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">        System.out.println(String.format(<span class="string">"接收到注册用户请求 - &#123;username:%s, password:%s&#125;"</span>,</div><div class="line">                username, password));</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/dubbo.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dubbo.spring.config=classpath:spring-dubbo-provider.xml</div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/spring-dubbo-provider.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-provider"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 使用ZK注册中心暴露服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 用Dubbo协议在20880端口暴露服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 扫描注解包路径，多个包用逗号分隔 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">"org.fanlychie.service"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/log4j.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory = INFO, console</div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.target = System.out</div><div class="line">log4j.appender.console.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.conversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss:SSS&#125; [%t] %-<span class="number">5</span>p [%c&#123;<span class="number">1</span>&#125;:%L] - %m%n</div></pre></td></tr></table></figure>
<h4 id="1-4-服务消费者"><a href="#1-4-服务消费者" class="headerlink" title="1.4 服务消费者"></a>1.4 服务消费者</h4><p>user-module-consumer/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>autosellrobot-wechat<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/manager/html<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>服务消费者使用<code>com.alibaba.dubbo.config.annotation.@Reference</code>注解引用接口服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</div><div class="line"><span class="keyword">import</span> org.fanlychie.service.UserService;</div><div class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</div><div class="line">    </div><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Reference</span></div><div class="line">    <span class="keyword">private</span> UserService userService;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/register"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!StringUtils.hasText(username) || !StringUtils.hasText(password)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"用户名或密码不能为空"</span>;</div><div class="line">        &#125;</div><div class="line">        userService.register(username, password);</div><div class="line">        <span class="keyword">return</span> <span class="string">"注册完成"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/webapp/WEB-INF/web.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"2.5"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.request.RequestContextListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/log4j.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory = INFO, console</div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.target = System.out</div><div class="line">log4j.appender.console.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.conversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss:SSS&#125; [%t] %-<span class="number">5</span>p [%c&#123;<span class="number">1</span>&#125;:%L] - %m%n</div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/spring-context.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.fanlychie"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/spring-mvc.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-consumer"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 使用ZK注册中心暴露服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 扫描注解包路径，多个包用逗号分隔 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">"org.fanlychie.controller"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useSuffixPatternMatch"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useTrailingSlashMatch"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"stringHttpMessageConverter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.StringHttpMessageConverter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/xml;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mappingJackson2HttpMessageConverter"</span></span></div><div class="line">          <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefixJson"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/xml;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageConverters"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"stringHttpMessageConverter"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"mappingJackson2HttpMessageConverter"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.fanlychie.**.controller"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>服务消费者方 dubbo 注解扫描配置的信息不能独立出 springmvc 配置文件，否则<code>@Reference</code>注解引用的接口实例会出现 Null 的状况。</p>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring-4.7、Dubbo-2.5.3<br>完整示例项目链接：<a href="https://github.com/fanlychie/dubbo-samples/tree/master/dubbo-annotation-with-springmvc-sample" target="_blank" rel="external">dubbo-annotation-with-springmvc-sample</a><br>参考文档文献链接：<a href="http://dubbo.io/user-guide/" target="_blank" rel="external">dubbo用户指南</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-项目结构&quot;&gt;&lt;a href=&quot;#1-项目结构&quot; class=&quot;headerlink&quot; title=&quot;1. 项目结构&quot;&gt;&lt;/a&gt;1. 项目结构&lt;/h3&gt;&lt;p&gt;创建一个 maven 多模块项目，结构如下：&lt;/p&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;dubbo-annotation-with-springmvc-sample（父模块）&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|__ user-module-api（服务接口模块）&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|__ user-module-provider（服务提供者）&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|__ user-module-consumer（服务消费者）&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
</feed>
